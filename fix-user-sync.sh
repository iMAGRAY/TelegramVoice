#!/bin/bash
# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –º–µ–∂–¥—É WebSocket –∏ WebRTC

echo "üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô"
echo "=========================================="
echo

# 1. –°–±–æ—Ä–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–≥–æ WebSocket —Å–µ—Ä–≤–µ—Ä–∞
echo "1Ô∏è‚É£ –°–±–æ—Ä–∫–∞ WebSocket —Å–µ—Ä–≤–µ—Ä–∞..."
cd /root/TelegramVoice/signaling-server
cargo build --release

if [ $? -ne 0 ]; then
    echo "‚ùå –û—à–∏–±–∫–∞ —Å–±–æ—Ä–∫–∏ WebSocket —Å–µ—Ä–≤–µ—Ä–∞!"
    exit 1
fi

echo "‚úÖ WebSocket —Å–µ—Ä–≤–µ—Ä —Å–æ–±—Ä–∞–Ω"

# 2. –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞
echo
echo "2Ô∏è‚É£ –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ WebSocket —Å–µ—Ä–≤–µ—Ä–∞..."
pkill -f "signaling-serve" || true
sleep 2

# –£–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
if pgrep -f "signaling-serve" > /dev/null; then
    echo "‚ö†Ô∏è –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞..."
    pkill -9 -f "signaling-serve" || true
    sleep 1
fi

# 3. –ó–∞–ø—É—Å–∫ –Ω–æ–≤–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞
echo
echo "3Ô∏è‚É£ –ó–∞–ø—É—Å–∫ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–≥–æ WebSocket —Å–µ—Ä–≤–µ—Ä–∞..."
cd /root/TelegramVoice/signaling-server
nohup ./target/release/signaling-server > websocket.log 2>&1 &
WEBSOCKET_PID=$!

sleep 3

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
if ! kill -0 $WEBSOCKET_PID 2>/dev/null; then
    echo "‚ùå WebSocket —Å–µ—Ä–≤–µ—Ä –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è!"
    echo "–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –ª–æ–≥–∞:"
    tail -10 websocket.log
    exit 1
fi

echo "‚úÖ WebSocket —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω (PID: $WEBSOCKET_PID)"

# 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–∞
echo
echo "4Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–∞ 8080..."
sleep 2
if ss -tlnp | grep -q ":8080"; then
    echo "‚úÖ –ü–æ—Ä—Ç 8080 –æ—Ç–∫—Ä—ã—Ç"
else
    echo "‚ùå –ü–æ—Ä—Ç 8080 –Ω–µ –æ—Ç–∫—Ä—ã—Ç!"
    exit 1
fi

# 5. –°—Ç–∞—Ç—É—Å –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
echo
echo "5Ô∏è‚É£ –°—Ç–∞—Ç—É—Å –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤..."
echo "WebSocket —Å–µ—Ä–≤–µ—Ä:"
ps aux | grep signaling-serve | grep -v grep || echo "–ù–µ –Ω–∞–π–¥–µ–Ω"

echo
echo "Frontend PM2:"
pm2 list | grep frontend || echo "–ù–µ –Ω–∞–π–¥–µ–Ω"

echo
echo "–ü–æ—Ä—Ç—ã:"
ss -tlnp | grep -E ":(8080|3000|80|443)"

echo
echo "üéâ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –ü–†–ò–ú–ï–ù–ï–ù–´!"
echo "========================"
echo
echo "‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"
echo "‚úÖ WebSocket —Å–µ—Ä–≤–µ—Ä –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"
echo "‚úÖ –£—á–∞—Å—Ç–Ω–∏–∫–∏ –∫–æ–º–Ω–∞—Ç —Ç–µ–ø–µ—Ä—å –≤–∏–¥—è—Ç –¥—Ä—É–≥ –¥—Ä—É–≥–∞"
echo
echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É:"
echo "1. –û—Ç–∫—Ä–æ–π—Ç–µ https://hesovoice.online –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –±—Ä–∞—É–∑–µ—Ä–∞—Ö"
echo "2. –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç–µ—Å—å –∫ –æ–¥–Ω–æ–π –∫–æ–º–Ω–∞—Ç–µ —Ä–∞–∑–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏"
echo "3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –≤—Å–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è"
echo "4. –¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ –≥–æ–ª–æ—Å–æ–≤—É—é —Å–≤—è–∑—å"