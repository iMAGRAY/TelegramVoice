name: Pull Request Checks

on:
  pull_request:
    branches: [ main ]

jobs:
  # Проверка качества кода
  code-quality:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout кода
      uses: actions/checkout@v4
    
    - name: Установка Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: mini-app/package-lock.json
    
    - name: Установка Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        override: true
        components: rustfmt, clippy
    
    - name: Установка зависимостей фронтенда
      run: |
        cd mini-app
        npm ci
    
    - name: Линтинг фронтенда
      run: |
        cd mini-app
        npm run lint
    
    - name: Форматирование Rust кода
      run: |
        cd signaling-server
        cargo fmt --check
    
    - name: Clippy проверки
      run: |
        cd signaling-server
        cargo clippy -- -D warnings
    
    - name: Проверка сборки фронтенда
      run: |
        cd mini-app
        npm run build
    
    - name: Проверка сборки backend
      run: |
        cd signaling-server
        cargo build --release

  # Проверка безопасности
  security-audit:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout кода
      uses: actions/checkout@v4
    
    - name: Установка Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Установка Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        override: true
    
    - name: Аудит npm пакетов
      run: |
        cd mini-app
        npm audit --audit-level=moderate
    
    - name: Аудит Rust зависимостей
      uses: actions-rs/audit-check@v1
      with:
        token: ${{ secrets.GITHUB_TOKEN }}