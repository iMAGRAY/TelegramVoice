name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–±–æ—Ä–∫–∏
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout –∫–æ–¥–∞
      uses: actions/checkout@v4
    
    - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: mini-app/package-lock.json
    
    - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        override: true
    
    - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
      run: |
        cd mini-app
        npm ci
    
    - name: –°–±–æ—Ä–∫–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
      run: |
        cd mini-app
        npm run build
    
    - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ Rust –∫–æ–¥–∞
      run: |
        cd signaling-server
        cargo check
    
    - name: –°–±–æ—Ä–∫–∞ Rust –ø—Ä–æ–µ–∫—Ç–∞
      run: |
        cd signaling-server
        cargo build --release

  # –¢–æ–ª—å–∫–æ —Å–±–æ—Ä–∫–∞ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (—Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω–æ)
  notify:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é
      run: |
        echo "‚úÖ –°–±–æ—Ä–∫–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ!"
        echo "üöÄ –ì–æ—Ç–æ–≤–æ –∫ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ"
        echo "üìã –î–ª—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –ª–æ–∫–∞–ª—å–Ω–æ: ./auto-deploy.sh"