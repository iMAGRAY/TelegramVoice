name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  # 1) –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Test frontend build
        working-directory: mini-app
        run: |
          npm install
          npm run build
          echo "‚úÖ Frontend —Å–±–æ—Ä–∫–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ"

      - name: Test WebSocket server build
        working-directory: websocket-server
        run: |
          npm install
          npm run build
          echo "‚úÖ WebSocket —Å–µ—Ä–≤–µ—Ä —Å–±–æ—Ä–∫–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ"

  # 2) –ë–∏–ª–¥ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ –∏ WebSocket —Å–µ—Ä–≤–µ—Ä–∞ + upload artifacts
  build:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # --- Frontend build (static export) ---
      - name: Setup Node.js for Frontend
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install frontend dependencies
        working-directory: mini-app
        run: npm install

      - name: Build and export frontend
        working-directory: mini-app
        run: |
          npm run build
          # –†–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã—Ö–æ–¥–∏—Ç –≤ –ø–∞–ø–∫—É mini-app/out

      - name: Upload frontend artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-static
          path: mini-app/out

      # --- WebSocket Server build ---
      - name: Setup Node.js for WebSocket Server
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install WebSocket server dependencies
        working-directory: websocket-server
        run: npm install

      - name: Build WebSocket server
        working-directory: websocket-server
        run: npm run build

      - name: Upload WebSocket server artifact
        uses: actions/upload-artifact@v4
        with:
          name: websocket-server
          path: websocket-server/

      - name: Upload project config files
        uses: actions/upload-artifact@v4
        with:
          name: project-config
          path: |
            ecosystem.config.js
            deploy.sh
            monitor.sh

  # 3) –î–µ–ø–ª–æ–π –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
  deploy:
    needs: [test, build]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    steps:
      - name: Download frontend artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-static
          path: frontend-out

      - name: Download WebSocket server artifact
        uses: actions/download-artifact@v4
        with:
          name: websocket-server
          path: websocket-server

      - name: Download project config files
        uses: actions/download-artifact@v4
        with:
          name: project-config
          path: project-config

      - name: Copy frontend to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          source: "frontend-out/*"
          target: "${{ secrets.SERVER_PROJECT_PATH || '/root/TelegramVoice' }}/mini-app/out/"
          strip_components: 1
          overwrite: true

      - name: Copy WebSocket server to server  
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          source: "websocket-server/*"
          target: "${{ secrets.SERVER_PROJECT_PATH || '/root/TelegramVoice' }}/websocket-server/"
          strip_components: 1
          overwrite: true

      - name: Copy project config files
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          source: "project-config/*"
          target: "${{ secrets.SERVER_PROJECT_PATH || '/root/TelegramVoice' }}/"
          strip_components: 1
          overwrite: true

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ..."
            
            # –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
            echo "üìÅ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞:"
            ls -la ${{ secrets.SERVER_PROJECT_PATH || '/root/TelegramVoice' }}/
            
            # –°–æ–∑–¥–∞–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
            mkdir -p ${{ secrets.SERVER_PROJECT_PATH || '/root/TelegramVoice' }}/mini-app/out
            mkdir -p ${{ secrets.SERVER_PROJECT_PATH || '/root/TelegramVoice' }}/websocket-server/dist
            mkdir -p ${{ secrets.SERVER_PROJECT_PATH || '/root/TelegramVoice' }}/logs
            
            echo "üìÅ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ websocket-server:"
            ls -la ${{ secrets.SERVER_PROJECT_PATH || '/root/TelegramVoice' }}/websocket-server/
            
            # –û—Å—Ç–∞–Ω–æ–≤–∏–º —Å—Ç–∞—Ä—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
            echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤..."
            pm2 stop all || true
            pm2 delete all || true
            
            # –£–±–∏–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–∞ –ø–æ—Ä—Ç–∞—Ö 8080 –∏ 3000
            echo "üî™ –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –ø–æ—Ä—Ç–æ–≤..."
            fuser -k 8080/tcp || true
            fuser -k 3000/tcp || true
            
            # –ñ–¥–µ–º –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è –ø–æ—Ä—Ç–æ–≤
            sleep 3
            
            # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
            cd ${{ secrets.SERVER_PROJECT_PATH || '/root/TelegramVoice' }}
            
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ WebSocket —Å–µ—Ä–≤–µ—Ä–∞
            cd websocket-server
            if [ -f "package.json" ]; then
              echo "üì¶ –ù–∞–π–¥–µ–Ω package.json, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
              npm install --only=production
              echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ WebSocket —Å–µ—Ä–≤–µ—Ä–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
            else
              echo "‚ùå package.json –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ websocket-server"
              echo "üìÅ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏:"
              ls -la
              echo "üìÅ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏:"
              ls -la ..
              exit 1
            fi
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Å–æ–±—Ä–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
            if [ -d "dist" ]; then
              echo "‚úÖ –ü–∞–ø–∫–∞ dist –Ω–∞–π–¥–µ–Ω–∞"
              ls -la dist/
            else
              echo "‚ùå –ü–∞–ø–∫–∞ dist –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
              exit 1
            fi
            
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞
            cd ..
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ ecosystem.config.js
            if [ ! -f "ecosystem.config.js" ]; then
              echo "üìù –°–æ–∑–¥–∞–µ–º ecosystem.config.js..."
              cat > ecosystem.config.js << 'EOF'
            module.exports = {
              apps: [
                {
                  name: 'websocket-server',
                  script: 'node',
                  args: 'dist/index.js',
                  cwd: '${{ secrets.SERVER_PROJECT_PATH || '/root/TelegramVoice' }}/websocket-server',
                  env: {
                    NODE_ENV: 'production',
                    PORT: 8080
                  },
                  error_file: '${{ secrets.SERVER_PROJECT_PATH || '/root/TelegramVoice' }}/logs/websocket-server-error.log',
                  out_file: '${{ secrets.SERVER_PROJECT_PATH || '/root/TelegramVoice' }}/logs/websocket-server-out.log',
                  log_file: '${{ secrets.SERVER_PROJECT_PATH || '/root/TelegramVoice' }}/logs/websocket-server-combined.log',
                  time: true,
                  instances: 1,
                  exec_mode: 'fork',
                  autorestart: true,
                  max_restarts: 3,
                  min_uptime: '10s',
                  restart_delay: 5000
                },
                {
                  name: 'frontend',
                  script: 'serve',
                  args: '-s out -l 3000',
                  cwd: '${{ secrets.SERVER_PROJECT_PATH || '/root/TelegramVoice' }}/mini-app',
                  env: {
                    NODE_ENV: 'production'
                  },
                  error_file: '${{ secrets.SERVER_PROJECT_PATH || '/root/TelegramVoice' }}/logs/frontend-error.log',
                  out_file: '${{ secrets.SERVER_PROJECT_PATH || '/root/TelegramVoice' }}/logs/frontend-out.log',
                  log_file: '${{ secrets.SERVER_PROJECT_PATH || '/root/TelegramVoice' }}/logs/frontend-combined.log',
                  time: true,
                  instances: 1,
                  exec_mode: 'fork',
                  autorestart: true,
                  max_restarts: 3,
                  min_uptime: '10s',
                  restart_delay: 5000
                }
              ]
            };
            EOF
            fi
            
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º serve –≥–ª–æ–±–∞–ª—å–Ω–æ –µ—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
            if ! command -v serve &> /dev/null; then
              echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º serve..."
              npm install -g serve
            fi
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–æ–≤ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º
            echo "üîç –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤:"
            echo "Frontend out –ø–∞–ø–∫–∞:"
            ls -la mini-app/out/ | head -5
            echo "WebSocket server dist –ø–∞–ø–∫–∞:"
            ls -la websocket-server/dist/
            
            # –§–∏–Ω–∞–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ PM2
            echo "üßπ –§–∏–Ω–∞–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ PM2..."
            pm2 kill || true
            sleep 2
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø–æ—Ä—Ç—ã —Å–≤–æ–±–æ–¥–Ω—ã
            echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–æ–≤ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º..."
            if netstat -tlnp | grep :8080; then
              echo "‚ö†Ô∏è –ü–æ—Ä—Ç 8080 –≤—Å–µ –µ—â–µ –∑–∞–Ω—è—Ç, –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ–º..."
              fuser -k 8080/tcp || true
              sleep 2
            fi
            
            if netstat -tlnp | grep :3000; then
              echo "‚ö†Ô∏è –ü–æ—Ä—Ç 3000 –≤—Å–µ –µ—â–µ –∑–∞–Ω—è—Ç, –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ–º..."
              fuser -k 3000/tcp || true
              sleep 2
            fi
            
            # –ó–∞–ø—É—Å–∫–∞–µ–º —á–µ—Ä–µ–∑ PM2
            echo "üöÄ –ó–∞–ø—É—Å–∫ PM2 –ø—Ä–æ—Ü–µ—Å—Å–æ–≤..."
            pm2 start ecosystem.config.js
            pm2 save
            
            # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤
            echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤..."
            sleep 15
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
            echo "üìä –°—Ç–∞—Ç—É—Å PM2 –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞:"
            pm2 status
            
            echo "‚úÖ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ"

      - name: Post-deploy monitoring
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤..."
            
            # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤
            sleep 10
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º PM2 –ø—Ä–æ—Ü–µ—Å—Å—ã
            echo "üìä –°—Ç–∞—Ç—É—Å PM2:"
            pm2 status
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º WebSocket —Å–µ—Ä–≤–µ—Ä
            echo "üîå –ü—Ä–æ–≤–µ—Ä–∫–∞ WebSocket —Å–µ—Ä–≤–µ—Ä–∞..."
            if timeout 10 bash -c "cat < /dev/tcp/localhost/8080" &>/dev/null; then
              echo "‚úÖ WebSocket —Å–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 8080"
            else
              echo "‚ùå WebSocket —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 8080"
              echo "üìù –õ–æ–≥–∏ WebSocket —Å–µ—Ä–≤–µ—Ä–∞:"
              pm2 logs websocket-server --lines 20 --nostream
              echo "üìù –û—à–∏–±–∫–∏ WebSocket —Å–µ—Ä–≤–µ—Ä–∞:"
              if [ -f "logs/websocket-server-error.log" ]; then
                tail -20 logs/websocket-server-error.log
              fi
              echo "üìä –°—Ç–∞—Ç—É—Å –ø—Ä–æ—Ü–µ—Å—Å–∞:"
              pm2 describe websocket-server
              exit 1
            fi
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º HTTP —Å–µ—Ä–≤–µ—Ä
            echo "üåê –ü—Ä–æ–≤–µ—Ä–∫–∞ HTTP —Å–µ—Ä–≤–µ—Ä–∞..."
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 http://localhost:3000 || echo "000")
            if [[ "$HTTP_CODE" == "200" || "$HTTP_CODE" == "404" ]]; then
              echo "‚úÖ HTTP —Å–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 3000 (–∫–æ–¥ $HTTP_CODE)"
            else
              echo "‚ùå HTTP —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 3000 (–∫–æ–¥ $HTTP_CODE)"
              echo "üìù –õ–æ–≥–∏ Frontend —Å–µ—Ä–≤–µ—Ä–∞:"
              pm2 logs frontend --lines 20 --nostream
              echo "üìù –û—à–∏–±–∫–∏ Frontend —Å–µ—Ä–≤–µ—Ä–∞:"
              if [ -f "logs/frontend-error.log" ]; then
                tail -20 logs/frontend-error.log
              fi
              echo "üìä –°—Ç–∞—Ç—É—Å –ø—Ä–æ—Ü–µ—Å—Å–∞:"
              pm2 describe frontend
              exit 1
            fi
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–Ω–µ—à–Ω—é—é –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å
            echo "üåç –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–Ω–µ—à–Ω–µ–π –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏..."
            EXTERNAL_HTTP=$(curl -s -o /dev/null -w "%{http_code}" --max-time 15 http://${{ secrets.SERVER_HOST }}:3000 || echo "000")
            if [[ "$EXTERNAL_HTTP" == "200" || "$EXTERNAL_HTTP" == "404" ]]; then
              echo "‚úÖ –í–Ω–µ—à–Ω–∏–π –¥–æ—Å—Ç—É–ø —Ä–∞–±–æ—Ç–∞–µ—Ç (–∫–æ–¥ $EXTERNAL_HTTP)"
            else
              echo "‚ö†Ô∏è –í–Ω–µ—à–Ω–∏–π –¥–æ—Å—Ç—É–ø –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω (–∫–æ–¥ $EXTERNAL_HTTP)"
            fi
            
            echo ""
            echo "üéâ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
            echo "üìä –î–æ—Å—Ç—É–ø–Ω—ã–µ URL:"
            echo "   ‚Ä¢ HTTP: http://${{ secrets.SERVER_HOST }}:3000"
            echo "   ‚Ä¢ WebSocket: ws://${{ secrets.SERVER_HOST }}:8080"