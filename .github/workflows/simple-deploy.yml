name: Simple Deploy

on:
  workflow_dispatch:  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || (github.ref == 'refs/heads/main' && github.event_name == 'push')
    
    steps:
    - name: Deploy to server via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          cd ${{ secrets.SERVER_PROJECT_PATH || '/root/TelegramVoice' }}
          
          # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
          pm2 stop all || true
          
          # –°–±—Ä–æ—Å git —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
          git reset --hard HEAD
          git clean -fd
          git pull origin main
          
          # –°–±–æ—Ä–∫–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
          cd mini-app
          npm install
          npm run build
          
          # –°–±–æ—Ä–∫–∞ Rust backend (–µ—Å–ª–∏ –µ—Å—Ç—å cargo)
          cd ../signaling-server
          if command -v cargo &> /dev/null; then
            cargo build --release
          else
            echo "‚ö†Ô∏è Cargo –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–±–æ—Ä–∫—É Rust"
          fi
          
          # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Nginx (–µ—Å–ª–∏ –µ—â–µ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω)
          cd ..
          if [ ! -f /etc/nginx/sites-enabled/telegramvoice ]; then
            echo "üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Nginx..."
            chmod +x setup-nginx.sh
            ./setup-nginx.sh
          else
            echo "‚úÖ Nginx —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
          fi
          
          # –ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ PM2
          pm2 start ecosystem.config.js || pm2 restart ecosystem.config.js
          pm2 save
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
          pm2 status
          echo "‚úÖ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ"