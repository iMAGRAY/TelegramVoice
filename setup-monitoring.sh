#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç cron –∑–∞–¥–∞—á–∏ –¥–ª—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–∏—Å—Ç–µ–º—ã

echo "üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞..."

# –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è –ª–æ–≥–æ–≤ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
mkdir -p /root/TelegramVoice/logs/monitoring

# –°–æ–∑–¥–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ –¥–ª—è cron
cat > /root/TelegramVoice/cron-monitor.sh << 'EOF'
#!/bin/bash

# Cron —Å–∫—Ä–∏–ø—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
cd /root/TelegramVoice

# –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
STATUS=$(./notify-status.sh quick)
TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')

# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
echo "[$TIMESTAMP] $STATUS" >> logs/monitoring/status.log

# –ï—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã - –¥–µ—Ç–∞–ª—å–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
if echo "$STATUS" | grep -q "üî¥\|üü°"; then
    echo "[$TIMESTAMP] –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã, –∑–∞–ø—É—Å–∫ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞..." >> logs/monitoring/status.log
    ./monitor.sh >> logs/monitoring/detailed-$(date +%Y%m%d).log 2>&1
fi

# –†–æ—Ç–∞—Ü–∏—è –ª–æ–≥–æ–≤ (–æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π)
find logs/monitoring/ -name "detailed-*.log" -mtime +7 -delete
EOF

chmod +x /root/TelegramVoice/cron-monitor.sh

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ cron –∑–∞–¥–∞—á
echo "‚è∞ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ cron –∑–∞–¥–∞—á..."

# –°–æ–∑–¥–∞–Ω–∏–µ crontab entries
CRON_ENTRIES="
# TelegramVoice –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
# –ö–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç - –±—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
*/5 * * * * /root/TelegramVoice/cron-monitor.sh

# –ö–∞–∂–¥—ã–π —á–∞—Å - –¥–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç
0 * * * * cd /root/TelegramVoice && ./notify-status.sh full >> logs/monitoring/hourly.log 2>&1

# –ï–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 6:00 - –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤ PM2
0 6 * * * pm2 flush

# –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ –≤ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ –≤ 3:00 - –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤ –¥–ª—è –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∏  
0 3 * * 0 cd /root/TelegramVoice && pm2 restart all && ./monitor.sh >> logs/monitoring/weekly-restart.log 2>&1
"

# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ crontab
(crontab -l 2>/dev/null; echo "$CRON_ENTRIES") | crontab -

echo "‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!"
echo ""
echo "üìã –ù–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏:"
echo "   ‚Ä¢ –ö–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç: –±—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞"
echo "   ‚Ä¢ –ö–∞–∂–¥—ã–π —á–∞—Å: –¥–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç"
echo "   ‚Ä¢ –ï–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 6:00: –æ—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤ PM2"
echo "   ‚Ä¢ –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ: –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫"
echo ""
echo "üìä –õ–æ–≥–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:"
echo "   ‚Ä¢ –°—Ç–∞—Ç—É—Å: logs/monitoring/status.log"
echo "   ‚Ä¢ –ß–∞—Å–æ–≤—ã–µ –æ—Ç—á–µ—Ç—ã: logs/monitoring/hourly.log"  
echo "   ‚Ä¢ –î–µ—Ç–∞–ª—å–Ω—ã–µ –ª–æ–≥–∏: logs/monitoring/detailed-YYYYMMDD.log"
echo ""
echo "üîç –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:"
echo "   ./monitor.sh          - —Ä—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞"
echo "   ./notify-status.sh    - –æ—Ç—á–µ—Ç –æ —Å—Ç–∞—Ç—É—Å–µ"
echo "   crontab -l           - –ø—Ä–æ—Å–º–æ—Ç—Ä cron –∑–∞–¥–∞—á"
echo "   tail -f logs/monitoring/status.log - –∂–∏–≤–æ–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥"