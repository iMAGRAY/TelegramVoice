#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã —Å WebSocket —Å–µ—Ä–≤–µ—Ä–æ–º

set -e

echo "üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å WebSocket —Å–µ—Ä–≤–µ—Ä–æ–º..."
echo

# 1. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã..."
pm2 delete all 2>/dev/null || true

# 2. –£–±–∏–≤–∞–µ–º –∑–∞–≤–∏—Å—à–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–∞ –ø–æ—Ä—Ç–∞—Ö
echo "üî´ –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø–æ—Ä—Ç—ã..."
# –£–±–∏–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–∞ –ø–æ—Ä—Ç—É 8080
lsof -ti:8080 | xargs kill -9 2>/dev/null || true
# –£–±–∏–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–∞ –ø–æ—Ä—Ç—É 3000
lsof -ti:3000 | xargs kill -9 2>/dev/null || true

# 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –±–∏–Ω–∞—Ä–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
echo "üì¶ –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∏–Ω–∞—Ä–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ signaling-server..."
if [ ! -f "/root/TelegramVoice/signaling-server/target/release/signaling-server" ]; then
    echo "‚ùå –ë–∏–Ω–∞—Ä–Ω—ã–π —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–±–∏—Ä–∞–µ–º..."
    cd /root/TelegramVoice/signaling-server
    cargo build --release
else
    echo "‚úÖ –ë–∏–Ω–∞—Ä–Ω—ã–π —Ñ–∞–π–ª –Ω–∞–π–¥–µ–Ω"
fi

# 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
echo "üîê –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è..."
chmod +x /root/TelegramVoice/signaling-server/target/release/signaling-server

# 5. –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤
echo "üìÑ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤..."
if [ ! -d "/root/TelegramVoice/mini-app/out" ]; then
    echo "‚ùå –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, —Å–æ–±–∏—Ä–∞–µ–º..."
    cd /root/TelegramVoice/mini-app
    npm install
    npm run build
else
    echo "‚úÖ –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã –Ω–∞–π–¥–µ–Ω—ã"
fi

# 6. –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É serve
echo "üî® –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ serve..."
if ! command -v serve &> /dev/null; then
    echo "‚ùå serve –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º..."
    npm install -g serve
else
    echo "‚úÖ serve —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
fi

# 7. –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã —á–µ—Ä–µ–∑ PM2
echo "üöÄ –ó–∞–ø—É—Å–∫ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ —á–µ—Ä–µ–∑ PM2..."
cd /root/TelegramVoice
pm2 start ecosystem.config.js

# 8. –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞
echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ (10 —Å–µ–∫—É–Ω–¥)..."
sleep 10

# 9. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
echo "üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤..."
pm2 status

# 10. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Ä—Ç—ã
echo "üåê –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–æ–≤..."
if lsof -i:8080 >/dev/null 2>&1; then
    echo "‚úÖ –ü–æ—Ä—Ç 8080 (WebSocket) –∞–∫—Ç–∏–≤–µ–Ω"
    lsof -i:8080 | grep LISTEN
else
    echo "‚ùå –ü–æ—Ä—Ç 8080 (WebSocket) –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
    echo "üìã –õ–æ–≥–∏ signaling-server:"
    pm2 logs signaling-server --lines 30 --nostream
fi

if lsof -i:3000 >/dev/null 2>&1; then
    echo "‚úÖ –ü–æ—Ä—Ç 3000 (HTTP) –∞–∫—Ç–∏–≤–µ–Ω"
else
    echo "‚ùå –ü–æ—Ä—Ç 3000 (HTTP) –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
    echo "üìã –õ–æ–≥–∏ frontend:"
    pm2 logs frontend --lines 30 --nostream
fi

# 11. –¢–µ—Å—Ç WebSocket
echo
echo "üß™ –¢–µ—Å—Ç WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è..."
if timeout 5 bash -c "cat < /dev/tcp/localhost/8080" &>/dev/null; then
    echo "‚úÖ WebSocket —Å–µ—Ä–≤–µ—Ä –æ—Ç–≤–µ—á–∞–µ—Ç"
else
    echo "‚ùå WebSocket —Å–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"
    
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
    echo
    echo "üîç –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞..."
    echo "–ü—Ä–æ—Ü–µ—Å—Å—ã signaling-server:"
    ps aux | grep signaling-server | grep -v grep || echo "–ü—Ä–æ—Ü–µ—Å—Å –Ω–µ –Ω–∞–π–¥–µ–Ω"
    
    echo
    echo "–°–µ—Ç–µ–≤—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:"
    netstat -tlnp | grep 8080 || echo "–ü–æ—Ä—Ç 8080 –Ω–µ —Å–ª—É—à–∞–µ—Ç—Å—è"
    
    echo
    echo "–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ—à–∏–±–∫–∏ –≤ –ª–æ–≥–∞—Ö:"
    journalctl -u pm2-root -n 50 | grep -i error || echo "–ù–µ—Ç –æ—à–∏–±–æ–∫ –≤ journalctl"
fi

echo
echo "üèÅ –°–∫—Ä–∏–ø—Ç –∑–∞–≤–µ—Ä—à–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—ã–≤–æ–¥ –≤—ã—à–µ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø—Ä–æ–±–ª–µ–º."