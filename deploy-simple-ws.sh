#!/bin/bash
# –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –ø—Ä–æ—Å—Ç–æ–≥–æ WebSocket —Å–µ—Ä–≤–µ—Ä–∞

echo "üöÄ –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–ï –ü–†–û–°–¢–û–ì–û WEBSOCKET –°–ï–†–í–ï–†–ê"
echo "==========================================="
echo

# 1. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π —Å–µ—Ä–≤–µ—Ä
echo "1Ô∏è‚É£ –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ WebSocket —Å–µ—Ä–≤–µ—Ä–∞..."
pkill -f signaling-serve || true
sleep 2

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å—Ç–∞—Ä—ã–π –ø—Ä–æ—Ü–µ—Å—Å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
if pgrep -f signaling-serve > /dev/null; then
    echo "‚ö†Ô∏è –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞..."
    pkill -9 -f signaling-serve || true
    sleep 1
fi

echo "‚úÖ –°—Ç–∞—Ä—ã–π —Å–µ—Ä–≤–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"

# 2. –ö–æ–ø–∏—Ä—É–µ–º –Ω–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä
echo
echo "2Ô∏è‚É£ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞..."
cd /root/TelegramVoice

# –ï—Å–ª–∏ —Ñ–∞–π–ª —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω —á–µ—Ä–µ–∑ git pull, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
if [ -f "simple-ws-server.js" ]; then
    echo "‚úÖ –§–∞–π–ª simple-ws-server.js –Ω–∞–π–¥–µ–Ω"
else
    echo "‚ùå –§–∞–π–ª simple-ws-server.js –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    echo "–°–æ–∑–¥–∞–π—Ç–µ –µ–≥–æ –≤—Ä—É—á–Ω—É—é –∏–ª–∏ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è"
    exit 1
fi

# 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ ws –º–æ–¥—É–ª—è
echo
echo "3Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
if [ ! -d "node_modules/ws" ]; then
    echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–æ–¥—É–ª—è ws..."
    npm install ws
fi

# 4. –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä
echo
echo "4Ô∏è‚É£ –ó–∞–ø—É—Å–∫ –Ω–æ–≤–æ–≥–æ WebSocket —Å–µ—Ä–≤–µ—Ä–∞..."
nohup node simple-ws-server.js > websocket-simple.log 2>&1 &
WS_PID=$!

sleep 3

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
if ! kill -0 $WS_PID 2>/dev/null; then
    echo "‚ùå WebSocket —Å–µ—Ä–≤–µ—Ä –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è!"
    echo "–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –ª–æ–≥–∞:"
    tail -10 websocket-simple.log
    exit 1
fi

echo "‚úÖ WebSocket —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω (PID: $WS_PID)"

# 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–∞
echo
echo "5Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–∞ 8080..."
sleep 2
if ss -tlnp | grep -q ":8080"; then
    echo "‚úÖ –ü–æ—Ä—Ç 8080 –æ—Ç–∫—Ä—ã—Ç"
else
    echo "‚ùå –ü–æ—Ä—Ç 8080 –Ω–µ –æ—Ç–∫—Ä—ã—Ç!"
    exit 1
fi

# 6. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–≥–∏
echo
echo "6Ô∏è‚É£ –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –ª–æ–≥–æ–≤:"
tail -5 websocket-simple.log

echo
echo "üéâ –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û!"
echo "=========================="
echo
echo "‚úÖ –ü—Ä–æ—Å—Ç–æ–π WebSocket —Å–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ø–æ—Ä—Ç—É 8080"
echo "‚úÖ –õ–æ–≥–∏: tail -f /root/TelegramVoice/websocket-simple.log"
echo
echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É:"
echo "1. –û—Ç–∫—Ä–æ–π—Ç–µ realtime-ws-test.html –≤ –±—Ä–∞—É–∑–µ—Ä–µ"
echo "2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–µ—Å—Ç"
echo "3. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–∏–¥—è—Ç –¥—Ä—É–≥ –¥—Ä—É–≥–∞"