<!DOCTYPE html>
<html>
<head>
    <title>–õ–æ–∫–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç WebSocket</title>
    <meta charset="utf-8">
</head>
<body>
    <h1>–¢–µ—Å—Ç WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (–õ–æ–∫–∞–ª—å–Ω–æ)</h1>
    <div id="status">–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ</div>
    <button onclick="connect()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
    <button onclick="disconnect()">–û—Ç–∫–ª—é—á–∏—Ç—å—Å—è</button>
    <div id="log" style="white-space: pre-wrap; border: 1px solid #ccc; padding: 10px; margin-top: 10px; height: 300px; overflow-y: auto;"></div>
    
    <script>
        let ws = null;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 3;
        
        const log = (msg) => {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `[${timestamp}] ${msg}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        };

        const status = (msg) => {
            document.getElementById('status').textContent = msg;
        };

        function connect() {
            log('–ù–∞—á–∏–Ω–∞–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...');
            
            if (ws && (ws.readyState === WebSocket.OPEN || ws.readyState === WebSocket.CONNECTING)) {
                log('–£–∂–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ –∏–ª–∏ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è');
                return;
            }
            
            try {
                const userId = 'test-' + Math.random().toString(36).substr(2, 9);
                const params = new URLSearchParams({
                    –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id: userId,
                    –∏–º—è: '–¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
                    —Ç–µ–ª–µ–≥—Ä–∞–º_id: '123456'
                });
                
                const wsUrl = `ws://localhost:8080?${params}`;
                log(`–ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫: ${wsUrl}`);
                
                ws = new WebSocket(wsUrl);
                
                ws.onopen = () => {
                    log('‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω —É—Å–ø–µ—à–Ω–æ!');
                    status('üü¢ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ');
                    reconnectAttempts = 0;
                    
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                    const msg = {
                        —Ç–∏–ø: '–ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è',
                        –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {
                            id: userId,
                            –∏–º—è: '–¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
                            —Ç–µ–ª–µ–≥—Ä–∞–º_id: 123456,
                            –∞–≤–∞—Ç–∞—Ä: null,
                            –ø–æ–¥–∫–ª—é—á–µ–Ω: true,
                            –≤_–∫–æ–º–Ω–∞—Ç–µ: null,
                            –º–∏–∫—Ä–æ—Ñ–æ–Ω_–≤–∫–ª—é—á–µ–Ω: true,
                            –≥–æ–≤–æ—Ä–∏—Ç: false,
                            –ø–æ—Å–ª–µ–¥–Ω—è—è_–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: new Date().toISOString()
                        }
                    };
                    
                    log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ: ' + JSON.stringify(msg, null, 2));
                    ws.send(JSON.stringify(msg));
                };
                
                ws.onmessage = (event) => {
                    log('üì• –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ: ' + event.data);
                };
                
                ws.onerror = (error) => {
                    log('‚ùå –û—à–∏–±–∫–∞ WebSocket: ' + error);
                    status('üî¥ –û—à–∏–±–∫–∞');
                    console.error('WebSocket error:', error);
                };
                
                ws.onclose = (event) => {
                    log(`‚ö†Ô∏è WebSocket –∑–∞–∫—Ä—ã—Ç. Code: ${event.code}, Reason: ${event.reason}`);
                    status('üî¥ –û—Ç–∫–ª—é—á–µ–Ω–æ');
                    ws = null;
                    
                    // –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
                    if (!event.wasClean && reconnectAttempts < maxReconnectAttempts) {
                        reconnectAttempts++;
                        const delay = Math.min(1000 * Math.pow(2, reconnectAttempts - 1), 10000);
                        log(`–ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è ${reconnectAttempts}/${maxReconnectAttempts} —á–µ—Ä–µ–∑ ${delay}–º—Å...`);
                        setTimeout(connect, delay);
                    }
                };
                
            } catch (error) {
                log('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è WebSocket: ' + error);
                status('üî¥ –û—à–∏–±–∫–∞');
            }
        }
        
        function disconnect() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                log('–û—Ç–∫–ª—é—á–∞–µ–º—Å—è...');
                ws.close();
            } else {
                log('–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ');
            }
        }
    </script>
</body>
</html>