'use client';

import { useState, useEffect } from 'react';

interface –ú–∏–∫—Ä–æ—Ñ–æ–Ω–ù–∞—Å—Ç—Ä–æ–π–∫–∏ {
  –≤—ã–±—Ä–∞–Ω–Ω–æ–µ_—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ_id: string;
  —É—Ä–æ–≤–µ–Ω—å_–≥—Ä–æ–º–∫–æ—Å—Ç–∏: number;
  —à—É–º–æ–ø–æ–¥–∞–≤–ª–µ–Ω–∏–µ: boolean;
  –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è_—Ä–µ–≥—É–ª–∏—Ä–æ–≤–∫–∞_—É—Ä–æ–≤–Ω—è: boolean;
  —ç—Ö–æ_–ø–æ–¥–∞–≤–ª–µ–Ω–∏–µ: boolean;
  —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å_–¥–µ—Ç–µ–∫—Ü–∏–∏_–≥–æ–ª–æ—Å–∞: number;
  –∫–∞—á–µ—Å—Ç–≤–æ_–∑–≤—É–∫–∞: '–Ω–∏–∑–∫–æ–µ' | '—Å—Ä–µ–¥–Ω–µ–µ' | '–≤—ã—Å–æ–∫–æ–µ';
}

interface –ù–∞—Å—Ç—Ä–æ–π–∫–∏–ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è {
  –º–∏–∫—Ä–æ—Ñ–æ–Ω: –ú–∏–∫—Ä–æ—Ñ–æ–Ω–ù–∞—Å—Ç—Ä–æ–π–∫–∏;
  —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: boolean;
  —Ç–µ–º–∞: '–∞–≤—Ç–æ' | '—Å–≤–µ—Ç–ª–∞—è' | '—Ç–µ–º–Ω–∞—è';
  —è–∑—ã–∫: 'ru' | 'en';
}

const –Ω–∞—Å—Ç—Ä–æ–π–∫–∏_–ø–æ_—É–º–æ–ª—á–∞–Ω–∏—é: –ù–∞—Å—Ç—Ä–æ–π–∫–∏–ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è = {
  –º–∏–∫—Ä–æ—Ñ–æ–Ω: {
    –≤—ã–±—Ä–∞–Ω–Ω–æ–µ_—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ_id: '',
    —É—Ä–æ–≤–µ–Ω—å_–≥—Ä–æ–º–∫–æ—Å—Ç–∏: 75,
    —à—É–º–æ–ø–æ–¥–∞–≤–ª–µ–Ω–∏–µ: true,
    –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è_—Ä–µ–≥—É–ª–∏—Ä–æ–≤–∫–∞_—É—Ä–æ–≤–Ω—è: true,
    —ç—Ö–æ_–ø–æ–¥–∞–≤–ª–µ–Ω–∏–µ: true,
    —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å_–¥–µ—Ç–µ–∫—Ü–∏–∏_–≥–æ–ª–æ—Å–∞: 50,
    –∫–∞—á–µ—Å—Ç–≤–æ_–∑–≤—É–∫–∞: '—Å—Ä–µ–¥–Ω–µ–µ',
  },
  —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: true,
  —Ç–µ–º–∞: '–∞–≤—Ç–æ',
  —è–∑—ã–∫: 'ru',
};

const –ö–õ–Æ–ß_–ù–ê–°–¢–†–û–ï–ö = 'telegram-voice-settings';

export const useSettings = () => {
  const [–Ω–∞—Å—Ç—Ä–æ–π–∫–∏, set–ù–∞—Å—Ç—Ä–æ–π–∫–∏] = useState<–ù–∞—Å—Ç—Ä–æ–π–∫–∏–ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è>(–Ω–∞—Å—Ç—Ä–æ–π–∫–∏_–ø–æ_—É–º–æ–ª—á–∞–Ω–∏—é);
  const [–∑–∞–≥—Ä—É–∂–µ–Ω–æ, set–ó–∞–≥—Ä—É–∂–µ–Ω–æ] = useState(false);

  // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–∑ localStorage
  useEffect(() => {
    console.log(`[useSettings] üîÑ –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –Ω–∞—Å—Ç—Ä–æ–µ–∫...`);
    try {
      const —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ_–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ = localStorage.getItem(–ö–õ–Æ–ß_–ù–ê–°–¢–†–û–ï–ö);
      console.log(`[useSettings] üìÇ –°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ localStorage:`, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ_–Ω–∞—Å—Ç—Ä–æ–π–∫–∏);
      
      if (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ_–Ω–∞—Å—Ç—Ä–æ–π–∫–∏) {
        const parsed = JSON.parse(—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ_–Ω–∞—Å—Ç—Ä–æ–π–∫–∏);
        console.log(`[useSettings] üìã –†–∞—Å–ø–∞—Ä—Å–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:`, parsed);
        set–ù–∞—Å—Ç—Ä–æ–π–∫–∏({
          ...–Ω–∞—Å—Ç—Ä–æ–π–∫–∏_–ø–æ_—É–º–æ–ª—á–∞–Ω–∏—é,
          ...parsed,
          –º–∏–∫—Ä–æ—Ñ–æ–Ω: {
            ...–Ω–∞—Å—Ç—Ä–æ–π–∫–∏_–ø–æ_—É–º–æ–ª—á–∞–Ω–∏—é.–º–∏–∫—Ä–æ—Ñ–æ–Ω,
            ...parsed.–º–∏–∫—Ä–æ—Ñ–æ–Ω,
          },
        });
        console.log(`[useSettings] ‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ localStorage`);
      } else {
        console.log(`[useSettings] üÜï –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é`);
      }
    } catch (error) {
      console.error('[useSettings] ‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫:', error);
    } finally {
      console.log(`[useSettings] üèÅ –ó–∞–≤–µ—Ä—à–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –Ω–∞—Å—Ç—Ä–æ–µ–∫ - —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥—Ä—É–∂–µ–Ω–æ=true`);
      set–ó–∞–≥—Ä—É–∂–µ–Ω–æ(true);
    }
  }, []);

  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤ localStorage
  const —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å_–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ = (–Ω–æ–≤—ã–µ_–Ω–∞—Å—Ç—Ä–æ–π–∫–∏: –ù–∞—Å—Ç—Ä–æ–π–∫–∏–ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è) => {
    try {
      localStorage.setItem(–ö–õ–Æ–ß_–ù–ê–°–¢–†–û–ï–ö, JSON.stringify(–Ω–æ–≤—ã–µ_–Ω–∞—Å—Ç—Ä–æ–π–∫–∏));
      set–ù–∞—Å—Ç—Ä–æ–π–∫–∏(–Ω–æ–≤—ã–µ_–Ω–∞—Å—Ç—Ä–æ–π–∫–∏);
      
      // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ç–µ–º—ã
      –ø—Ä–∏–º–µ–Ω–∏—Ç—å_—Ç–µ–º—É(–Ω–æ–≤—ã–µ_–Ω–∞—Å—Ç—Ä–æ–π–∫–∏.—Ç–µ–º–∞);
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫:', error);
    }
  };

  // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ç–µ–º—ã
  const –ø—Ä–∏–º–µ–Ω–∏—Ç—å_—Ç–µ–º—É = (—Ç–µ–º–∞: –ù–∞—Å—Ç—Ä–æ–π–∫–∏–ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è['—Ç–µ–º–∞']) => {
    const root = document.documentElement;
    
    if (—Ç–µ–º–∞ === '–∞–≤—Ç–æ') {
      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–º—É –ø–æ —Å–∏—Å—Ç–µ–º–Ω—ã–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º
      const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      root.setAttribute('data-theme', systemDark ? 'dark' : 'light');
    } else {
      root.setAttribute('data-theme', —Ç–µ–º–∞ === '—Ç–µ–º–Ω–∞—è' ? 'dark' : 'light');
    }
  };

  // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ç–µ–º—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
  useEffect(() => {
    if (–∑–∞–≥—Ä—É–∂–µ–Ω–æ) {
      –ø—Ä–∏–º–µ–Ω–∏—Ç—å_—Ç–µ–º—É(–Ω–∞—Å—Ç—Ä–æ–π–∫–∏.—Ç–µ–º–∞);
    }
  }, [–∑–∞–≥—Ä—É–∂–µ–Ω–æ, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.—Ç–µ–º–∞]);

  // –°–ª—É—à–∞—Ç–µ–ª—å –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º–Ω–æ–π —Ç–µ–º—ã
  useEffect(() => {
    if (–Ω–∞—Å—Ç—Ä–æ–π–∫–∏.—Ç–µ–º–∞ === '–∞–≤—Ç–æ') {
      const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
      const handleChange = () => {
        –ø—Ä–∏–º–µ–Ω–∏—Ç—å_—Ç–µ–º—É('–∞–≤—Ç–æ');
      };
      
      mediaQuery.addEventListener('change', handleChange);
      return () => mediaQuery.removeEventListener('change', handleChange);
    }
  }, [–Ω–∞—Å—Ç—Ä–æ–π–∫–∏.—Ç–µ–º–∞]);

  // –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –¥–ª—è WebRTC
  const –ø–æ–ª—É—á–∏—Ç—å_–Ω–∞—Å—Ç—Ä–æ–π–∫–∏_–º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ = (): MediaStreamConstraints['audio'] => {
    const { –º–∏–∫—Ä–æ—Ñ–æ–Ω } = –Ω–∞—Å—Ç—Ä–æ–π–∫–∏;
    
    const constraints: MediaTrackConstraints = {
      echoCancellation: –º–∏–∫—Ä–æ—Ñ–æ–Ω.—ç—Ö–æ_–ø–æ–¥–∞–≤–ª–µ–Ω–∏–µ,
      noiseSuppression: –º–∏–∫—Ä–æ—Ñ–æ–Ω.—à—É–º–æ–ø–æ–¥–∞–≤–ª–µ–Ω–∏–µ,
      autoGainControl: –º–∏–∫—Ä–æ—Ñ–æ–Ω.–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è_—Ä–µ–≥—É–ª–∏—Ä–æ–≤–∫–∞_—É—Ä–æ–≤–Ω—è,
    };

    if (–º–∏–∫—Ä–æ—Ñ–æ–Ω.–≤—ã–±—Ä–∞–Ω–Ω–æ–µ_—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ_id) {
      constraints.deviceId = { exact: –º–∏–∫—Ä–æ—Ñ–æ–Ω.–≤—ã–±—Ä–∞–Ω–Ω–æ–µ_—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ_id };
    }

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –∑–≤—É–∫–∞
    switch (–º–∏–∫—Ä–æ—Ñ–æ–Ω.–∫–∞—á–µ—Å—Ç–≤–æ_–∑–≤—É–∫–∞) {
      case '–Ω–∏–∑–∫–æ–µ':
        constraints.sampleRate = 22050;
        constraints.channelCount = 1;
        break;
      case '–≤—ã—Å–æ–∫–æ–µ':
        constraints.sampleRate = 48000;
        constraints.channelCount = 2;
        break;
      default: // —Å—Ä–µ–¥–Ω–µ–µ
        constraints.sampleRate = 44100;
        constraints.channelCount = 1;
        break;
    }

    return constraints;
  };

  // –°–±—Ä–æ—Å –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∫ –∑–Ω–∞—á–µ–Ω–∏—è–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
  const —Å–±—Ä–æ—Å–∏—Ç—å_–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ = () => {
    —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å_–Ω–∞—Å—Ç—Ä–æ–π–∫–∏(–Ω–∞—Å—Ç—Ä–æ–π–∫–∏_–ø–æ_—É–º–æ–ª—á–∞–Ω–∏—é);
  };

  return {
    –Ω–∞—Å—Ç—Ä–æ–π–∫–∏,
    –∑–∞–≥—Ä—É–∂–µ–Ω–æ,
    —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å_–Ω–∞—Å—Ç—Ä–æ–π–∫–∏,
    –ø–æ–ª—É—á–∏—Ç—å_–Ω–∞—Å—Ç—Ä–æ–π–∫–∏_–º–∏–∫—Ä–æ—Ñ–æ–Ω–∞,
    —Å–±—Ä–æ—Å–∏—Ç—å_–Ω–∞—Å—Ç—Ä–æ–π–∫–∏,
  };
};