import { useEffect, useState, useCallback, useRef } from 'react';
import { –°–æ–æ–±—â–µ–Ω–∏–µ–í–µ–±–°–æ–∫–µ—Ç–∞, –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –ö–æ–º–Ω–∞—Ç–∞ } from '@/types';

interface UseSocketProps {
  —Å–µ—Ä–≤–µ—ÄUrl: string;
  –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å | null;
  –Ω–∞_–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π?: (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å[]) => void;
  –Ω–∞_–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ_–∫–æ–º–Ω–∞—Ç?: (–∫–æ–º–Ω–∞—Ç—ã: –ö–æ–º–Ω–∞—Ç–∞[]) => void;
  –Ω–∞_–æ—à–∏–±–∫—É?: (–æ—à–∏–±–∫–∞: string) => void;
}

export const useSocket = ({
  —Å–µ—Ä–≤–µ—ÄUrl,
  –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å,
  –Ω–∞_–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π,
  –Ω–∞_–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ_–∫–æ–º–Ω–∞—Ç,
  –Ω–∞_–æ—à–∏–±–∫—É
}: UseSocketProps) => {
  const [socket, setSocket] = useState<WebSocket | null>(null);
  const [–ø–æ–¥–∫–ª—é—á–µ–Ω–æ, set–ü–æ–¥–∫–ª—é—á–µ–Ω–æ] = useState(false);
  const [–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è, set–ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è] = useState(false);
  const –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ = useRef<Map<string, Set<(...args: any[]) => void>>>(new Map());
  const –ø–æ–ø—ã—Ç–∫–∏_–ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è = useRef(0);
  const –º–∞–∫—Å–∏–º—É–º_–ø–æ–ø—ã—Ç–æ–∫ = 3;
  const —Ç–∞–π–º–µ—Ä_–ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è = useRef<NodeJS.Timeout | null>(null);

  // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É
  const –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è = useCallback(async () => {
    console.log(`[useSocket] üîÑ –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É: ${—Å–µ—Ä–≤–µ—ÄUrl}`);
    console.log(`[useSocket] –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–∫–µ—Ç–∞: ${socket?.readyState || 'null'}`);
    console.log(`[useSocket] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:`, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å);
    
    if (socket?.readyState === WebSocket.OPEN || socket?.readyState === WebSocket.CONNECTING || !–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å) {
      console.log(`[useSocket] ‚ùå –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ:`, {
        socketState: socket?.readyState,
        hasUser: !!–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å,
        reason: !–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ? '–Ω–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è' : '—É–∂–µ –ø–æ–¥–∫–ª—é—á–µ–Ω –∏–ª–∏ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è'
      });
      return;
    }

    try {
      set–ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è(true);
      console.log(`[useSocket] ‚è≥ –ù–∞—á–∏–Ω–∞–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket...`);
      
      // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –±–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤, –¥–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–∏–º –ø–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
      const –Ω–æ–≤—ã–π_socket = new WebSocket(—Å–µ—Ä–≤–µ—ÄUrl);
      console.log(`[useSocket] üåê WebSocket —Å–æ–∑–¥–∞–Ω, —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${–Ω–æ–≤—ã–π_socket.readyState}`);

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
      –Ω–æ–≤—ã–π_socket.onopen = () => {
        console.log(`[useSocket] ‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω —É—Å–ø–µ—à–Ω–æ!`);
        console.log(`[useSocket] –°–æ—Å—Ç–æ—è–Ω–∏–µ: OPEN (${WebSocket.OPEN})`);
        set–ü–æ–¥–∫–ª—é—á–µ–Ω–æ(true);
        set–ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è(false);
        –ø–æ–ø—ã—Ç–∫–∏_–ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è.current = 0; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ (—Å–æ–≥–ª–∞—Å–Ω–æ —Å–µ—Ä–≤–µ—Ä–Ω–æ–º—É –ø—Ä–æ—Ç–æ–∫–æ–ª—É)
        const —Å–æ–æ–±—â–µ–Ω–∏–µ = {
          —Ç–∏–ø: '–ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è',
          –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {
            id: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.id,
            –∏–º—è: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.–∏–º—è,
            —Ç–µ–ª–µ–≥—Ä–∞–º_id: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.—Ç–µ–ª–µ–≥—Ä–∞–º_id,
            –∞–≤–∞—Ç–∞—Ä: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.–∞–≤–∞—Ç–∞—Ä,
            –ø–æ–¥–∫–ª—é—á–µ–Ω: true,
            –≤_–∫–æ–º–Ω–∞—Ç–µ: null,
            –º–∏–∫—Ä–æ—Ñ–æ–Ω_–≤–∫–ª—é—á–µ–Ω: false,
            –≥–æ–≤–æ—Ä–∏—Ç: false,
            –ø–æ—Å–ª–µ–¥–Ω—è—è_–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: new Date().toISOString()
          }
        };
        console.log(`[useSocket] üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:`, —Å–æ–æ–±—â–µ–Ω–∏–µ);
        –Ω–æ–≤—ã–π_socket.send(JSON.stringify(—Å–æ–æ–±—â–µ–Ω–∏–µ));
      };

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
      –Ω–æ–≤—ã–π_socket.onmessage = (event) => {
        console.log(`[useSocket] üì• –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ:`, event.data);
        try {
          const –¥–∞–Ω–Ω—ã–µ = JSON.parse(event.data);
          console.log(`[useSocket] üìã –†–∞—Å–ø–∞—Ä—Å–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:`, –¥–∞–Ω–Ω—ã–µ);
          
          // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è
          const —Ç–∏–ø = –¥–∞–Ω–Ω—ã–µ.—Ç–∏–ø || 'unknown';
          console.log(`[useSocket] üè∑Ô∏è –¢–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è: ${—Ç–∏–ø}`);
          
          // –í—ã–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ç–∏–ø–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
          const handlers = –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏.current.get(—Ç–∏–ø);
          if (handlers) {
            console.log(`[useSocket] üéØ –ù–∞–π–¥–µ–Ω–æ ${handlers.size} –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –¥–ª—è —Ç–∏–ø–∞: ${—Ç–∏–ø}`);
            handlers.forEach(handler => {
              handler(–¥–∞–Ω–Ω—ã–µ);
            });
          } else {
            console.log(`[useSocket] ‚ö†Ô∏è –ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –¥–ª—è —Ç–∏–ø–∞: ${—Ç–∏–ø}`);
          }
          
          // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
          switch (—Ç–∏–ø) {
            case '–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏-–æ–±–Ω–æ–≤–ª–µ–Ω—ã':
              console.log(`[useSocket] üë• –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:`, –¥–∞–Ω–Ω—ã–µ.–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏);
              –Ω–∞_–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π?.(–¥–∞–Ω–Ω—ã–µ.–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ || []);
              break;
            case '–∫–æ–º–Ω–∞—Ç—ã-–æ–±–Ω–æ–≤–ª–µ–Ω—ã':
              console.log(`[useSocket] üè† –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–º–Ω–∞—Ç:`, –¥–∞–Ω–Ω—ã–µ.–∫–æ–º–Ω–∞—Ç—ã);
              –Ω–∞_–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ_–∫–æ–º–Ω–∞—Ç?.(–¥–∞–Ω–Ω—ã–µ.–∫–æ–º–Ω–∞—Ç—ã || []);
              break;
            case '–æ—à–∏–±–∫–∞':
              console.error(`[useSocket] ‚ùå –û—à–∏–±–∫–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:`, –¥–∞–Ω–Ω—ã–µ.—Å–æ–æ–±—â–µ–Ω–∏–µ);
              –Ω–∞_–æ—à–∏–±–∫—É?.(–¥–∞–Ω–Ω—ã–µ.—Å–æ–æ–±—â–µ–Ω–∏–µ || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
              break;
          }
        } catch (error) {
          console.error(`[useSocket] üí• –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:`, error);
          console.error(`[useSocket] üìÑ –ü—Ä–æ–±–ª–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:`, event.data);
        }
      };

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
      –Ω–æ–≤—ã–π_socket.onclose = (event) => {
        console.log(`[useSocket] üîå WebSocket –∑–∞–∫—Ä—ã—Ç:`, {
          code: event.code,
          reason: event.reason,
          wasClean: event.wasClean,
          –ø–æ–ø—ã—Ç–∫–∏: –ø–æ–ø—ã—Ç–∫–∏_–ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è.current
        });
        set–ü–æ–¥–∫–ª—é—á–µ–Ω–æ(false);
        setSocket(null);
        
        // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–µ—Ä –µ—Å–ª–∏ –µ—Å—Ç—å
        if (—Ç–∞–π–º–µ—Ä_–ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è.current) {
          clearTimeout(—Ç–∞–π–º–µ—Ä_–ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è.current);
          —Ç–∞–π–º–µ—Ä_–ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è.current = null;
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ–º –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏
        if (!event.wasClean && –ø–æ–ø—ã—Ç–∫–∏_–ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è.current < –º–∞–∫—Å–∏–º—É–º_–ø–æ–ø—ã—Ç–æ–∫) {
          –ø–æ–ø—ã—Ç–∫–∏_–ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è.current++;
          console.log(`[useSocket] üîÑ –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ ${–ø–æ–ø—ã—Ç–∫–∏_–ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è.current}/${–º–∞–∫—Å–∏–º—É–º_–ø–æ–ø—ã—Ç–æ–∫}...`);
          
          const –∑–∞–¥–µ—Ä–∂–∫–∞ = Math.min(1000 * Math.pow(2, –ø–æ–ø—ã—Ç–∫–∏_–ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è.current - 1), 10000);
          console.log(`[useSocket] ‚è∞ –ó–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º: ${–∑–∞–¥–µ—Ä–∂–∫–∞}–º—Å`);
          —Ç–∞–π–º–µ—Ä_–ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è.current = setTimeout(() => {
            —Ç–∞–π–º–µ—Ä_–ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è.current = null;
            –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è();
          }, –∑–∞–¥–µ—Ä–∂–∫–∞);
        } else if (–ø–æ–ø—ã—Ç–∫–∏_–ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è.current >= –º–∞–∫—Å–∏–º—É–º_–ø–æ–ø—ã—Ç–æ–∫) {
          console.error(`[useSocket] üö´ –ü—Ä–µ–≤—ã—à–µ–Ω–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è`);
          –Ω–∞_–æ—à–∏–±–∫—É?.('–ü—Ä–µ–≤—ã—à–µ–Ω–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
        }
      };

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
      –Ω–æ–≤—ã–π_socket.onerror = (error) => {
        console.error(`[useSocket] üí• –û—à–∏–±–∫–∞ WebSocket:`, error);
        console.error(`[useSocket] üåê URL —Å–µ—Ä–≤–µ—Ä–∞: ${—Å–µ—Ä–≤–µ—ÄUrl}`);
        console.error(`[useSocket] üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–∫–µ—Ç–∞: ${–Ω–æ–≤—ã–π_socket.readyState}`);
        set–ü–æ–¥–∫–ª—é—á–µ–Ω–æ(false);
        set–ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è(false);
        // –ù–µ –≤—ã–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É —Å—Ä–∞–∑—É, –ø–æ–∑–≤–æ–ª—è–µ–º onclose –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
      };

      setSocket(–Ω–æ–≤—ã–π_socket);
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:', error);
      set–ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è(false);
      –Ω–∞_–æ—à–∏–±–∫—É?.('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
    }
  }, [—Å–µ—Ä–≤–µ—ÄUrl, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –Ω–∞_–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –Ω–∞_–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ_–∫–æ–º–Ω–∞—Ç, –Ω–∞_–æ—à–∏–±–∫—É]);

  // –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
  const –æ—Ç–∫–ª—é—á–∏—Ç—å—Å—è = useCallback(() => {
    if (socket && socket.readyState === WebSocket.OPEN) {
      socket.close();
      setSocket(null);
      set–ü–æ–¥–∫–ª—é—á–µ–Ω–æ(false);
    }
  }, [socket]);

  // –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–µ
  const –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è_–∫_–∫–æ–º–Ω–∞—Ç–µ = useCallback((–∫–æ–º–Ω–∞—Ç–∞_id: string, –ø–∞—Ä–æ–ª—å?: string) => {
    if (socket && socket.readyState === WebSocket.OPEN && –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å) {
      const —Å–æ–æ–±—â–µ–Ω–∏–µ = {
        —Ç–∏–ø: '–ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è-–∫-–∫–æ–º–Ω–∞—Ç–µ',
        –∫–æ–º–Ω–∞—Ç–∞_id,
        –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.id,
        –ø–∞—Ä–æ–ª—å
      };
      socket.send(JSON.stringify(—Å–æ–æ–±—â–µ–Ω–∏–µ));
    }
  }, [socket, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å]);

  // –ü–æ–∫–∏–Ω—É—Ç—å –∫–æ–º–Ω–∞—Ç—É
  const –ø–æ–∫–∏–Ω—É—Ç—å_–∫–æ–º–Ω–∞—Ç—É = useCallback((–∫–æ–º–Ω–∞—Ç–∞_id: string) => {
    if (socket && socket.readyState === WebSocket.OPEN && –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å) {
      const —Å–æ–æ–±—â–µ–Ω–∏–µ = {
        —Ç–∏–ø: '–ø–æ–∫–∏–Ω—É—Ç—å-–∫–æ–º–Ω–∞—Ç—É',
        –∫–æ–º–Ω–∞—Ç–∞_id,
        –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.id
      };
      socket.send(JSON.stringify(—Å–æ–æ–±—â–µ–Ω–∏–µ));
    }
  }, [socket, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å]);

  // –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∫–æ–º–Ω–∞—Ç—É
  const —Å–æ–∑–¥–∞—Ç—å_–∫–æ–º–Ω–∞—Ç—É = useCallback((–Ω–∞–∑–≤–∞–Ω–∏–µ: string, –º–∞–∫—Å–∏–º—É–º_—É—á–∞—Å—Ç–Ω–∏–∫–æ–≤: number = 10, –ø—Ä–∏–≤–∞—Ç–Ω–∞—è: boolean = false, –ø–∞—Ä–æ–ª—å?: string) => {
    if (socket && socket.readyState === WebSocket.OPEN && –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å) {
      const —Å–æ–æ–±—â–µ–Ω–∏–µ = {
        —Ç–∏–ø: '—Å–æ–∑–¥–∞—Ç—å-–∫–æ–º–Ω–∞—Ç—É',
        –Ω–∞–∑–≤–∞–Ω–∏–µ,
        —Å–æ–∑–¥–∞—Ç–µ–ª—å: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.id,
        –º–∞–∫—Å–∏–º—É–º_—É—á–∞—Å—Ç–Ω–∏–∫–æ–≤,
        –ø—Ä–∏–≤–∞—Ç–Ω–∞—è,
        –ø–∞—Ä–æ–ª—å
      };
      socket.send(JSON.stringify(—Å–æ–æ–±—â–µ–Ω–∏–µ));
    }
  }, [socket, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å]);

  // –û—Ç–ø—Ä–∞–≤–∫–∞ WebRTC —Å–∏–≥–Ω–∞–ª–∞
  const –æ—Ç–ø—Ä–∞–≤–∏—Ç—å_webrtc_—Å–∏–≥–Ω–∞–ª = useCallback((–¥–∞–Ω–Ω—ã–µ: any, –∫: string, –∫–æ–º–Ω–∞—Ç–∞: string) => {
    if (socket && socket.readyState === WebSocket.OPEN && –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å) {
      const —Å–æ–æ–±—â–µ–Ω–∏–µ = {
        —Ç–∏–ø: 'webrtc-signal',
        –æ—Ç: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.id,
        –∫,
        –∫–æ–º–Ω–∞—Ç–∞,
        –¥–∞–Ω–Ω—ã–µ
      };
      
      console.log('[Socket] –û—Ç–ø—Ä–∞–≤–∫–∞ WebRTC —Å–∏–≥–Ω–∞–ª–∞:', { 
        –æ—Ç: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.id, 
        –∫, 
        –∫–æ–º–Ω–∞—Ç–∞,
        —Ç–∏–ø_–¥–∞–Ω–Ω—ã—Ö: –¥–∞–Ω–Ω—ã–µ.type 
      });
      
      socket.send(JSON.stringify(—Å–æ–æ–±—â–µ–Ω–∏–µ));
    }
  }, [socket, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å]);

  // –û—Ç–ø—Ä–∞–≤–∫–∞ –æ–±—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
  const –æ—Ç–ø—Ä–∞–≤–∏—Ç—å_—Å–æ–æ–±—â–µ–Ω–∏–µ = –æ—Ç–ø—Ä–∞–≤–∏—Ç—å_webrtc_—Å–∏–≥–Ω–∞–ª;

  // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
  const –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å_–º–∏–∫—Ä–æ—Ñ–æ–Ω = useCallback((–≤–∫–ª—é—á–µ–Ω: boolean, –∫–æ–º–Ω–∞—Ç–∞_id?: string) => {
    if (socket && socket.readyState === WebSocket.OPEN && –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å) {
      const —Å–æ–æ–±—â–µ–Ω–∏–µ = {
        —Ç–∏–ø: '–º–∏–∫—Ä–æ—Ñ–æ–Ω-–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω',
        –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.id,
        –∫–æ–º–Ω–∞—Ç–∞_id,
        –≤–∫–ª—é—á–µ–Ω
      };
      socket.send(JSON.stringify(—Å–æ–æ–±—â–µ–Ω–∏–µ));
    }
  }, [socket, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å]);

  // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≥–æ–≤–æ—Ä–∏—Ç
  const —É–≤–µ–¥–æ–º–∏—Ç—å_–æ_—Ä–µ—á–∏ = useCallback((–≥–æ–≤–æ—Ä–∏—Ç: boolean, –∫–æ–º–Ω–∞—Ç–∞_id?: string) => {
    if (socket && socket.readyState === WebSocket.OPEN && –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å) {
      const —Å–æ–æ–±—â–µ–Ω–∏–µ = {
        —Ç–∏–ø: '–≥–æ–≤–æ—Ä–∏—Ç',
        –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.id,
        –∫–æ–º–Ω–∞—Ç–∞_id,
        –≥–æ–≤–æ—Ä–∏—Ç
      };
      socket.send(JSON.stringify(—Å–æ–æ–±—â–µ–Ω–∏–µ));
    }
  }, [socket, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å]);

  // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∫–æ–º–Ω–∞—Ç
  const –ø–æ–ª—É—á–∏—Ç—å_–∫–æ–º–Ω–∞—Ç—ã = useCallback(() => {
    if (socket && socket.readyState === WebSocket.OPEN) {
      const —Å–æ–æ–±—â–µ–Ω–∏–µ = {
        —Ç–∏–ø: '–ø–æ–ª—É—á–∏—Ç—å-–∫–æ–º–Ω–∞—Ç—ã',
        –¥–∞–Ω–Ω—ã–µ: {},
        –æ—Ç: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å?.id || 'anonymous',
        –≤—Ä–µ–º—è: Date.now()
      };
      socket.send(JSON.stringify(—Å–æ–æ–±—â–µ–Ω–∏–µ));
    }
  }, [socket, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å]);

  // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –∫–æ–º–Ω–∞—Ç–µ
  const –ø–æ–ª—É—á–∏—Ç—å_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π_–∫–æ–º–Ω–∞—Ç—ã = useCallback((–∫–æ–º–Ω–∞—Ç–∞_id: string) => {
    if (socket && socket.readyState === WebSocket.OPEN) {
      const —Å–æ–æ–±—â–µ–Ω–∏–µ = {
        —Ç–∏–ø: '–ø–æ–ª—É—á–∏—Ç—å-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π-–∫–æ–º–Ω–∞—Ç—ã',
        –¥–∞–Ω–Ω—ã–µ: { –∫–æ–º–Ω–∞—Ç–∞_id },
        –æ—Ç: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å?.id || 'anonymous',
        –≤—Ä–µ–º—è: Date.now()
      };
      socket.send(JSON.stringify(—Å–æ–æ–±—â–µ–Ω–∏–µ));
    }
  }, [socket, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å]);

  // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏–µ
  const –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è = useCallback((—Å–æ–±—ã—Ç–∏–µ: string, –æ–±—Ä–∞–±–æ—Ç—á–∏–∫: (...args: any[]) => void) => {
    if (!–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏.current.has(—Å–æ–±—ã—Ç–∏–µ)) {
      –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏.current.set(—Å–æ–±—ã—Ç–∏–µ, new Set());
    }
    –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏.current.get(—Å–æ–±—ã—Ç–∏–µ)!.add(–æ–±—Ä–∞–±–æ—Ç—á–∏–∫);
    
    return () => {
      –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏.current.get(—Å–æ–±—ã—Ç–∏–µ)?.delete(–æ–±—Ä–∞–±–æ—Ç—á–∏–∫);
    };
  }, []);

  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  useEffect(() => {
    console.log(`[useSocket] üîÑ useEffect –∞–≤—Ç–æ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:`, {
      –µ—Å—Ç—å_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: !!–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å,
      –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å?.id,
      –µ—Å—Ç—å_—Å–æ–∫–µ—Ç: !!socket,
      —Å–æ—Å—Ç–æ—è–Ω–∏–µ_—Å–æ–∫–µ—Ç–∞: socket?.readyState,
      –ø–æ–¥–∫–ª—é—á–µ–Ω–æ: –ø–æ–¥–∫–ª—é—á–µ–Ω–æ,
      –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è: –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è
    });
    
    if (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å && !socket) {
      console.log(`[useSocket] üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.id}`);
      –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è();
    } else if (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å && socket) {
      console.log(`[useSocket] ‚ÑπÔ∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ—Å—Ç—å, —Å–æ–∫–µ—Ç –µ—Å—Ç—å (—Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${socket.readyState})`);
    } else if (!–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å) {
      console.log(`[useSocket] ‚è∏Ô∏è –ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è - –∂–¥–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏`);
    }
    
    return () => {
      console.log(`[useSocket] üßπ –û—á–∏—Å—Ç–∫–∞ useEffect –∞–≤—Ç–æ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è`);
      // –û—á–∏—â–∞–µ–º —Ç–∞–π–º–µ—Ä –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
      if (—Ç–∞–π–º–µ—Ä_–ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è.current) {
        clearTimeout(—Ç–∞–π–º–µ—Ä_–ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è.current);
        —Ç–∞–π–º–µ—Ä_–ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è.current = null;
      }
      
      if (socket && socket.readyState === WebSocket.OPEN) {
        console.log(`[useSocket] üîå –ó–∞–∫—Ä—ã–≤–∞–µ–º WebSocket –ø—Ä–∏ —Ä–∞–∑–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏`);
        socket.close();
      }
    };
  }, [–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å]);

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
  useEffect(() => {
    const –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_–æ–Ω–ª–∞–π–Ω = () => {
      if (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å && socket && socket.readyState !== WebSocket.OPEN) {
        –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è();
      }
    };

    window.addEventListener('online', –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_–æ–Ω–ª–∞–π–Ω);
    
    return () => {
      window.removeEventListener('online', –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_–æ–Ω–ª–∞–π–Ω);
    };
  }, [–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, socket, –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è]);

  return {
    socket,
    –ø–æ–¥–∫–ª—é—á–µ–Ω–æ,
    –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è,
    –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è,
    –æ—Ç–∫–ª—é—á–∏—Ç—å—Å—è,
    –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è_–∫_–∫–æ–º–Ω–∞—Ç–µ,
    –ø–æ–∫–∏–Ω—É—Ç—å_–∫–æ–º–Ω–∞—Ç—É,
    —Å–æ–∑–¥–∞—Ç—å_–∫–æ–º–Ω–∞—Ç—É,
    –æ—Ç–ø—Ä–∞–≤–∏—Ç—å_—Å–æ–æ–±—â–µ–Ω–∏–µ,
    –æ—Ç–ø—Ä–∞–≤–∏—Ç—å_webrtc_—Å–∏–≥–Ω–∞–ª,
    –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å_–º–∏–∫—Ä–æ—Ñ–æ–Ω,
    —É–≤–µ–¥–æ–º–∏—Ç—å_–æ_—Ä–µ—á–∏,
    –ø–æ–ª—É—á–∏—Ç—å_–∫–æ–º–Ω–∞—Ç—ã,
    –ø–æ–ª—É—á–∏—Ç—å_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π_–∫–æ–º–Ω–∞—Ç—ã,
    –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è
  };
};