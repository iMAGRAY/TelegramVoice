'use client';

import React, { useState, useEffect, useRef, useCallback } from 'react';
import { –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –ö–æ–º–Ω–∞—Ç–∞ } from '@/types';
import { useWebRTC } from '@/hooks/useWebRTC';
import { useMediaPermissions } from '@/hooks/useMediaPermissions';
import { useVoiceAnalyzer } from '@/hooks/useVoiceAnalyzer';
import { Mic, MicOff, PhoneOff, Users, Volume2, Radio, AlertTriangle } from 'lucide-react';
import { ICEStatus } from './ICEStatus';
import { MediaPermissionModal } from './MediaPermissionModal';
import { MicrophoneError } from './MicrophoneError';
import { checkWebRTCCapabilities, getBrowserInfo, getRecommendedSettings } from '@/utils/webrtcCompat';

interface VoiceRoomProps {
  –∫–æ–º–Ω–∞—Ç–∞: –ö–æ–º–Ω–∞—Ç–∞;
  —Ç–µ–∫—É—â–∏–π_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å;
  socket: any;
  –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è: (—Å–æ–±—ã—Ç–∏–µ: string, –æ–±—Ä–∞–±–æ—Ç—á–∏–∫: (...args: any[]) => void) => () => void;
  –Ω–∞_–ø–æ–∫–∏–Ω—É—Ç—å_–∫–æ–º–Ω–∞—Ç—É: () => void;
  –Ω–∞_–æ—Ç–∫—Ä—ã—Ç—å_–Ω–∞—Å—Ç—Ä–æ–π–∫–∏?: () => void;
}

export const SimpleVoiceRoom: React.FC<VoiceRoomProps> = ({
  –∫–æ–º–Ω–∞—Ç–∞,
  —Ç–µ–∫—É—â–∏–π_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å,
  socket,
  –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è,
  –Ω–∞_–ø–æ–∫–∏–Ω—É—Ç—å_–∫–æ–º–Ω–∞—Ç—É,
  –Ω–∞_–æ—Ç–∫—Ä—ã—Ç—å_–Ω–∞—Å—Ç—Ä–æ–π–∫–∏
}) => {
  console.log(`[SimpleVoiceRoom] üé¨ –ö–û–ú–ü–û–ù–ï–ù–¢ –ú–û–ù–¢–ò–†–£–ï–¢–°–Ø –¥–ª—è –∫–æ–º–Ω–∞—Ç—ã:`, –∫–æ–º–Ω–∞—Ç–∞.–Ω–∞–∑–≤–∞–Ω–∏–µ);
  const [—É—á–∞—Å—Ç–Ω–∏–∫–∏, set–£—á–∞—Å—Ç–Ω–∏–∫–∏] = useState<–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å[]>([—Ç–µ–∫—É—â–∏–π_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å]);
  const [–∞—É–¥–∏–æ_–ø–æ—Ç–æ–∫–∏, set–ê—É–¥–∏–æ_–ø–æ—Ç–æ–∫–∏] = useState<Map<string, MediaStream>>(new Map());
  const [–≥–æ–≤–æ—Ä—è—â–∏–µ_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, set–ì–æ–≤–æ—Ä—è—â–∏–µ_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏] = useState<Set<string>>(new Set());
  const [–ø–æ–∫–∞–∑–∞—Ç—å_—Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è, set–ü–æ–∫–∞–∑–∞—Ç—å_—Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è] = useState(false);
  const [—Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è_–ø—Ä–æ–≤–µ—Ä–µ–Ω—ã, set–†–∞–∑—Ä–µ—à–µ–Ω–∏—è_–ø—Ä–æ–≤–µ—Ä–µ–Ω—ã] = useState(false);
  const [—Ç—Ä–µ–±—É–µ—Ç—Å—è_–≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ, set–¢—Ä–µ–±—É–µ—Ç—Å—è_–≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ] = useState(false);
  const [webrtc_–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞, setWebrtc_–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞] = useState<{
    —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å_–ø—Ä–æ–≤–µ—Ä–µ–Ω–∞: boolean;
    –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è: boolean;
    –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è: string[];
    —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏: string[];
  }>({
    —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å_–ø—Ä–æ–≤–µ—Ä–µ–Ω–∞: false,
    –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è: true,
    –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è: [],
    —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏: []
  });
  const –∞—É–¥–∏–æ_refs = useRef<Map<string, HTMLAudioElement>>(new Map());

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è WebRTC
  const [—É–¥–∞–ª–µ–Ω–Ω—ã–π_–ø–æ—Ç–æ–∫_–æ–±—Ä–∞–±–æ—Ç—á–∏–∫, set–£–¥–∞–ª–µ–Ω–Ω—ã–π_–ø–æ—Ç–æ–∫_–æ–±—Ä–∞–±–æ—Ç—á–∏–∫] = useState<((–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id: string, –ø–æ—Ç–æ–∫: MediaStream) => void) | null>(null);
  const [–æ—Ç–∫–ª—é—á–µ–Ω–∏–µ_–æ–±—Ä–∞–±–æ—Ç—á–∏–∫, set–û—Ç–∫–ª—é—á–µ–Ω–∏–µ_–æ–±—Ä–∞–±–æ—Ç—á–∏–∫] = useState<((–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id: string) => void) | null>(null);

  // –•—É–∫ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è–º–∏
  const { —Å—Ç–∞—Ç—É—Å_–º–∏–∫—Ä–æ—Ñ–æ–Ω–∞, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è } = useMediaPermissions();

  // WebRTC —Ö—É–∫
  const {
    –ª–æ–∫–∞–ª—å–Ω—ã–π_–ø–æ—Ç–æ–∫,
    –º–∏–∫—Ä–æ—Ñ–æ–Ω_–≤–∫–ª—é—á–µ–Ω,
    –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è,
    –æ—à–∏–±–∫–∞,
    –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å_–º–∏–∫—Ä–æ—Ñ–æ–Ω,
    –ø–æ–ª—É—á–∏—Ç—å_–º–∏–∫—Ä–æ—Ñ–æ–Ω,
    –æ—á–∏—Å—Ç–∏—Ç—å,
    –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è_–∫_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é,
    —É–¥–∞–ª–∏—Ç—å_peer,
    —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å_—Å–æ—Å—Ç–æ—è–Ω–∏–µ_–º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
  } = useWebRTC({
    –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id: —Ç–µ–∫—É—â–∏–π_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.id,
    –∫–æ–º–Ω–∞—Ç–∞_id: –∫–æ–º–Ω–∞—Ç–∞.id,
    socket,
    –Ω–∞_–ø–æ–ª—É—á–µ–Ω–∏–µ_–ø–æ—Ç–æ–∫–∞: (–ø–æ—Ç–æ–∫, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id) => {
      —É–¥–∞–ª–µ–Ω–Ω—ã–π_–ø–æ—Ç–æ–∫_–æ–±—Ä–∞–±–æ—Ç—á–∏–∫?.(–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id, –ø–æ—Ç–æ–∫);
    },
    –Ω–∞_–æ—Ç–∫–ª—é—á–µ–Ω–∏–µ_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id) => {
      –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ_–æ–±—Ä–∞–±–æ—Ç—á–∏–∫?.(–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id);
    }
  });

  // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–æ—Å—Ç–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ë–ï–ó –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã—Ö —Ü–∏–∫–ª–æ–≤
  const –±–µ–∑–æ–ø–∞—Å–Ω–æ_–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è_–∫_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é = useCallback((–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id: string) => {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞ –ø–µ—Ä–µ–¥ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º
    console.log(`[SimpleVoiceRoom] ‚ùî –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ ${–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id}: –º–∏–∫—Ä–æ—Ñ–æ–Ω ${–ª–æ–∫–∞–ª—å–Ω—ã–π_–ø–æ—Ç–æ–∫ ? '–µ—Å—Ç—å' : '–û–¢–°–£–¢–°–¢–í–£–ï–¢'}`);
    
    if (!–ª–æ–∫–∞–ª—å–Ω—ã–π_–ø–æ—Ç–æ–∫) {
      console.error(`[SimpleVoiceRoom] ‚ùå –û–¢–ö–õ–û–ù–ï–ù–û –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ ${–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id} - –º–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –ø–æ–ª—É—á–µ–Ω`);
      return;
    }
    
    console.log(`[SimpleVoiceRoom] ‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id} —Å –ª–æ–∫–∞–ª—å–Ω—ã–º –ø–æ—Ç–æ–∫–æ–º`);
    –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è_–∫_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é(–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id);
  }, [–ª–æ–∫–∞–ª—å–Ω—ã–π_–ø–æ—Ç–æ–∫, –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è_–∫_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é]);

  // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ - –±–µ–∑ –ª–∏—à–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
  useEffect(() => {
    if (!—Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è_–ø—Ä–æ–≤–µ—Ä–µ–Ω—ã && –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è) {
      if (—Å—Ç–∞—Ç—É—Å_–º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ === '–æ—Ç–∫–ª–æ–Ω–µ–Ω–æ' || —Å—Ç–∞—Ç—É—Å_–º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ === '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ') {
        set–ü–æ–∫–∞–∑–∞—Ç—å_—Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è(true);
      } else if (—Å—Ç–∞—Ç—É—Å_–º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ === '—Ä–∞–∑—Ä–µ—à–µ–Ω–æ') {
        set–†–∞–∑—Ä–µ—à–µ–Ω–∏—è_–ø—Ä–æ–≤–µ—Ä–µ–Ω—ã(true);
        console.log('[SimpleVoiceRoom] üé§ –†–∞–∑—Ä–µ—à–µ–Ω–∏—è —É–∂–µ –µ—Å—Ç—å');
      }
    }
  }, [—Å—Ç–∞—Ç—É—Å_–º–∏–∫—Ä–æ—Ñ–æ–Ω–∞, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è, —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è_–ø—Ä–æ–≤–µ—Ä–µ–Ω—ã]);

  // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ú–µ–º–æ–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π
  const –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_—Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ_–ø–æ–ª—É—á–µ–Ω–æ = useCallback(() => {
    set–ü–æ–∫–∞–∑–∞—Ç—å_—Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è(false);
    set–†–∞–∑—Ä–µ—à–µ–Ω–∏—è_–ø—Ä–æ–≤–µ—Ä–µ–Ω—ã(true);
    
    if (!–ª–æ–∫–∞–ª—å–Ω—ã–π_–ø–æ—Ç–æ–∫) {
      setTimeout(() => {
        –ø–æ–ª—É—á–∏—Ç—å_–º–∏–∫—Ä–æ—Ñ–æ–Ω().catch(error => {
          console.error('[SimpleVoiceRoom] –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞:', error);
        });
      }, 100);
    }
  }, [–ª–æ–∫–∞–ª—å–Ω—ã–π_–ø–æ—Ç–æ–∫, –ø–æ–ª—É—á–∏—Ç—å_–º–∏–∫—Ä–æ—Ñ–æ–Ω]);

  const –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_—Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ_–æ—Ç–∫–ª–æ–Ω–µ–Ω–æ = useCallback(() => {
    set–ü–æ–∫–∞–∑–∞—Ç—å_—Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è(false);
    set–†–∞–∑—Ä–µ—à–µ–Ω–∏—è_–ø—Ä–æ–≤–µ—Ä–µ–Ω—ã(true);
  }, []);

  // –£–õ–£–ß–®–ï–ù–ù–ê–Ø —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –≤—Å–µ—Ö –∞—É–¥–∏–æ –ø–æ—Å–ª–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
  const –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏_–≤—Å–µ_–∞—É–¥–∏–æ = async () => {
    console.log('[Audio] –ü–æ–ø—ã—Ç–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –≤—Å–µ—Ö –∞—É–¥–∏–æ –ø–æ—Ç–æ–∫–æ–≤ –ø–æ—Å–ª–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
    
    const promises: Promise<void>[] = [];
    
    –∞—É–¥–∏–æ_refs.current.forEach((–∞—É–¥–∏–æ, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id) => {
      if (–∞—É–¥–∏–æ.srcObject) {
        console.log(`[Audio] –°–æ—Å—Ç–æ—è–Ω–∏–µ –∞—É–¥–∏–æ –¥–ª—è ${–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id}:`, {
          paused: –∞—É–¥–∏–æ.paused,
          muted: –∞—É–¥–∏–æ.muted,
          volume: –∞—É–¥–∏–æ.volume,
          readyState: –∞—É–¥–∏–æ.readyState,
          networkState: –∞—É–¥–∏–æ.networkState,
          currentTime: –∞—É–¥–∏–æ.currentTime,
          hasStreamSource: !!–∞—É–¥–∏–æ.srcObject
        });
        
        const playPromise = –∞—É–¥–∏–æ.play().then(() => {
          console.log(`[Audio] ‚úÖ –£—Å–ø–µ—à–Ω–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω –ø–æ—Ç–æ–∫ –¥–ª—è ${–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id}`);
        }).catch(error => {
          console.error(`[Audio] ‚ùå –û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –¥–ª—è ${–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id}:`, error);
          
          // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
          console.error(`[Audio] –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –æ—à–∏–±–∫–∏ –¥–ª—è ${–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id}:`, {
            errorName: error.name,
            errorMessage: error.message,
            audioState: {
              paused: –∞—É–¥–∏–æ.paused,
              muted: –∞—É–¥–∏–æ.muted,
              readyState: –∞—É–¥–∏–æ.readyState,
              networkState: –∞—É–¥–∏–æ.networkState,
              src: –∞—É–¥–∏–æ.src,
              srcObject: !!–∞—É–¥–∏–æ.srcObject
            }
          });
        });
        
        promises.push(playPromise);
      } else {
        console.warn(`[Audio] –ù–µ—Ç srcObject –¥–ª—è ${–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id}, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º`);
      }
    });
    
    try {
      await Promise.allSettled(promises);
      set–¢—Ä–µ–±—É–µ—Ç—Å—è_–≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ(false);
      console.log('[Audio] –ó–∞–≤–µ—Ä—à–µ–Ω–∞ –ø–æ–ø—ã—Ç–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –≤—Å–µ—Ö –∞—É–¥–∏–æ –ø–æ—Ç–æ–∫–æ–≤');
    } catch (error) {
      console.error('[Audio] –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–∏ –∞—É–¥–∏–æ –ø–æ—Ç–æ–∫–æ–≤:', error);
    }
  };

  // –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∞—É–¥–∏–æ –æ—Ç –¥—Ä—É–≥–∏—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
  useEffect(() => {
    –∞—É–¥–∏–æ_–ø–æ—Ç–æ–∫–∏.forEach((–ø–æ—Ç–æ–∫, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id) => {
      if (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id === —Ç–µ–∫—É—â–∏–π_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.id) return;

      let –∞—É–¥–∏–æ = –∞—É–¥–∏–æ_refs.current.get(–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id);
      
      if (!–∞—É–¥–∏–æ) {
        console.log(`[Audio] –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ audio —ç–ª–µ–º–µ–Ω—Ç–∞ –¥–ª—è ${–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id}`);
        –∞—É–¥–∏–æ = new Audio();
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –ª—É—á—à–µ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
        –∞—É–¥–∏–æ.autoplay = true;
        –∞—É–¥–∏–æ.playsInline = true; // –í–∞–∂–Ω–æ –¥–ª—è iOS Safari
        –∞—É–¥–∏–æ.volume = 1.0;
        –∞—É–¥–∏–æ.muted = false;
        –∞—É–¥–∏–æ.controls = false;
        
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∞—Ç—Ä–∏–±—É—Ç—ã –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
        (–∞—É–¥–∏–æ as any).webkitPlaysInline = true; // –°—Ç–∞—Ä—ã–µ –≤–µ—Ä—Å–∏–∏ iOS
        (–∞—É–¥–∏–æ as any).playsinline = true; // React/JSX —Å—Ç–∏–ª—å
        
        –∞—É–¥–∏–æ_refs.current.set(–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id, –∞—É–¥–∏–æ);
        
        // –†–ê–°–®–ò–†–ï–ù–ù–ê–Ø –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π –∞—É–¥–∏–æ
        –∞—É–¥–∏–æ.addEventListener('error', (e) => {
          console.error(`[Audio] –û—à–∏–±–∫–∞ —ç–ª–µ–º–µ–Ω—Ç–∞ –∞—É–¥–∏–æ –¥–ª—è ${–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id}:`, {
            error: e,
            currentSrc: –∞—É–¥–∏–æ.currentSrc,
            networkState: –∞—É–¥–∏–æ.networkState,
            readyState: –∞—É–¥–∏–æ.readyState,
            srcObject: !!–∞—É–¥–∏–æ.srcObject
          });
        });
        
        –∞—É–¥–∏–æ.addEventListener('abort', () => {
          console.log(`[Audio] –ó–∞–≥—Ä—É–∑–∫–∞ –∞—É–¥–∏–æ –ø—Ä–µ—Ä–≤–∞–Ω–∞ –¥–ª—è ${–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id}`);
        });
        
        –∞—É–¥–∏–æ.addEventListener('stalled', () => {
          console.warn(`[Audio] –ó–∞–≥—Ä—É–∑–∫–∞ –∞—É–¥–∏–æ –∑–∞—Å—Ç—Ä—è–ª–∞ –¥–ª—è ${–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id}`);
        });
        
        –∞—É–¥–∏–æ.addEventListener('suspend', () => {
          console.log(`[Audio] –ó–∞–≥—Ä—É–∑–∫–∞ –∞—É–¥–∏–æ –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –¥–ª—è ${–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id}`);
        });
        
        –∞—É–¥–∏–æ.addEventListener('waiting', () => {
          console.log(`[Audio] –ê—É–¥–∏–æ –æ–∂–∏–¥–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –¥–ª—è ${–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id}`);
        });
        
        –∞—É–¥–∏–æ.addEventListener('emptied', () => {
          console.log(`[Audio] –ê—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç –æ—á–∏—â–µ–Ω –¥–ª—è ${–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id}`);
        });
      }

      if (–∞—É–¥–∏–æ.srcObject !== –ø–æ—Ç–æ–∫) {
        console.log(`[Audio] –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ—Ç–æ–∫–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id}`, {
          —Ç—Ä–µ–∫–∏: –ø–æ—Ç–æ–∫.getTracks().map(t => ({
            –≤–∏–¥: t.kind,
            –≤–∫–ª—é—á–µ–Ω: t.enabled,
            readyState: t.readyState,
            muted: t.muted,
            id: t.id
          })),
          –∞–∫—Ç–∏–≤–µ–Ω: –ø–æ—Ç–æ–∫.active
        });
        –∞—É–¥–∏–æ.srcObject = –ø–æ—Ç–æ–∫;
        
        // –ö–†–ò–¢–ò–ß–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∞—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç–∞
        console.log(`[Audio] –°–æ—Å—Ç–æ—è–Ω–∏–µ –∞—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç–∞:`, {
          paused: –∞—É–¥–∏–æ.paused,
          muted: –∞—É–¥–∏–æ.muted,
          volume: –∞—É–¥–∏–æ.volume,
          srcObject: !!–∞—É–¥–∏–æ.srcObject,
          readyState: –∞—É–¥–∏–æ.readyState
        });
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        –∞—É–¥–∏–æ.addEventListener('loadedmetadata', () => {
          console.log(`[Audio] –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–ª—è ${–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id}`);
        });
        
        –∞—É–¥–∏–æ.addEventListener('canplay', () => {
          console.log(`[Audio] –ê—É–¥–∏–æ –≥–æ—Ç–æ–≤–æ –∫ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—é –¥–ª—è ${–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id}`);
        });
        
        –∞—É–¥–∏–æ.addEventListener('playing', () => {
          console.log(`[Audio] üîä –ê—É–¥–∏–æ –∏–≥—Ä–∞–µ—Ç –¥–ª—è ${–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id}`);
        });
        
        –∞—É–¥–∏–æ.addEventListener('pause', () => {
          console.log(`[Audio] ‚è∏Ô∏è –ê—É–¥–∏–æ –Ω–∞ –ø–∞—É–∑–µ –¥–ª—è ${–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id}`);
        });
        
        // –£–õ–£–ß–®–ï–ù–ù–ê–Ø –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∞—É–¥–∏–æ —Å —É—á–µ—Ç–æ–º –≤—Å–µ—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
        const –ø–æ–ø—ã—Ç–∞—Ç—å—Å—è_–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ = async () => {
          try {
            // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ srcObject –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
            if (!–∞—É–¥–∏–æ.srcObject) {
              console.warn(`[Audio] –ù–µ—Ç srcObject –¥–ª—è ${–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id}, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ`);
              return;
            }
            
            // –û–∂–∏–¥–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
            if (–∞—É–¥–∏–æ.readyState < 2) {
              await new Promise((resolve, reject) => {
                const timeout = setTimeout(() => reject(new Error('Timeout waiting for metadata')), 5000);
                –∞—É–¥–∏–æ.addEventListener('loadedmetadata', () => {
                  clearTimeout(timeout);
                  resolve(null);
                }, { once: true });
              });
            }
            
            await –∞—É–¥–∏–æ.play();
            console.log(`[Audio] ‚úÖ –ê—É–¥–∏–æ —É—Å–ø–µ—à–Ω–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è –¥–ª—è ${–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id}`);
            set–¢—Ä–µ–±—É–µ—Ç—Å—è_–≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ(false);
          } catch (error: any) {
            console.error(`[Audio] ‚ùå –û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –¥–ª—è ${–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id}:`, error);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø –æ—à–∏–±–∫–∏ autoplay
            if (error.name === 'NotAllowedError' || error.message.includes('autoplay')) {
              console.log('[Audio] –ü–æ–ª–∏—Ç–∏–∫–∞ autoplay –±–ª–æ–∫–∏—Ä—É–µ—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ, —Ç—Ä–µ–±—É–µ—Ç—Å—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ');
              set–¢—Ä–µ–±—É–µ—Ç—Å—è_–≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ(true);
              
              // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏ –ø–æ—Å–ª–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
              const –æ–±—Ä–∞–±–æ—Ç—á–∏–∫_–≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è = async (event: Event) => {
                console.log(`[Audio] –ü–æ–ª—É—á–µ–Ω–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ (${event.type}), –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è`);
                try {
                  await –∞—É–¥–∏–æ.play();
                  console.log(`[Audio] ‚úÖ –ê—É–¥–∏–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è –ø–æ—Å–ª–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –¥–ª—è ${–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id}`);
                  set–¢—Ä–µ–±—É–µ—Ç—Å—è_–≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ(false);
                  
                  // –£–¥–∞–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
                  document.removeEventListener('click', –æ–±—Ä–∞–±–æ—Ç—á–∏–∫_–≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è);
                  document.removeEventListener('touchstart', –æ–±—Ä–∞–±–æ—Ç—á–∏–∫_–≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è);
                  document.removeEventListener('keydown', –æ–±—Ä–∞–±–æ—Ç—á–∏–∫_–≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è);
                } catch (retryError) {
                  console.error(`[Audio] ‚ùå –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –æ—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è:`, retryError);
                }
              };
              
              // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
              document.addEventListener('click', –æ–±—Ä–∞–±–æ—Ç—á–∏–∫_–≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è, { once: true });
              document.addEventListener('touchstart', –æ–±—Ä–∞–±–æ—Ç—á–∏–∫_–≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è, { once: true });
              document.addEventListener('keydown', –æ–±—Ä–∞–±–æ—Ç—á–∏–∫_–≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è, { once: true });
            } else {
              console.error(`[Audio] –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è:`, error);
            }
          }
        };
        
        –ø–æ–ø—ã—Ç–∞—Ç—å—Å—è_–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏();
      }
    });

    // –£–¥–∞–ª—è–µ–º –∞—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –æ—Ç–∫–ª—é—á–∏–≤—à–∏—Ö—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    –∞—É–¥–∏–æ_refs.current.forEach((–∞—É–¥–∏–æ, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id) => {
      if (!–∞—É–¥–∏–æ_–ø–æ—Ç–æ–∫–∏.has(–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id)) {
        –∞—É–¥–∏–æ.srcObject = null;
        –∞—É–¥–∏–æ_refs.current.delete(–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id);
      }
    });
  }, [–∞—É–¥–∏–æ_–ø–æ—Ç–æ–∫–∏, —Ç–µ–∫—É—â–∏–π_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.id]);

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö –ø–æ—Ç–æ–∫–æ–≤
  useEffect(() => {
    set–£–¥–∞–ª–µ–Ω–Ω—ã–π_–ø–æ—Ç–æ–∫_–æ–±—Ä–∞–±–æ—Ç—á–∏–∫(() => (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id: string, –ø–æ—Ç–æ–∫: MediaStream) => {
      // –ü–æ–ª—É—á–µ–Ω —É–¥–∞–ª–µ–Ω–Ω—ã–π –ø–æ—Ç–æ–∫
      console.log(`[SimpleVoiceRoom] –ü–æ–ª—É—á–µ–Ω —É–¥–∞–ª–µ–Ω–Ω—ã–π –ø–æ—Ç–æ–∫ –æ—Ç ${–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id}`, {
        —Ç—Ä–µ–∫–∏: –ø–æ—Ç–æ–∫.getTracks().map(t => ({
          –≤–∏–¥: t.kind,
          –≤–∫–ª—é—á–µ–Ω: t.enabled,
          id: t.id,
          muted: t.muted,
          readyState: t.readyState
        }))
      });
      set–ê—É–¥–∏–æ_–ø–æ—Ç–æ–∫–∏(prev => new Map(prev).set(–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id, –ø–æ—Ç–æ–∫));
    });

    set–û—Ç–∫–ª—é—á–µ–Ω–∏–µ_–æ–±—Ä–∞–±–æ—Ç—á–∏–∫(() => (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id: string) => {
      // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫–ª—é—á–∏–ª—Å—è
      console.log(`[SimpleVoiceRoom] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id} –æ—Ç–∫–ª—é—á–∏–ª—Å—è`);
      set–ê—É–¥–∏–æ_–ø–æ—Ç–æ–∫–∏(prev => {
        const –Ω–æ–≤—ã–µ_–ø–æ—Ç–æ–∫–∏ = new Map(prev);
        –Ω–æ–≤—ã–µ_–ø–æ—Ç–æ–∫–∏.delete(–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id);
        return –Ω–æ–≤—ã–µ_–ø–æ—Ç–æ–∫–∏;
      });
    });
  }, []);

  // –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∞—É–¥–∏–æ –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ü–∏–∏ —Ä–µ—á–∏ (AudioWorklet)
  useVoiceAnalyzer({
    –ø–æ—Ç–æ–∫: –ª–æ–∫–∞–ª—å–Ω—ã–π_–ø–æ—Ç–æ–∫,
    –º–∏–∫—Ä–æ—Ñ–æ–Ω_–≤–∫–ª—é—á–µ–Ω,
    –Ω–∞_–∏–∑–º–µ–Ω–µ–Ω–∏–µ_—Ä–µ—á–∏: (–≥–æ–≤–æ—Ä–∏—Ç: boolean) => {
      if (–≥–æ–≤–æ—Ä–∏—Ç && !–≥–æ–≤–æ—Ä—è—â–∏–µ_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏.has(—Ç–µ–∫—É—â–∏–π_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.id)) {
        socket?.—É–≤–µ–¥–æ–º–∏—Ç—å_–æ_—Ä–µ—á–∏?.(true, –∫–æ–º–Ω–∞—Ç–∞.id);
        set–ì–æ–≤–æ—Ä—è—â–∏–µ_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏(prev => new Set(prev).add(—Ç–µ–∫—É—â–∏–π_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.id));
      } else if (!–≥–æ–≤–æ—Ä–∏—Ç && –≥–æ–≤–æ—Ä—è—â–∏–µ_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏.has(—Ç–µ–∫—É—â–∏–π_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.id)) {
        socket?.—É–≤–µ–¥–æ–º–∏—Ç—å_–æ_—Ä–µ—á–∏?.(false, –∫–æ–º–Ω–∞—Ç–∞.id);
        set–ì–æ–≤–æ—Ä—è—â–∏–µ_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏(prev => {
          const –Ω–æ–≤—ã–µ = new Set(prev);
          –Ω–æ–≤—ã–µ.delete(—Ç–µ–∫—É—â–∏–π_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.id);
          return –Ω–æ–≤—ã–µ;
        });
      }
    },
    –ø–æ—Ä–æ–≥_—Ä–µ—á–∏: 30
  });

  // –ü–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —Å–æ–±—ã—Ç–∏—è WebSocket
  useEffect(() => {
    if (!socket) return;

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∫–æ–º–Ω–∞—Ç—ã
    const unsubscribe1 = –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è('—É—á–∞—Å—Ç–Ω–∏–∫–∏-–∫–æ–º–Ω–∞—Ç—ã-–æ–±–Ω–æ–≤–ª–µ–Ω—ã', (–¥–∞–Ω–Ω—ã–µ: any) => {
      if (–¥–∞–Ω–Ω—ã–µ.–∫–æ–º–Ω–∞—Ç–∞_id === –∫–æ–º–Ω–∞—Ç–∞.id) {
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
        
        // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —É—á–µ—Ç–æ–º –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
        const –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ_—É—á–∞—Å—Ç–Ω–∏–∫–∏ = –¥–∞–Ω–Ω—ã–µ.—É—á–∞—Å—Ç–Ω–∏–∫–∏.map((—É—á–∞—Å—Ç–Ω–∏–∫: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å) => {
          if (—É—á–∞—Å—Ç–Ω–∏–∫.id === —Ç–µ–∫—É—â–∏–π_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.id) {
            // –î–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
            return {
              ...—É—á–∞—Å—Ç–Ω–∏–∫,
              –º–∏–∫—Ä–æ—Ñ–æ–Ω_–≤–∫–ª—é—á–µ–Ω: –º–∏–∫—Ä–æ—Ñ–æ–Ω_–≤–∫–ª—é—á–µ–Ω
            };
          }
          return —É—á–∞—Å—Ç–Ω–∏–∫;
        });
        
        set–£—á–∞—Å—Ç–Ω–∏–∫–∏(–æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ_—É—á–∞—Å—Ç–Ω–∏–∫–∏);
        
        // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –Ω–æ–≤—ã–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –µ—Å—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫
        if (–ª–æ–∫–∞–ª—å–Ω—ã–π_–ø–æ—Ç–æ–∫) {
          –¥–∞–Ω–Ω—ã–µ.—É—á–∞—Å—Ç–Ω–∏–∫–∏.forEach((—É—á–∞—Å—Ç–Ω–∏–∫: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å) => {
            if (—É—á–∞—Å—Ç–Ω–∏–∫.id !== —Ç–µ–∫—É—â–∏–π_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.id) {
              console.log(`[SimpleVoiceRoom] –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —É—á–∞—Å—Ç–Ω–∏–∫—É ${—É—á–∞—Å—Ç–Ω–∏–∫.id}`);
              –±–µ–∑–æ–ø–∞—Å–Ω–æ_–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è_–∫_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é(—É—á–∞—Å—Ç–Ω–∏–∫.id);
            }
          });
        } else {
          console.log(`[SimpleVoiceRoom] üîÑ –û—Ç–ª–æ–∂–µ–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º - –∂–¥–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫`);
        }
      }
    });

    // –ö–†–ò–¢–ò–ß–ù–û: –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const unsubscribe2 = –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è('–ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è-–∫-–∫–æ–º–Ω–∞—Ç–µ', (–¥–∞–Ω–Ω—ã–µ: any) => {
      if (–¥–∞–Ω–Ω—ã–µ.–∫–æ–º–Ω–∞—Ç–∞?.id === –∫–æ–º–Ω–∞—Ç–∞.id && –¥–∞–Ω–Ω—ã–µ.–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å?.id !== —Ç–µ–∫—É—â–∏–π_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.id) {
        console.log(`[SimpleVoiceRoom] –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è: ${–¥–∞–Ω–Ω—ã–µ.–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.–∏–º—è}`);
        
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–ø–∏—Å–æ–∫
        set–£—á–∞—Å—Ç–Ω–∏–∫–∏(prev => {
          const —Å—É—â–µ—Å—Ç–≤—É–µ—Ç = prev.some(—É => —É.id === –¥–∞–Ω–Ω—ã–µ.–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.id);
          if (!—Å—É—â–µ—Å—Ç–≤—É–µ—Ç) {
            return [...prev, –¥–∞–Ω–Ω—ã–µ.–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å];
          }
          return prev;
        });
        
        // –ò–Ω–∏—Ü–∏–∏—Ä—É–µ–º WebRTC —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –Ω–æ–≤—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
        setTimeout(() => {
          console.log(`[SimpleVoiceRoom] –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –Ω–æ–≤–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${–¥–∞–Ω–Ω—ã–µ.–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.id}`);
          –±–µ–∑–æ–ø–∞—Å–Ω–æ_–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è_–∫_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é(–¥–∞–Ω–Ω—ã–µ.–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.id);
        }, 1000); // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏
      }
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const unsubscribe3 = –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è('–ø–æ–∫–∏–Ω—É–ª-–∫–æ–º–Ω–∞—Ç—É', (–¥–∞–Ω–Ω—ã–µ: any) => {
      if (–¥–∞–Ω–Ω—ã–µ.–∫–æ–º–Ω–∞—Ç–∞_id === –∫–æ–º–Ω–∞—Ç–∞.id) {
        console.log(`[SimpleVoiceRoom] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–∫–∏–Ω—É–ª –∫–æ–º–Ω–∞—Ç—É: ${–¥–∞–Ω–Ω—ã–µ.–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id}`);
        
        // –£–¥–∞–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Å–ø–∏—Å–∫–∞
        set–£—á–∞—Å—Ç–Ω–∏–∫–∏(prev => prev.filter(—É => —É.id !== –¥–∞–Ω–Ω—ã–µ.–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id));
        
        // –£–¥–∞–ª—è–µ–º WebRTC —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
        —É–¥–∞–ª–∏—Ç—å_peer(–¥–∞–Ω–Ω—ã–µ.–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id);
      }
    });

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
    const unsubscribe4 = –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è('–º–∏–∫—Ä–æ—Ñ–æ–Ω-–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω', (–¥–∞–Ω–Ω—ã–µ: any) => {
      if (–¥–∞–Ω–Ω—ã–µ.–∫–æ–º–Ω–∞—Ç–∞_id === –∫–æ–º–Ω–∞—Ç–∞.id && –¥–∞–Ω–Ω—ã–µ.–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id !== —Ç–µ–∫—É—â–∏–π_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.id) {
        set–£—á–∞—Å—Ç–Ω–∏–∫–∏(prev => prev.map(—É => 
          —É.id === –¥–∞–Ω–Ω—ã–µ.–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id 
            ? { ...—É, –º–∏–∫—Ä–æ—Ñ–æ–Ω_–≤–∫–ª—é—á–µ–Ω: –¥–∞–Ω–Ω—ã–µ.–≤–∫–ª—é—á–µ–Ω }
            : —É
        ));
      }
    });

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ü–∏–∏ —Ä–µ—á–∏
    const unsubscribe5 = –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è('–≥–æ–≤–æ—Ä–∏—Ç', (–¥–∞–Ω–Ω—ã–µ: any) => {
      if (–¥–∞–Ω–Ω—ã–µ.–∫–æ–º–Ω–∞—Ç–∞_id === –∫–æ–º–Ω–∞—Ç–∞.id) {
        if (–¥–∞–Ω–Ω—ã–µ.–≥–æ–≤–æ—Ä–∏—Ç) {
          set–ì–æ–≤–æ—Ä—è—â–∏–µ_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏(prev => new Set(prev).add(–¥–∞–Ω–Ω—ã–µ.–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id));
        } else {
          set–ì–æ–≤–æ—Ä—è—â–∏–µ_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏(prev => {
            const –Ω–æ–≤—ã–µ = new Set(prev);
            –Ω–æ–≤—ã–µ.delete(–¥–∞–Ω–Ω—ã–µ.–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id);
            return –Ω–æ–≤—ã–µ;
          });
        }
      }
    });

    return () => {
      unsubscribe1();
      unsubscribe2();
      unsubscribe3();
      unsubscribe4();
      unsubscribe5();
    };
  }, [socket, –∫–æ–º–Ω–∞—Ç–∞.id, —Ç–µ–∫—É—â–∏–π_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.id, –±–µ–∑–æ–ø–∞—Å–Ω–æ_–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è_–∫_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è, –º–∏–∫—Ä–æ—Ñ–æ–Ω_–≤–∫–ª—é—á–µ–Ω, —É–¥–∞–ª–∏—Ç—å_peer]);

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ WebRTC –ø—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
  useEffect(() => {
    const –ø—Ä–æ–≤–µ—Ä–∏—Ç—å_—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å = async () => {
      console.log('[SimpleVoiceRoom] üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ WebRTC...');
      
      try {
        const capabilities = await checkWebRTCCapabilities();
        const browserInfo = getBrowserInfo();
        const recommendedSettings = getRecommendedSettings(browserInfo);
        
        console.log('[SimpleVoiceRoom] –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ WebRTC:', {
          browser: browserInfo,
          capabilities,
          recommendedSettings
        });
        
        setWebrtc_–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞({
          —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å_–ø—Ä–æ–≤–µ—Ä–µ–Ω–∞: true,
          –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è: capabilities.supported,
          –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è: [...capabilities.errors, ...capabilities.warnings],
          —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏: capabilities.recommendations
        });
        
        if (!capabilities.supported) {
          console.error('[SimpleVoiceRoom] ‚ùå WebRTC –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ –¥–∞–Ω–Ω–æ–º –±—Ä–∞—É–∑–µ—Ä–µ');
          set–û—à–∏–±–∫–∞('WebRTC –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å –±—Ä–∞—É–∑–µ—Ä –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Chrome/Firefox.');
          return;
        }
        
        if (capabilities.warnings.length > 0) {
          console.warn('[SimpleVoiceRoom] ‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è WebRTC:', capabilities.warnings);
        }
        
      } catch (error) {
        console.error('[SimpleVoiceRoom] ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏:', error);
        setWebrtc_–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞(prev => ({
          ...prev,
          —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å_–ø—Ä–æ–≤–µ—Ä–µ–Ω–∞: true,
          –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è: ['–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å WebRTC']
        }));
      }
    };
    
    –ø—Ä–æ–≤–µ—Ä–∏—Ç—å_—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å();
  }, []);

  // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –û–¥–Ω–æ–∫—Ä–∞—Ç–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –±–µ–∑ –ª–∏—à–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
  useEffect(() => {
    let –æ—Ç–º–µ–Ω–µ–Ω–æ = false;
    
    const –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å_–º–∏–∫—Ä–æ—Ñ–æ–Ω = async () => {
      if (!webrtc_–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞.–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è || –ª–æ–∫–∞–ª—å–Ω—ã–π_–ø–æ—Ç–æ–∫ || —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è_–ø—Ä–æ–≤–µ—Ä–µ–Ω—ã) {
        return;
      }
      
      console.log('[SimpleVoiceRoom] üöÄ –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ú–ò–ö–†–û–§–û–ù–ê');
      
      try {
        const –ø–æ—Ç–æ–∫ = await –ø–æ–ª—É—á–∏—Ç—å_–º–∏–∫—Ä–æ—Ñ–æ–Ω();
        
        if (!–æ—Ç–º–µ–Ω–µ–Ω–æ) {
          console.log('[SimpleVoiceRoom] ‚úÖ –ú–∏–∫—Ä–æ—Ñ–æ–Ω –ø–æ–ª—É—á–µ–Ω —É—Å–ø–µ—à–Ω–æ');
          set–†–∞–∑—Ä–µ—à–µ–Ω–∏—è_–ø—Ä–æ–≤–µ—Ä–µ–Ω—ã(true);
        }
      } catch (error) {
        if (!–æ—Ç–º–µ–Ω–µ–Ω–æ) {
          console.error('[SimpleVoiceRoom] ‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞:', error);
          set–ü–æ–∫–∞–∑–∞—Ç—å_—Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è(true);
        }
      }
    };
    
    if (webrtc_–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞.—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å_–ø—Ä–æ–≤–µ—Ä–µ–Ω–∞) {
      –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å_–º–∏–∫—Ä–æ—Ñ–æ–Ω();
    }
    
    return () => {
      –æ—Ç–º–µ–Ω–µ–Ω–æ = true;
      console.log(`[SimpleVoiceRoom] üßπ –†–ê–ó–ú–û–ù–¢–ò–†–û–í–ê–ù–ò–ï SimpleVoiceRoom`);
      –æ—á–∏—Å—Ç–∏—Ç—å();
      –∞—É–¥–∏–æ_refs.current.forEach(audio => {
        audio.srcObject = null;
      });
      –∞—É–¥–∏–æ_refs.current.clear();
    };
  }, []); // –ö–õ–Æ–ß–ï–í–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π!
  
  // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –û—Ç–¥–µ–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –ü–û–°–õ–ï –ø–æ–ª—É—á–µ–Ω–∏—è –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
  useEffect(() => {
    if (–ª–æ–∫–∞–ª—å–Ω—ã–π_–ø–æ—Ç–æ–∫ && socket && socket.–ø–æ–ª—É—á–∏—Ç—å_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π_–∫–æ–º–Ω–∞—Ç—ã) {
      console.log('[SimpleVoiceRoom] üéØ –ú–ò–ö–†–û–§–û–ù –ì–û–¢–û–í - –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∫–æ–º–Ω–∞—Ç—ã');
      socket.–ø–æ–ª—É—á–∏—Ç—å_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π_–∫–æ–º–Ω–∞—Ç—ã(–∫–æ–º–Ω–∞—Ç–∞.id);
    }
  }, [–ª–æ–∫–∞–ª—å–Ω—ã–π_–ø–æ—Ç–æ–∫, socket, –∫–æ–º–Ω–∞—Ç–∞.id]);
  
  // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º –ø—Ä–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
  useEffect(() => {
    if (–ª–æ–∫–∞–ª—å–Ω—ã–π_–ø–æ—Ç–æ–∫ && —É—á–∞—Å—Ç–Ω–∏–∫–∏.length > 1) {
      console.log('[SimpleVoiceRoom] üîó –ê–í–¢–û–ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º');
      —É—á–∞—Å—Ç–Ω–∏–∫–∏.forEach((—É—á–∞—Å—Ç–Ω–∏–∫: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å) => {
        if (—É—á–∞—Å—Ç–Ω–∏–∫.id !== —Ç–µ–∫—É—â–∏–π_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.id) {
          console.log(`[SimpleVoiceRoom] –ê–≤—Ç–æ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —É—á–∞—Å—Ç–Ω–∏–∫—É ${—É—á–∞—Å—Ç–Ω–∏–∫.id}`);
          –±–µ–∑–æ–ø–∞—Å–Ω–æ_–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è_–∫_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é(—É—á–∞—Å—Ç–Ω–∏–∫.id);
        }
      });
    }
  }, [–ª–æ–∫–∞–ª—å–Ω—ã–π_–ø–æ—Ç–æ–∫, —É—á–∞—Å—Ç–Ω–∏–∫–∏, —Ç–µ–∫—É—â–∏–π_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.id, –±–µ–∑–æ–ø–∞—Å–Ω–æ_–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è_–∫_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é]);

  // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞
  useEffect(() => {
    console.log(`[SimpleVoiceRoom] üîÑ –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞:`, {
      –µ—Å—Ç—å_–ø–æ—Ç–æ–∫: !!–ª–æ–∫–∞–ª—å–Ω—ã–π_–ø–æ—Ç–æ–∫,
      —Ç—Ä–µ–∫–∏: –ª–æ–∫–∞–ª—å–Ω—ã–π_–ø–æ—Ç–æ–∫?.getTracks().length || 0,
      –∞–∫—Ç–∏–≤–µ–Ω: –ª–æ–∫–∞–ª—å–Ω—ã–π_–ø–æ—Ç–æ–∫?.active,
      –¥–µ—Ç–∞–ª–∏_—Ç—Ä–µ–∫–æ–≤: –ª–æ–∫–∞–ª—å–Ω—ã–π_–ø–æ—Ç–æ–∫?.getTracks().map(t => ({
        –≤–∏–¥: t.kind,
        –≤–∫–ª—é—á–µ–Ω: t.enabled,
        –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å: t.readyState,
        id: t.id
      }))
    });
  }, [–ª–æ–∫–∞–ª—å–Ω—ã–π_–ø–æ—Ç–æ–∫]);

  if (–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è) {
    return (
      <div className="min-h-screen bg-[var(--bg-primary)] flex items-center justify-center">
        <div className="text-[var(--text-secondary)]">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–µ...</div>
      </div>
    );
  }

  if (–æ—à–∏–±–∫–∞) {
    return (
      <MicrophoneError
        –æ—à–∏–±–∫–∞={–æ—à–∏–±–∫–∞}
        –Ω–∞_–ø–æ–≤—Ç–æ—Ä–∏—Ç—å={() => {
          set–û—à–∏–±–∫–∞(null);
          –ø–æ–ª—É—á–∏—Ç—å_–º–∏–∫—Ä–æ—Ñ–æ–Ω().catch(error => {
            console.error('[SimpleVoiceRoom] –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –æ—à–∏–±–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞:', error);
          });
        }}
        –Ω–∞_–ø–æ–∫–∞–∑–∞—Ç—å_—Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è={() => set–ü–æ–∫–∞–∑–∞—Ç—å_—Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è(true)}
        –Ω–∞_–ø–æ–∫–∏–Ω—É—Ç—å={–Ω–∞_–ø–æ–∫–∏–Ω—É—Ç—å_–∫–æ–º–Ω–∞—Ç—É}
      />
    );
  }

  return (
    <div className="min-h-screen bg-[var(--bg-primary)]">
      {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–æ–º–Ω–∞—Ç—ã */}
      <header className="border-b border-[var(--border-color)] px-6 py-4">
        <div className="max-w-4xl mx-auto flex items-center justify-between">
          <div>
            <h1 className="text-2xl font-semibold text-[var(--text-primary)]">{–∫–æ–º–Ω–∞—Ç–∞.–Ω–∞–∑–≤–∞–Ω–∏–µ}</h1>
            <p className="text-sm text-[var(--text-secondary)] mt-1 flex items-center gap-1">
              <Users className="w-3.5 h-3.5" />
              {—É—á–∞—Å—Ç–Ω–∏–∫–∏.length} —É—á–∞—Å—Ç–Ω–∏–∫{—É—á–∞—Å—Ç–Ω–∏–∫–∏.length > 1 ? '–æ–≤' : ''}
            </p>
          </div>
          <div className="flex items-center gap-2">
            {/* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π WebRTC */}
            {webrtc_–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞.–ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è.length > 0 && (
              <div className="flex items-center gap-1 px-2 py-1 rounded-lg bg-[var(--warning)] bg-opacity-20" title={webrtc_–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞.–ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è.join('; ')}>
                <AlertTriangle className="w-4 h-4 text-[var(--warning)]" />
                <span className="text-xs text-[var(--warning)]">
                  {webrtc_–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞.–ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è.length} –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ{webrtc_–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞.–ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è.length > 1 ? '—è' : ''}
                </span>
              </div>
            )}

            {/* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å—Ç–∞—Ç—É—Å–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ */}
            <div className="flex items-center gap-2 px-2 py-1 rounded-lg bg-[var(--bg-secondary)]">
              <Mic className={`w-4 h-4 ${
                —Å—Ç–∞—Ç—É—Å_–º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ === '—Ä–∞–∑—Ä–µ—à–µ–Ω–æ' 
                  ? 'text-[var(--success)]' 
                  : —Å—Ç–∞—Ç—É—Å_–º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ === '–æ—Ç–∫–ª–æ–Ω–µ–Ω–æ'
                  ? 'text-[var(--danger)]'
                  : 'text-[var(--text-tertiary)]'
              }`} />
              <span className={`text-xs ${
                —Å—Ç–∞—Ç—É—Å_–º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ === '—Ä–∞–∑—Ä–µ—à–µ–Ω–æ' 
                  ? 'text-[var(--success)]' 
                  : —Å—Ç–∞—Ç—É—Å_–º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ === '–æ—Ç–∫–ª–æ–Ω–µ–Ω–æ'
                  ? 'text-[var(--danger)]'
                  : 'text-[var(--text-tertiary)]'
              }`}>
                {—Å—Ç–∞—Ç—É—Å_–º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ === '—Ä–∞–∑—Ä–µ—à–µ–Ω–æ' ? '–†–∞–∑—Ä–µ—à–µ–Ω–æ' : 
                 —Å—Ç–∞—Ç—É—Å_–º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ === '–æ—Ç–∫–ª–æ–Ω–µ–Ω–æ' ? '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ' :
                 —Å—Ç–∞—Ç—É—Å_–º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ === '–∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç—Å—è' ? '–ó–∞–ø—Ä–æ—Å...' : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}
              </span>
            </div>

            {–Ω–∞_–æ—Ç–∫—Ä—ã—Ç—å_–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ && (
              <button
                onClick={–Ω–∞_–æ—Ç–∫—Ä—ã—Ç—å_–Ω–∞—Å—Ç—Ä–æ–π–∫–∏}
                className="p-2 hover:bg-[var(--bg-hover)] rounded-lg transition-colors"
                title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏"
              >
                <svg className="w-5 h-5 text-[var(--text-secondary)] hover:text-[var(--text-primary)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
              </button>
            )}
            <button
              onClick={–Ω–∞_–ø–æ–∫–∏–Ω—É—Ç—å_–∫–æ–º–Ω–∞—Ç—É}
              className="px-4 py-2 text-[var(--danger)] hover:bg-[var(--bg-hover)] rounded-lg transition-colors flex items-center gap-2"
            >
              <PhoneOff className="w-4 h-4" />
              –ü–æ–∫–∏–Ω—É—Ç—å
            </button>
          </div>
        </div>
      </header>

      {/* –°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ */}
      <div className="max-w-4xl mx-auto px-6 py-6">
        <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
          {—É—á–∞—Å—Ç–Ω–∏–∫–∏.map(—É—á–∞—Å—Ç–Ω–∏–∫ => (
            <div
              key={—É—á–∞—Å—Ç–Ω–∏–∫.id}
              className={`
                p-4 rounded-lg border transition-all duration-200
                ${–≥–æ–≤–æ—Ä—è—â–∏–µ_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏.has(—É—á–∞—Å—Ç–Ω–∏–∫.id) 
                  ? 'border-[var(--accent)] bg-[var(--bg-secondary)]' 
                  : 'border-[var(--border-color)] bg-[var(--bg-primary)]'
                }
              `}
            >
              <div className="flex flex-col items-center text-center">
                <div className={`
                  w-16 h-16 rounded-full flex items-center justify-center mb-3
                  ${–≥–æ–≤–æ—Ä—è—â–∏–µ_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏.has(—É—á–∞—Å—Ç–Ω–∏–∫.id)
                    ? 'bg-[var(--accent)] text-white'
                    : 'bg-[var(--bg-hover)] text-[var(--text-secondary)]'
                  }
                `}>
                  {—É—á–∞—Å—Ç–Ω–∏–∫.–∏–º—è.charAt(0).toUpperCase()}
                </div>
                <div className="font-medium text-[var(--text-primary)] mb-1">
                  {—É—á–∞—Å—Ç–Ω–∏–∫.–∏–º—è}
                  {—É—á–∞—Å—Ç–Ω–∏–∫.id === —Ç–µ–∫—É—â–∏–π_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.id && ' (–í—ã)'}
                </div>
                <div className="flex items-center gap-2">
                  {—É—á–∞—Å—Ç–Ω–∏–∫.–º–∏–∫—Ä–æ—Ñ–æ–Ω_–≤–∫–ª—é—á–µ–Ω ? (
                    <Mic className="w-4 h-4 text-[var(--text-secondary)]" />
                  ) : (
                    <MicOff className="w-4 h-4 text-[var(--danger)]" />
                  )}
                  {–≥–æ–≤–æ—Ä—è—â–∏–µ_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏.has(—É—á–∞—Å—Ç–Ω–∏–∫.id) && (
                    <Volume2 className="w-4 h-4 text-[var(--accent)] animate-pulse" />
                  )}
                </div>
              </div>
            </div>
          ))}
        </div>
      </div>

      {/* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è */}
      {—Ç—Ä–µ–±—É–µ—Ç—Å—è_–≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ && (
        <div className="fixed top-20 left-1/2 transform -translate-x-1/2 bg-[var(--warning)] text-white px-6 py-3 rounded-lg shadow-lg z-50">
          <div className="flex items-center gap-3">
            <span>üîä –ù–∞–∂–º–∏—Ç–µ –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è –∑–≤—É–∫–∞</span>
            <button
              onClick={–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏_–≤—Å–µ_–∞—É–¥–∏–æ}
              className="px-4 py-1 bg-white text-[var(--warning)] rounded hover:bg-gray-100 transition-colors"
            >
              –í–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫
            </button>
          </div>
        </div>
      )}

      {/* –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */}
      <div className="fixed bottom-0 left-0 right-0 bg-[var(--bg-primary)] border-t border-[var(--border-color)]">
        <div className="max-w-4xl mx-auto px-6 py-4">
          <div className="flex items-center justify-between">
            {/* –°—Ç–∞—Ç—É—Å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è */}
            <div className="flex-1">
              <ICEStatus 
                –ø–æ–∫–∞–∑–∞—Ç—å_–ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏={false} 
                websocket_–ø–æ–¥–∫–ª—é—á–µ–Ω={socket?.readyState === WebSocket.OPEN}
                socket={socket}
              />
            </div>
            
            {/* –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */}
            <div className="flex items-center gap-4">
            <button
              onClick={–ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å_–º–∏–∫—Ä–æ—Ñ–æ–Ω}
              className={`
                p-3 rounded-full transition-all duration-200
                ${–º–∏–∫—Ä–æ—Ñ–æ–Ω_–≤–∫–ª—é—á–µ–Ω 
                  ? 'bg-[var(--bg-secondary)] text-[var(--text-primary)] hover:bg-[var(--bg-hover)]' 
                  : 'bg-[var(--danger)] text-white hover:opacity-90'
                }
              `}
              title={–º–∏–∫—Ä–æ—Ñ–æ–Ω_–≤–∫–ª—é—á–µ–Ω ? '–í—ã–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω' : '–í–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω'}
            >
              {–º–∏–∫—Ä–æ—Ñ–æ–Ω_–≤–∫–ª—é—á–µ–Ω ? <Mic className="w-5 h-5" /> : <MicOff className="w-5 h-5" />}
            </button>
            
            <div className="flex items-center gap-2 text-sm text-[var(--text-secondary)]">
              <Radio className="w-4 h-4" />
              {–º–∏–∫—Ä–æ—Ñ–æ–Ω_–≤–∫–ª—é—á–µ–Ω ? '–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤–∫–ª—é—á–µ–Ω' : '–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤—ã–∫–ª—é—á–µ–Ω'}
            </div>
            </div>
            
            {/* –ü—É—Å—Ç–æ–µ –º–µ—Å—Ç–æ —Å–ø—Ä–∞–≤–∞ –¥–ª—è –±–∞–ª–∞–Ω—Å–∞ */}
            <div className="flex-1"></div>
          </div>
        </div>
      </div>

      {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∑–∞–ø—Ä–æ—Å–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π */}
      <MediaPermissionModal
        –æ—Ç–∫—Ä—ã—Ç={–ø–æ–∫–∞–∑–∞—Ç—å_—Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è}
        –Ω–∞_–∑–∞–∫—Ä—ã—Ç—å={() => set–ü–æ–∫–∞–∑–∞—Ç—å_—Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è(false)}
        –Ω–∞_—Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ_–ø–æ–ª—É—á–µ–Ω–æ={–æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_—Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ_–ø–æ–ª—É—á–µ–Ω–æ}
        –Ω–∞_—Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ_–æ—Ç–∫–ª–æ–Ω–µ–Ω–æ={–æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_—Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ_–æ—Ç–∫–ª–æ–Ω–µ–Ω–æ}
        —Ç—Ä–µ–±—É–µ—Ç—Å—è_–º–∏–∫—Ä–æ—Ñ–æ–Ω={true}
        —Ç—Ä–µ–±—É–µ—Ç—Å—è_–∫–∞–º–µ—Ä–∞={false}
        –∑–∞–≥–æ–ª–æ–≤–æ–∫="–î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É"
        –æ–ø–∏—Å–∞–Ω–∏–µ="–î–ª—è —É—á–∞—Å—Ç–∏—è –≤ –≥–æ–ª–æ—Å–æ–≤–æ–º –æ–±—â–µ–Ω–∏–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Ä–∞–∑—Ä–µ—à–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É"
      />
    </div>
  );
};