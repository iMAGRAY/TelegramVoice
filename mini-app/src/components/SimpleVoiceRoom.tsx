'use client';

import React, { useState, useEffect, useRef } from 'react';
import { –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –ö–æ–º–Ω–∞—Ç–∞ } from '@/types';
import { useWebRTC } from '@/hooks/useWebRTC';

interface VoiceRoomProps {
  –∫–æ–º–Ω–∞—Ç–∞: –ö–æ–º–Ω–∞—Ç–∞;
  —Ç–µ–∫—É—â–∏–π_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å;
  socket: any;
  –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è: (—Å–æ–±—ã—Ç–∏–µ: string, –æ–±—Ä–∞–±–æ—Ç—á–∏–∫: (...args: any[]) => void) => () => void;
  –Ω–∞_–ø–æ–∫–∏–Ω—É—Ç—å_–∫–æ–º–Ω–∞—Ç—É: () => void;
}

export const SimpleVoiceRoom: React.FC<VoiceRoomProps> = ({
  –∫–æ–º–Ω–∞—Ç–∞,
  —Ç–µ–∫—É—â–∏–π_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å,
  socket,
  –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è,
  –Ω–∞_–ø–æ–∫–∏–Ω—É—Ç—å_–∫–æ–º–Ω–∞—Ç—É
}) => {
  const [—É—á–∞—Å—Ç–Ω–∏–∫–∏, set–£—á–∞—Å—Ç–Ω–∏–∫–∏] = useState<–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å[]>([—Ç–µ–∫—É—â–∏–π_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å]);
  const [–∞—É–¥–∏–æ_–ø–æ—Ç–æ–∫–∏, set–ê—É–¥–∏–æ_–ø–æ—Ç–æ–∫–∏] = useState<Map<string, MediaStream>>(new Map());
  const [–≥–æ–≤–æ—Ä—è—â–∏–µ_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, set–ì–æ–≤–æ—Ä—è—â–∏–µ_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏] = useState<Set<string>>(new Set());
  const –∞—É–¥–∏–æ_refs = useRef<Map<string, HTMLAudioElement>>(new Map());

  // WebRTC —Ö—É–∫
  const {
    –ª–æ–∫–∞–ª—å–Ω—ã–π_–ø–æ—Ç–æ–∫,
    –º–∏–∫—Ä–æ—Ñ–æ–Ω_–≤–∫–ª—é—á–µ–Ω,
    –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è,
    –æ—à–∏–±–∫–∞,
    –ø–æ–ª—É—á–∏—Ç—å_–º–∏–∫—Ä–æ—Ñ–æ–Ω,
    –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è_–∫_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é,
    –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å_–º–∏–∫—Ä–æ—Ñ–æ–Ω,
    –æ—á–∏—Å—Ç–∏—Ç—å
  } = useWebRTC({
    –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id: —Ç–µ–∫—É—â–∏–π_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.id,
    –∫–æ–º–Ω–∞—Ç–∞_id: –∫–æ–º–Ω–∞—Ç–∞.id,
    socket,
    –Ω–∞_–ø–æ–ª—É—á–µ–Ω–∏–µ_–ø–æ—Ç–æ–∫–∞: (–ø–æ—Ç–æ–∫: MediaStream, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id: string) => {
      set–ê—É–¥–∏–æ_–ø–æ—Ç–æ–∫–∏(prev => new Map(prev.set(–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id, –ø–æ—Ç–æ–∫)));
      
      // –°–æ–∑–¥–∞–µ–º –∞—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
      const audio = new Audio();
      audio.srcObject = –ø–æ—Ç–æ–∫;
      audio.autoplay = true;
      audio.volume = 0.8;
      –∞—É–¥–∏–æ_refs.current.set(–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id, audio);
    },
    –Ω–∞_–æ—Ç–∫–ª—é—á–µ–Ω–∏–µ_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id: string) => {
      set–ê—É–¥–∏–æ_–ø–æ—Ç–æ–∫–∏(prev => {
        const –Ω–æ–≤—ã–µ = new Map(prev);
        –Ω–æ–≤—ã–µ.delete(–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id);
        return –Ω–æ–≤—ã–µ;
      });
      
      // –£–¥–∞–ª—è–µ–º –∞—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç
      const audio = –∞—É–¥–∏–æ_refs.current.get(–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id);
      if (audio) {
        audio.pause();
        audio.srcObject = null;
        –∞—É–¥–∏–æ_refs.current.delete(–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id);
      }
    }
  });

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
  const –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ_–º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ = async () => {
    try {
      if (!–ª–æ–∫–∞–ª—å–Ω—ã–π_–ø–æ—Ç–æ–∫) {
        await –ø–æ–ª—É—á–∏—Ç—å_–º–∏–∫—Ä–æ—Ñ–æ–Ω();
      } else {
        –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å_–º–∏–∫—Ä–æ—Ñ–æ–Ω();
      }
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞:', error);
    }
  };

  // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Ä–µ—á–∏
  useEffect(() => {
    if (!–ª–æ–∫–∞–ª—å–Ω—ã–π_–ø–æ—Ç–æ–∫) return;

    const –∞—É–¥–∏–æ_–∫–æ–Ω—Ç–µ–∫—Å—Ç = new AudioContext();
    const –∏—Å—Ç–æ—á–Ω–∏–∫ = –∞—É–¥–∏–æ_–∫–æ–Ω—Ç–µ–∫—Å—Ç.createMediaStreamSource(–ª–æ–∫–∞–ª—å–Ω—ã–π_–ø–æ—Ç–æ–∫);
    const –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä = –∞—É–¥–∏–æ_–∫–æ–Ω—Ç–µ–∫—Å—Ç.createAnalyser();
    
    –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä.fftSize = 256;
    –∏—Å—Ç–æ—á–Ω–∏–∫.connect(–∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä);
    
    const –¥–∞–Ω–Ω—ã–µ = new Uint8Array(–∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä.frequencyBinCount);
    let –≥–æ–≤–æ—Ä–∏—Ç = false;
    
    const –ø—Ä–æ–≤–µ—Ä–∏—Ç—å_—Ä–µ—á—å = () => {
      –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä.getByteFrequencyData(–¥–∞–Ω–Ω—ã–µ);
      const –≥—Ä–æ–º–∫–æ—Å—Ç—å = –¥–∞–Ω–Ω—ã–µ.reduce((a, b) => a + b) / –¥–∞–Ω–Ω—ã–µ.length;
      const –Ω–æ–≤–æ–µ_—Å–æ—Å—Ç–æ—è–Ω–∏–µ = –≥—Ä–æ–º–∫–æ—Å—Ç—å > 50 && –º–∏–∫—Ä–æ—Ñ–æ–Ω_–≤–∫–ª—é—á–µ–Ω;
      
      if (–Ω–æ–≤–æ–µ_—Å–æ—Å—Ç–æ—è–Ω–∏–µ !== –≥–æ–≤–æ—Ä–∏—Ç) {
        –≥–æ–≤–æ—Ä–∏—Ç = –Ω–æ–≤–æ–µ_—Å–æ—Å—Ç–æ—è–Ω–∏–µ;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        set–ì–æ–≤–æ—Ä—è—â–∏–µ_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏(prev => {
          const –Ω–æ–≤—ã–µ = new Set(prev);
          if (–≥–æ–≤–æ—Ä–∏—Ç) {
            –Ω–æ–≤—ã–µ.add(—Ç–µ–∫—É—â–∏–π_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.id);
          } else {
            –Ω–æ–≤—ã–µ.delete(—Ç–µ–∫—É—â–∏–π_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.id);
          }
          return –Ω–æ–≤—ã–µ;
        });
        
        // –£–≤–µ–¥–æ–º–ª—è–µ–º —Å–µ—Ä–≤–µ—Ä
        if (socket && socket.—É–≤–µ–¥–æ–º–∏—Ç—å_–æ_—Ä–µ—á–∏) {
          socket.—É–≤–µ–¥–æ–º–∏—Ç—å_–æ_—Ä–µ—á–∏(–≥–æ–≤–æ—Ä–∏—Ç, –∫–æ–º–Ω–∞—Ç–∞.id);
        }
      }
      
      requestAnimationFrame(–ø—Ä–æ–≤–µ—Ä–∏—Ç—å_—Ä–µ—á—å);
    };
    
    –ø—Ä–æ–≤–µ—Ä–∏—Ç—å_—Ä–µ—á—å();
    
    return () => {
      –∞—É–¥–∏–æ_–∫–æ–Ω—Ç–µ–∫—Å—Ç.close();
    };
  }, [–ª–æ–∫–∞–ª—å–Ω—ã–π_–ø–æ—Ç–æ–∫, –º–∏–∫—Ä–æ—Ñ–æ–Ω_–≤–∫–ª—é—á–µ–Ω, socket, —Ç–µ–∫—É—â–∏–π_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.id, –∫–æ–º–Ω–∞—Ç–∞.id]);

  // –ü–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —Å–æ–±—ã—Ç–∏—è WebSocket
  useEffect(() => {
    if (!socket) return;

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∫–æ–º–Ω–∞—Ç—ã
    const unsubscribe1 = –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è('—É—á–∞—Å—Ç–Ω–∏–∫–∏-–∫–æ–º–Ω–∞—Ç—ã-–æ–±–Ω–æ–≤–ª–µ–Ω—ã', (–¥–∞–Ω–Ω—ã–µ: any) => {
      if (–¥–∞–Ω–Ω—ã–µ.–∫–æ–º–Ω–∞—Ç–∞_id === –∫–æ–º–Ω–∞—Ç–∞.id) {
        set–£—á–∞—Å—Ç–Ω–∏–∫–∏(–¥–∞–Ω–Ω—ã–µ.—É—á–∞—Å—Ç–Ω–∏–∫–∏);
        
        // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –Ω–æ–≤—ã–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º
        –¥–∞–Ω–Ω—ã–µ.—É—á–∞—Å—Ç–Ω–∏–∫–∏.forEach((—É—á–∞—Å—Ç–Ω–∏–∫: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å) => {
          if (—É—á–∞—Å—Ç–Ω–∏–∫.id !== —Ç–µ–∫—É—â–∏–π_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.id) {
            –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è_–∫_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é(—É—á–∞—Å—Ç–Ω–∏–∫.id);
          }
        });
      }
    });

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –¥—Ä—É–≥–∏—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
    const unsubscribe2 = –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è('–º–∏–∫—Ä–æ—Ñ–æ–Ω-–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω', (–¥–∞–Ω–Ω—ã–µ: any) => {
      set–£—á–∞—Å—Ç–Ω–∏–∫–∏(prev => prev.map(—É—á–∞—Å—Ç–Ω–∏–∫ => 
        —É—á–∞—Å—Ç–Ω–∏–∫.id === –¥–∞–Ω–Ω—ã–µ.–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id 
          ? { ...—É—á–∞—Å—Ç–Ω–∏–∫, –º–∏–∫—Ä–æ—Ñ–æ–Ω_–≤–∫–ª—é—á–µ–Ω: –¥–∞–Ω–Ω—ã–µ.–≤–∫–ª—é—á–µ–Ω }
          : —É—á–∞—Å—Ç–Ω–∏–∫
      ));
    });

    // –ò–Ω–¥–∏–∫–∞—Ü–∏—è —Ä–µ—á–∏ –¥—Ä—É–≥–∏—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
    const unsubscribe3 = –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è('–≥–æ–≤–æ—Ä–∏—Ç', (–¥–∞–Ω–Ω—ã–µ: any) => {
      set–ì–æ–≤–æ—Ä—è—â–∏–µ_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏(prev => {
        const –Ω–æ–≤—ã–µ = new Set(prev);
        if (–¥–∞–Ω–Ω—ã–µ.–≥–æ–≤–æ—Ä–∏—Ç) {
          –Ω–æ–≤—ã–µ.add(–¥–∞–Ω–Ω—ã–µ.–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id);
        } else {
          –Ω–æ–≤—ã–µ.delete(–¥–∞–Ω–Ω—ã–µ.–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id);
        }
        return –Ω–æ–≤—ã–µ;
      });
    });

    return () => {
      unsubscribe1();
      unsubscribe2();
      unsubscribe3();
    };
  }, [socket, –∫–æ–º–Ω–∞—Ç–∞.id, —Ç–µ–∫—É—â–∏–π_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.id, –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è_–∫_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è]);

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ –∫–æ–º–Ω–∞—Ç—É
  useEffect(() => {
    –ø–æ–ª—É—á–∏—Ç—å_–º–∏–∫—Ä–æ—Ñ–æ–Ω().catch(console.error);
    
    return () => {
      –æ—á–∏—Å—Ç–∏—Ç—å();
      // –û—á–∏—â–∞–µ–º –≤—Å–µ –∞—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç—ã
      –∞—É–¥–∏–æ_refs.current.forEach(audio => {
        audio.pause();
        audio.srcObject = null;
      });
      –∞—É–¥–∏–æ_refs.current.clear();
    };
  }, [–ø–æ–ª—É—á–∏—Ç—å_–º–∏–∫—Ä–æ—Ñ–æ–Ω, –æ—á–∏—Å—Ç–∏—Ç—å]);

  // –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É –∑–∞–≥—Ä—É–∑–∫–∏
  if (–æ—à–∏–±–∫–∞) {
    return (
      <div className="flex items-center justify-center h-full p-4">
        <div className="text-center">
          <div className="text-6xl mb-4">‚ö†Ô∏è</div>
          <div className="text-xl font-bold text-red-600 mb-2">–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É</div>
          <div className="text-gray-600 mb-4">{–æ—à–∏–±–∫–∞}</div>
          <button
            onClick={() => window.location.reload()}
            className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg"
          >
            –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className="flex flex-col h-full bg-gradient-to-b from-blue-50 to-indigo-100 dark:from-gray-900 dark:to-gray-800">
      {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–æ–º–Ω–∞—Ç—ã */}
      <div className="bg-white dark:bg-gray-800 shadow-md p-4 border-b">
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-xl font-bold text-gray-800 dark:text-white">{–∫–æ–º–Ω–∞—Ç–∞.–Ω–∞–∑–≤–∞–Ω–∏–µ}</h1>
            <p className="text-sm text-gray-600 dark:text-gray-300">
              {—É—á–∞—Å—Ç–Ω–∏–∫–∏.length} / {–∫–æ–º–Ω–∞—Ç–∞.–º–∞–∫—Å–∏–º—É–º_—É—á–∞—Å—Ç–Ω–∏–∫–æ–≤} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
            </p>
            {–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è && (
              <p className="text-xs text-blue-500">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –≥–æ–ª–æ—Å–æ–≤–æ–º—É —á–∞—Ç—É...</p>
            )}
          </div>
          <div className="flex gap-2">
            <button
              onClick={–Ω–∞_–ø–æ–∫–∏–Ω—É—Ç—å_–∫–æ–º–Ω–∞—Ç—É}
              className="p-2 bg-red-100 dark:bg-red-900 text-red-600 dark:text-red-300 rounded-lg hover:bg-red-200 dark:hover:bg-red-800 transition-colors"
            >
              ‚ùå
            </button>
          </div>
        </div>
      </div>

      {/* –£—á–∞—Å—Ç–Ω–∏–∫–∏ –∫–æ–º–Ω–∞—Ç—ã */}
      <div className="flex-1 overflow-y-auto p-4">
        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
          {—É—á–∞—Å—Ç–Ω–∏–∫–∏.map(—É—á–∞—Å—Ç–Ω–∏–∫ => {
            const –≥–æ–≤–æ—Ä–∏—Ç = –≥–æ–≤–æ—Ä—è—â–∏–µ_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏.has(—É—á–∞—Å—Ç–Ω–∏–∫.id);
            const –∏–º–µ–µ—Ç_–∞—É–¥–∏–æ = –∞—É–¥–∏–æ_–ø–æ—Ç–æ–∫–∏.has(—É—á–∞—Å—Ç–Ω–∏–∫.id);
            
            return (
              <div
                key={—É—á–∞—Å—Ç–Ω–∏–∫.id}
                className={`relative p-4 rounded-xl bg-white dark:bg-gray-800 shadow-md transition-all duration-200 ${
                  –≥–æ–≤–æ—Ä–∏—Ç ? 'ring-2 ring-green-400 shadow-lg' : ''
                }`}
              >
                <div className="text-center">
                  {/* –ê–≤–∞—Ç–∞—Ä —Å –∏–Ω–¥–∏–∫–∞—Ü–∏–µ–π —Ä–µ—á–∏ */}
                  <div className={`text-3xl mb-2 transition-transform duration-200 ${
                    –≥–æ–≤–æ—Ä–∏—Ç ? 'scale-110' : ''
                  }`}>
                    {—É—á–∞—Å—Ç–Ω–∏–∫.–∞–≤–∞—Ç–∞—Ä || 'üë§'}
                  </div>
                  
                  {/* –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è */}
                  <div className="font-medium text-gray-800 dark:text-white text-sm mb-2">
                    {—É—á–∞—Å—Ç–Ω–∏–∫.–∏–º—è}
                    {—É—á–∞—Å—Ç–Ω–∏–∫.id === —Ç–µ–∫—É—â–∏–π_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.id && ' (–í—ã)'}
                  </div>
                  
                  {/* –°—Ç–∞—Ç—É—Å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è */}
                  <div className="flex justify-center items-center gap-2">
                    <span className={`text-lg ${—É—á–∞—Å—Ç–Ω–∏–∫.–º–∏–∫—Ä–æ—Ñ–æ–Ω_–≤–∫–ª—é—á–µ–Ω ? 'text-green-500' : 'text-red-500'}`}>
                      {—É—á–∞—Å—Ç–Ω–∏–∫.–º–∏–∫—Ä–æ—Ñ–æ–Ω_–≤–∫–ª—é—á–µ–Ω ? 'üé§' : 'üîá'}
                    </span>
                    
                    {—É—á–∞—Å—Ç–Ω–∏–∫.id !== —Ç–µ–∫—É—â–∏–π_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.id && (
                      <span className={`text-xs ${–∏–º–µ–µ—Ç_–∞—É–¥–∏–æ ? 'text-green-600' : 'text-gray-400'}`}>
                        {–∏–º–µ–µ—Ç_–∞—É–¥–∏–æ ? 'üîä' : 'üì∂'}
                      </span>
                    )}
                    
                    {–≥–æ–≤–æ—Ä–∏—Ç && (
                      <span className="text-xs text-green-500 animate-pulse">
                        üó£Ô∏è
                      </span>
                    )}
                  </div>
                  
                  {/* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∫–∞—á–µ—Å—Ç–≤–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è */}
                  {—É—á–∞—Å—Ç–Ω–∏–∫.id !== —Ç–µ–∫—É—â–∏–π_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.id && (
                    <div className="mt-1 text-xs text-gray-500">
                      {–∏–º–µ–µ—Ç_–∞—É–¥–∏–æ ? '–ü–æ–¥–∫–ª—é—á–µ–Ω' : '–ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è...'}
                    </div>
                  )}
                </div>
              </div>
            );
          })}
        </div>
        
        {/* –°–æ–æ–±—â–µ–Ω–∏–µ –µ—Å–ª–∏ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —É—á–∞—Å—Ç–Ω–∏–∫ */}
        {—É—á–∞—Å—Ç–Ω–∏–∫–∏.length === 1 && (
          <div className="text-center mt-8 text-gray-500">
            <div className="text-4xl mb-2">üë•</div>
            <div className="text-lg mb-1">–í—ã –æ–¥–∏–Ω –≤ –∫–æ–º–Ω–∞—Ç–µ</div>
            <div className="text-sm">–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —Å—Å—ã–ª–∫–æ–π, —á—Ç–æ–±—ã –ø—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–∑–µ–π!</div>
          </div>
        )}
      </div>

      {/* –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–æ–º */}
      <div className="bg-white dark:bg-gray-800 p-4 border-t">
        <div className="flex justify-center items-center gap-4">
          {/* –û—Å–Ω–æ–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ */}
          <button
            onClick={–æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ_–º–∏–∫—Ä–æ—Ñ–æ–Ω–∞}
            disabled={–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è}
            className={`w-16 h-16 rounded-full flex items-center justify-center text-2xl transition-all duration-200 ${
              –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è 
                ? 'bg-gray-400 cursor-not-allowed' 
                : –º–∏–∫—Ä–æ—Ñ–æ–Ω_–≤–∫–ª—é—á–µ–Ω 
                  ? 'bg-green-500 hover:bg-green-600 text-white shadow-lg hover:shadow-xl' 
                  : 'bg-red-500 hover:bg-red-600 text-white shadow-lg hover:shadow-xl'
            }`}
          >
            {–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è ? '‚è≥' : –º–∏–∫—Ä–æ—Ñ–æ–Ω_–≤–∫–ª—é—á–µ–Ω ? 'üé§' : 'üîá'}
          </button>
        </div>
        
        {/* –û–ø–∏—Å–∞–Ω–∏–µ –∏ —Å—Ç–∞—Ç—É—Å */}
        <div className="mt-2 text-center">
          <div className="text-xs text-gray-600 dark:text-gray-400">
            {–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è 
              ? '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É...' 
              : `–ù–∞–∂–º–∏—Ç–µ –¥–ª—è ${–º–∏–∫—Ä–æ—Ñ–æ–Ω_–≤–∫–ª—é—á–µ–Ω ? '–≤—ã–∫–ª—é—á–µ–Ω–∏—è' : '–≤–∫–ª—é—á–µ–Ω–∏—è'} –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞`
            }
          </div>
          
          {–ª–æ–∫–∞–ª—å–Ω—ã–π_–ø–æ—Ç–æ–∫ && (
            <div className="text-xs text-green-600 mt-1">
              ‚úÖ –ú–∏–∫—Ä–æ—Ñ–æ–Ω –ø–æ–¥–∫–ª—é—á–µ–Ω
            </div>
          )}
        </div>
        
        {/* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è */}
        <div className="mt-3 text-center text-xs text-gray-500">
          <div>WebRTC —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π: {–∞—É–¥–∏–æ_–ø–æ—Ç–æ–∫–∏.size}</div>
          {–≥–æ–≤–æ—Ä—è—â–∏–µ_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏.size > 0 && (
            <div className="text-green-600">
              –ì–æ–≤–æ—Ä—è—Ç: {–≥–æ–≤–æ—Ä—è—â–∏–µ_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏.size} —á–µ–ª.
            </div>
          )}
        </div>
      </div>
    </div>
  );
};