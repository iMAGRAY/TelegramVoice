'use client';

import React, { useState, useEffect } from 'react';
import { –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –ö–æ–º–Ω–∞—Ç–∞, –°–æ—Å—Ç–æ—è–Ω–∏–µ–ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è } from '@/types';
import { useTelegramWebApp } from '@/hooks/useTelegramWebApp';
import { useSocket } from '@/hooks/useSocket';
import { useSettings } from '@/hooks/useSettings';
import { SimpleRoomsList } from '@/components/SimpleRoomsList';
import { SimpleVoiceRoom } from '@/components/SimpleVoiceRoom';
import { SettingsPage } from '@/components/SettingsPage';
import { DebugModal } from '@/components/DebugModal';
import { useDebugConsole } from '@/hooks/useDebugConsole';
import { v4 as uuidv4 } from 'uuid';

export default function Home() {
  const [—Å–æ—Å—Ç–æ—è–Ω–∏–µ, set–°–æ—Å—Ç–æ—è–Ω–∏–µ] = useState<–°–æ—Å—Ç–æ—è–Ω–∏–µ–ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è>({
    —Ç–µ–∫—É—â–∏–π_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: null,
    –∫–æ–º–Ω–∞—Ç—ã: [],
    –∞–∫—Ç–∏–≤–Ω–∞—è_–∫–æ–º–Ω–∞—Ç–∞: null,
    –ø–æ–¥–∫–ª—é—á–µ–Ω–æ_–∫_—Å–µ—Ä–≤–µ—Ä—É: false,
    —Å–æ—Å—Ç–æ—è–Ω–∏–µ_–º–∏–∫—Ä–æ—Ñ–æ–Ω–∞: true,
    –≥—Ä–æ–º–∫–æ—Å—Ç—å: 50,
    –æ—à–∏–±–∫–∞: null,
    –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è: true,
  });

  const [–ø–æ–∫–∞–∑–∞—Ç—å_–Ω–∞—Å—Ç—Ä–æ–π–∫–∏, set–ü–æ–∫–∞–∑–∞—Ç—å_–Ω–∞—Å—Ç—Ä–æ–π–∫–∏] = useState(false);
  
  // Debug console —Ö—É–∫
  const { –ø–æ–∫–∞–∑–∞—Ç—å_–æ—Ç–ª–∞–¥–∫—É, –∑–∞–∫—Ä—ã—Ç—å_–æ—Ç–ª–∞–¥–∫—É } = useDebugConsole();

  // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –ª–æ–≥ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
  useEffect(() => {
    console.log('[App] üöÄ Telegram Voice Mini App –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
    console.log('[App] üîß Debug Console –¥–æ—Å—Ç—É–ø–µ–Ω: F12 –∏–ª–∏ —Ç—Ä–æ–π–Ω–æ–π —Ç–∞–ø –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É');
    console.log('[App] üì± –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Telegram Web App:', typeof window !== 'undefined' && !!window.Telegram?.WebApp);
  }, []);
  
  const { 
    –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, 
    –∑–∞–≥—Ä—É–∂–µ–Ω–æ: –Ω–∞—Å—Ç—Ä–æ–π–∫–∏_–∑–∞–≥—Ä—É–∂–µ–Ω—ã, 
    —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å_–Ω–∞—Å—Ç—Ä–æ–π–∫–∏,
    –ø–æ–ª—É—á–∏—Ç—å_–Ω–∞—Å—Ç—Ä–æ–π–∫–∏_–º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ 
  } = useSettings();

  const {
    –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: —Ç–µ–ª–µ–≥—Ä–∞–º_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å,
    –≥–æ—Ç–æ–≤: —Ç–µ–ª–µ–≥—Ä–∞–º_–≥–æ—Ç–æ–≤,
    –≤–µ—Ä—Å–∏—è: —Ç–µ–ª–µ–≥—Ä–∞–º_–≤–µ—Ä—Å–∏—è,
    –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è,
    –ø–æ–∫–∞–∑–∞—Ç—å–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ,
    –ø–æ–∫–∞–∑–∞—Ç—å–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ,
    –ø–æ–∫–∞–∑–∞—Ç—å–í—Å–ø–ª—ã–≤–∞—é—â–µ–µ–û–∫–Ω–æ,
    –≤–∏–±—Ä–∞—Ü–∏—è
  } = useTelegramWebApp();

  // –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –¥–∞–Ω–Ω—ã—Ö Telegram
  useEffect(() => {
    if (—Ç–µ–ª–µ–≥—Ä–∞–º_–≥–æ—Ç–æ–≤ && —Ç–µ–ª–µ–≥—Ä–∞–º_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å && !—Å–æ—Å—Ç–æ—è–Ω–∏–µ.—Ç–µ–∫—É—â–∏–π_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å) {
      const –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å = {
        id: uuidv4(),
        –∏–º—è: `${—Ç–µ–ª–µ–≥—Ä–∞–º_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.first_name}${—Ç–µ–ª–µ–≥—Ä–∞–º_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.last_name ? ` ${—Ç–µ–ª–µ–≥—Ä–∞–º_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.last_name}` : ''}`,
        —Ç–µ–ª–µ–≥—Ä–∞–º_id: —Ç–µ–ª–µ–≥—Ä–∞–º_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.id,
        –∞–≤–∞—Ç–∞—Ä: —Ç–µ–ª–µ–≥—Ä–∞–º_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.photo_url,
        –ø–æ–¥–∫–ª—é—á–µ–Ω: true,
        –º–∏–∫—Ä–æ—Ñ–æ–Ω_–≤–∫–ª—é—á–µ–Ω: true,
        –≥–æ–≤–æ—Ä–∏—Ç: false,
      };

      set–°–æ—Å—Ç–æ—è–Ω–∏–µ(prev => ({
        ...prev,
        —Ç–µ–∫—É—â–∏–π_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å,
        –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è: false,
      }));
    } else if (—Ç–µ–ª–µ–≥—Ä–∞–º_–≥–æ—Ç–æ–≤ && !—Ç–µ–ª–µ–≥—Ä–∞–º_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å && !—Å–æ—Å—Ç–æ—è–Ω–∏–µ.—Ç–µ–∫—É—â–∏–π_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å) {
      // –°–æ–∑–¥–∞–µ–º –≥–æ—Å—Ç–µ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –µ—Å–ª–∏ Telegram –¥–∞–Ω–Ω—ã–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã
      const –≥–æ—Å—Ç–µ–≤–æ–π_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å = {
        id: uuidv4(),
        –∏–º—è: `–ì–æ—Å—Ç—å_${Math.random().toString(36).substr(2, 5)}`,
        –ø–æ–¥–∫–ª—é—á–µ–Ω: true,
        –º–∏–∫—Ä–æ—Ñ–æ–Ω_–≤–∫–ª—é—á–µ–Ω: true,
        –≥–æ–≤–æ—Ä–∏—Ç: false,
      };

      set–°–æ—Å—Ç–æ—è–Ω–∏–µ(prev => ({
        ...prev,
        —Ç–µ–∫—É—â–∏–π_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –≥–æ—Å—Ç–µ–≤–æ–π_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å,
        –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è: false,
      }));
    }
  }, [—Ç–µ–ª–µ–≥—Ä–∞–º_–≥–æ—Ç–æ–≤, —Ç–µ–ª–µ–≥—Ä–∞–º_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å]);

  // –£–º–Ω—ã–π –≤—ã–±–æ—Ä WebSocket URL
  const getWebSocketURL = () => {
    // –ï—Å–ª–∏ –µ—Å—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ—ë
    if (process.env.NEXT_PUBLIC_WEBSOCKET_URL) {
      return process.env.NEXT_PUBLIC_WEBSOCKET_URL;
    }
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–µ–≥–æ URL
    if (typeof window !== 'undefined') {
      const isHTTPS = window.location.protocol === 'https:';
      const hostname = window.location.hostname;
      
      if (hostname === 'localhost' || hostname === '127.0.0.1') {
        return 'ws://localhost:8080';
      }
      
      if (hostname === '89.23.115.156') {
        return isHTTPS ? 'wss://hesovoice.online/ws' : 'ws://89.23.115.156:8080';
      }
      
      if (hostname === 'hesovoice.online') {
        return isHTTPS ? 'wss://hesovoice.online/ws' : 'ws://hesovoice.online/ws';
      }
    }
    
    return 'ws://localhost:8080'; // fallback
  };

  const {
    socket,
    –ø–æ–¥–∫–ª—é—á–µ–Ω–æ,
    –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è: –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è_—Å–æ–∫–µ—Ç,
    –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è_–∫_–∫–æ–º–Ω–∞—Ç–µ,
    –ø–æ–∫–∏–Ω—É—Ç—å_–∫–æ–º–Ω–∞—Ç—É,
    –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è,
  } = useSocket({
    —Å–µ—Ä–≤–µ—ÄUrl: getWebSocketURL(),
    –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: —Å–æ—Å—Ç–æ—è–Ω–∏–µ.—Ç–µ–∫—É—â–∏–π_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å,
    –Ω–∞_–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ_–∫–æ–º–Ω–∞—Ç: (–∫–æ–º–Ω–∞—Ç—ã: –ö–æ–º–Ω–∞—Ç–∞[]) => {
      set–°–æ—Å—Ç–æ—è–Ω–∏–µ(prev => ({ ...prev, –∫–æ–º–Ω–∞—Ç—ã }));
    },
    –Ω–∞_–æ—à–∏–±–∫—É: (–æ—à–∏–±–∫–∞: string) => {
      set–°–æ—Å—Ç–æ—è–Ω–∏–µ(prev => ({ ...prev, –æ—à–∏–±–∫–∞ }));
      –ø–æ–∫–∞–∑–∞—Ç—å–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ(`–û—à–∏–±–∫–∞: ${–æ—à–∏–±–∫–∞}`);
    },
  });

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
  useEffect(() => {
    set–°–æ—Å—Ç–æ—è–Ω–∏–µ(prev => ({
      ...prev,
      –ø–æ–¥–∫–ª—é—á–µ–Ω–æ_–∫_—Å–µ—Ä–≤–µ—Ä—É: –ø–æ–¥–∫–ª—é—á–µ–Ω–æ,
      –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è: –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è_—Å–æ–∫–µ—Ç,
    }));
  }, [–ø–æ–¥–∫–ª—é—á–µ–Ω–æ, –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è_—Å–æ–∫–µ—Ç]);

  // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
  const –æ—Ç–∫—Ä—ã—Ç—å_–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ = () => {
    set–ü–æ–∫–∞–∑–∞—Ç—å_–Ω–∞—Å—Ç—Ä–æ–π–∫–∏(true);
    –≤–∏–±—Ä–∞—Ü–∏—è?.();
  };

  const –∑–∞–∫—Ä—ã—Ç—å_–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ = () => {
    set–ü–æ–∫–∞–∑–∞—Ç—å_–Ω–∞—Å—Ç—Ä–æ–π–∫–∏(false);
  };

  const —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å_–∏_–∑–∞–∫—Ä—ã—Ç—å_–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ = (–Ω–æ–≤—ã–µ_–Ω–∞—Å—Ç—Ä–æ–π–∫–∏: typeof –Ω–∞—Å—Ç—Ä–æ–π–∫–∏) => {
    —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å_–Ω–∞—Å—Ç—Ä–æ–π–∫–∏(–Ω–æ–≤—ã–µ_–Ω–∞—Å—Ç—Ä–æ–π–∫–∏);
    set–ü–æ–∫–∞–∑–∞—Ç—å_–Ω–∞—Å—Ç—Ä–æ–π–∫–∏(false);
    –ø–æ–∫–∞–∑–∞—Ç—å–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ?.('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
  };


  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫ –∫–æ–º–Ω–∞—Ç–µ
  const –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_–ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ_–∫_–∫–æ–º–Ω–∞—Ç–µ = async (–∫–æ–º–Ω–∞—Ç–∞_id: string, –ø–∞—Ä–æ–ª—å?: string) => {
    if (!—Å–æ—Å—Ç–æ—è–Ω–∏–µ.—Ç–µ–∫—É—â–∏–π_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å) return;

    try {
      –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è_–∫_–∫–æ–º–Ω–∞—Ç–µ(–∫–æ–º–Ω–∞—Ç–∞_id, –ø–∞—Ä–æ–ª—å);
      –≤–∏–±—Ä–∞—Ü–∏—è();

      // –ù–∞—Ö–æ–¥–∏–º –∫–æ–º–Ω–∞—Ç—É –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–∞–∫ –∞–∫—Ç–∏–≤–Ω—É—é
      const –∫–æ–º–Ω–∞—Ç–∞ = —Å–æ—Å—Ç–æ—è–Ω–∏–µ.–∫–æ–º–Ω–∞—Ç—ã.find(r => r.id === –∫–æ–º–Ω–∞—Ç–∞_id);
      if (–∫–æ–º–Ω–∞—Ç–∞) {
        set–°–æ—Å—Ç–æ—è–Ω–∏–µ(prev => ({ ...prev, –∞–∫—Ç–∏–≤–Ω–∞—è_–∫–æ–º–Ω–∞—Ç–∞: –∫–æ–º–Ω–∞—Ç–∞ }));
      }
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫ –∫–æ–º–Ω–∞—Ç–µ:', error);
      –ø–æ–∫–∞–∑–∞—Ç—å–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ');
    }
  };

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã—Ö–æ–¥–∞ –∏–∑ –∫–æ–º–Ω–∞—Ç—ã
  const –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_–≤—ã—Ö–æ–¥_–∏–∑_–∫–æ–º–Ω–∞—Ç—ã = async () => {
    if (!—Å–æ—Å—Ç–æ—è–Ω–∏–µ.—Ç–µ–∫—É—â–∏–π_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å || !—Å–æ—Å—Ç–æ—è–Ω–∏–µ.–∞–∫—Ç–∏–≤–Ω–∞—è_–∫–æ–º–Ω–∞—Ç–∞) return;

    const –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ = await –ø–æ–∫–∞–∑–∞—Ç—å–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–∫–∏–Ω—É—Ç—å –∫–æ–º–Ω–∞—Ç—É?');
    if (!–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ) return;

    try {
      –ø–æ–∫–∏–Ω—É—Ç—å_–∫–æ–º–Ω–∞—Ç—É(—Å–æ—Å—Ç–æ—è–Ω–∏–µ.–∞–∫—Ç–∏–≤–Ω–∞—è_–∫–æ–º–Ω–∞—Ç–∞.id);
      set–°–æ—Å—Ç–æ—è–Ω–∏–µ(prev => ({ ...prev, –∞–∫—Ç–∏–≤–Ω–∞—è_–∫–æ–º–Ω–∞—Ç–∞: null }));
      –≤–∏–±—Ä–∞—Ü–∏—è();
      –ø–æ–∫–∞–∑–∞—Ç—å–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ('–í—ã –ø–æ–∫–∏–Ω—É–ª–∏ –∫–æ–º–Ω–∞—Ç—É');
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞ –∏–∑ –∫–æ–º–Ω–∞—Ç—ã:', error);
      –ø–æ–∫–∞–∑–∞—Ç—å–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–∫–∏–Ω—É—Ç—å –∫–æ–º–Ω–∞—Ç—É');
    }
  };

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π —á–µ—Ä–µ–∑ WebSocket
  useEffect(() => {
    if (!socket || !socket.–ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è) return;

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫ –∫–æ–º–Ω–∞—Ç–µ
    const unsubscribe–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ = socket.–ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è('–ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è-–∫-–∫–æ–º–Ω–∞—Ç–µ', (–¥–∞–Ω–Ω—ã–µ: any) => {
      const { –∫–æ–º–Ω–∞—Ç–∞ } = –¥–∞–Ω–Ω—ã–µ;
      set–°–æ—Å—Ç–æ—è–Ω–∏–µ(prev => ({ ...prev, –∞–∫—Ç–∏–≤–Ω–∞—è_–∫–æ–º–Ω–∞—Ç–∞: –∫–æ–º–Ω–∞—Ç–∞ }));
      –ø–æ–∫–∞–∑–∞—Ç—å–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ(`–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∫–æ–º–Ω–∞—Ç—É \"${–∫–æ–º–Ω–∞—Ç–∞.–Ω–∞–∑–≤–∞–Ω–∏–µ}\"!`);
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã—Ö–æ–¥–∞ –∏–∑ –∫–æ–º–Ω–∞—Ç—ã
    const unsubscribe–í—ã—Ö–æ–¥ = socket.–ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è('–ø–æ–∫–∏–Ω—É–ª-–∫–æ–º–Ω–∞—Ç—É', (–¥–∞–Ω–Ω—ã–µ: any) => {
      set–°–æ—Å—Ç–æ—è–Ω–∏–µ(prev => ({ ...prev, –∞–∫—Ç–∏–≤–Ω–∞—è_–∫–æ–º–Ω–∞—Ç–∞: null }));
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã
    const unsubscribe–°–æ–∑–¥–∞–Ω–∏–µ = socket.–ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è('–∫–æ–º–Ω–∞—Ç–∞-—Å–æ–∑–¥–∞–Ω–∞', (–¥–∞–Ω–Ω—ã–µ: any) => {
      const { –∫–æ–º–Ω–∞—Ç–∞ } = –¥–∞–Ω–Ω—ã–µ;
      if (–∫–æ–º–Ω–∞—Ç–∞.—Å–æ–∑–¥–∞—Ç–µ–ª—å === —Å–æ—Å—Ç–æ—è–Ω–∏–µ.—Ç–µ–∫—É—â–∏–π_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å?.id) {
        set–°–æ—Å—Ç–æ—è–Ω–∏–µ(prev => ({ ...prev, –∞–∫—Ç–∏–≤–Ω–∞—è_–∫–æ–º–Ω–∞—Ç–∞: –∫–æ–º–Ω–∞—Ç–∞ }));
      }
    });

    return () => {
      unsubscribe–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ();
      unsubscribe–í—ã—Ö–æ–¥();
      unsubscribe–°–æ–∑–¥–∞–Ω–∏–µ();
    };
  }, [socket, —Å–æ—Å—Ç–æ—è–Ω–∏–µ.—Ç–µ–∫—É—â–∏–π_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å?.id, –ø–æ–∫–∞–∑–∞—Ç—å–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ]);

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –ø–æ–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
  if (—Å–æ—Å—Ç–æ—è–Ω–∏–µ.–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è || !—Å–æ—Å—Ç–æ—è–Ω–∏–µ.—Ç–µ–∫—É—â–∏–π_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å || !–Ω–∞—Å—Ç—Ä–æ–π–∫–∏_–∑–∞–≥—Ä—É–∂–µ–Ω—ã) {
    return (
      <div className="min-h-screen bg-[var(--bg-primary)] flex items-center justify-center">
        <div className="text-center space-y-4">
          <div className="w-16 h-16 mx-auto rounded-full bg-[var(--bg-secondary)] flex items-center justify-center">
            <div className="w-8 h-8 rounded-full border-2 border-[var(--accent)] border-t-transparent animate-spin"></div>
          </div>
          <div className="text-lg font-medium text-[var(--text-primary)]">
            –ì–æ–ª–æ—Å–æ–≤—ã–µ –∫–æ–º–Ω–∞—Ç—ã
          </div>
          <div className="text-sm text-[var(--text-secondary)]">
            –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...
          </div>
        </div>
      </div>
    );
  }

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
  if (!—Å–æ—Å—Ç–æ—è–Ω–∏–µ.–ø–æ–¥–∫–ª—é—á–µ–Ω–æ_–∫_—Å–µ—Ä–≤–µ—Ä—É && !–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è_—Å–æ–∫–µ—Ç) {
    return (
      <div className="min-h-screen bg-[var(--bg-primary)] flex items-center justify-center p-4">
        <div className="text-center space-y-4 max-w-md">
          <div className="w-16 h-16 mx-auto rounded-full bg-[var(--danger)] bg-opacity-10 flex items-center justify-center">
            <svg className="w-8 h-8 text-[var(--danger)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
          <div className="text-lg font-medium text-[var(--text-primary)]">
            –ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É
          </div>
          <div className="text-sm text-[var(--text-secondary)]">
            –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞
          </div>
          <button
            onClick={() => window.location.reload()}
            className="px-4 py-2 bg-[var(--bg-secondary)] hover:bg-[var(--bg-hover)] text-[var(--text-primary)] rounded-lg transition-colors border border-[var(--border-color)]"
          >
            –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-[var(--bg-primary)]">
      {/* –°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è */}
      <div className="border-b border-[var(--border-color)]">
        <div className="max-w-4xl mx-auto px-6 py-2 flex items-center justify-between text-xs">
          <div className="flex items-center gap-2">
            <div className={`w-2 h-2 rounded-full ${—Å–æ—Å—Ç–æ—è–Ω–∏–µ.–ø–æ–¥–∫–ª—é—á–µ–Ω–æ_–∫_—Å–µ—Ä–≤–µ—Ä—É ? 'bg-[var(--success)]' : 'bg-[var(--warning)]'} animate-pulse`}></div>
            <span className="text-[var(--text-secondary)]">
              {—Å–æ—Å—Ç–æ—è–Ω–∏–µ.–ø–æ–¥–∫–ª—é—á–µ–Ω–æ_–∫_—Å–µ—Ä–≤–µ—Ä—É ? '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ' : '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...'}
            </span>
          </div>
          <div className="text-[var(--text-tertiary)]">
            v{—Ç–µ–ª–µ–≥—Ä–∞–º_–≤–µ—Ä—Å–∏—è}
          </div>
        </div>
      </div>

      {/* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç */}
      {—Å–æ—Å—Ç–æ—è–Ω–∏–µ.–∞–∫—Ç–∏–≤–Ω–∞—è_–∫–æ–º–Ω–∞—Ç–∞ ? (
        <SimpleVoiceRoom
          –∫–æ–º–Ω–∞—Ç–∞={—Å–æ—Å—Ç–æ—è–Ω–∏–µ.–∞–∫—Ç–∏–≤–Ω–∞—è_–∫–æ–º–Ω–∞—Ç–∞}
          —Ç–µ–∫—É—â–∏–π_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å={—Å–æ—Å—Ç–æ—è–Ω–∏–µ.—Ç–µ–∫—É—â–∏–π_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å}
          socket={socket}
          –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è={–ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è}
          –Ω–∞_–ø–æ–∫–∏–Ω—É—Ç—å_–∫–æ–º–Ω–∞—Ç—É={–æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_–≤—ã—Ö–æ–¥_–∏–∑_–∫–æ–º–Ω–∞—Ç—ã}
          –Ω–∞_–æ—Ç–∫—Ä—ã—Ç—å_–Ω–∞—Å—Ç—Ä–æ–π–∫–∏={–æ—Ç–∫—Ä—ã—Ç—å_–Ω–∞—Å—Ç—Ä–æ–π–∫–∏}
        />
      ) : (
        <SimpleRoomsList
          –∫–æ–º–Ω–∞—Ç—ã={—Å–æ—Å—Ç–æ—è–Ω–∏–µ.–∫–æ–º–Ω–∞—Ç—ã}
          –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å={—Å–æ—Å—Ç–æ—è–Ω–∏–µ.—Ç–µ–∫—É—â–∏–π_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å}
          –Ω–∞_–ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ={–æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_–ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ_–∫_–∫–æ–º–Ω–∞—Ç–µ}
          –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è={–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è_—Å–æ–∫–µ—Ç}
          –Ω–∞_–æ—Ç–∫—Ä—ã—Ç—å_–Ω–∞—Å—Ç—Ä–æ–π–∫–∏={–æ—Ç–∫—Ä—ã—Ç—å_–Ω–∞—Å—Ç—Ä–æ–π–∫–∏}
        />
      )}

      {/* –°—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ */}
      {–ø–æ–∫–∞–∑–∞—Ç—å_–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ && (
        <SettingsPage
          –Ω–∞—Å—Ç—Ä–æ–π–∫–∏={–Ω–∞—Å—Ç—Ä–æ–π–∫–∏}
          –Ω–∞_–∑–∞–∫—Ä—ã—Ç—å={–∑–∞–∫—Ä—ã—Ç—å_–Ω–∞—Å—Ç—Ä–æ–π–∫–∏}
          –Ω–∞_—Å–æ—Ö—Ä–∞–Ω–∏—Ç—å={—Å–æ—Ö—Ä–∞–Ω–∏—Ç—å_–∏_–∑–∞–∫—Ä—ã—Ç—å_–Ω–∞—Å—Ç—Ä–æ–π–∫–∏}
        />
      )}

      {/* Debug Modal */}
      <DebugModal
        –æ—Ç–∫—Ä—ã—Ç={–ø–æ–∫–∞–∑–∞—Ç—å_–æ—Ç–ª–∞–¥–∫—É}
        –Ω–∞_–∑–∞–∫—Ä—ã—Ç—å={–∑–∞–∫—Ä—ã—Ç—å_–æ—Ç–ª–∞–¥–∫—É}
      />

      {/* –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—à–∏–±–æ–∫ */}
      {—Å–æ—Å—Ç–æ—è–Ω–∏–µ.–æ—à–∏–±–∫–∞ && (
        <div className="fixed bottom-4 left-4 right-4 max-w-md mx-auto">
          <div className="bg-[var(--bg-primary)] border border-[var(--danger)] rounded-lg shadow-[var(--shadow-md)] p-4">
            <div className="flex items-start justify-between gap-3">
              <div className="flex items-start gap-3">
                <div className="w-5 h-5 rounded-full bg-[var(--danger)] bg-opacity-10 flex-shrink-0 flex items-center justify-center mt-0.5">
                  <svg className="w-3 h-3 text-[var(--danger)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </div>
                <div className="text-sm text-[var(--text-primary)]">{—Å–æ—Å—Ç–æ—è–Ω–∏–µ.–æ—à–∏–±–∫–∞}</div>
              </div>
              <button
                onClick={() => set–°–æ—Å—Ç–æ—è–Ω–∏–µ(prev => ({ ...prev, –æ—à–∏–±–∫–∞: null }))}
                className="text-[var(--text-tertiary)] hover:text-[var(--text-secondary)] transition-colors"
              >
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
