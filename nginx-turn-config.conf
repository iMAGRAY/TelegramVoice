# Конфигурация nginx для проксирования TURN через HTTPS
# Добавьте этот блок в конфигурацию nginx для hesovoice.online

# Upstream для TURN сервера
upstream turn_backend {
    server 127.0.0.1:3478;
}

# HTTPS stream для TURN (порт 443 с альтернативным путем)
server {
    listen 443 ssl http2;
    server_name turn.hesovoice.online;

    ssl_certificate /etc/letsencrypt/live/hesovoice.online/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/hesovoice.online/privkey.pem;
    
    # Проксирование TURN через WebSocket для обхода файрволлов
    location /turn {
        proxy_pass http://turn_backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Таймауты для TURN
        proxy_connect_timeout 7d;
        proxy_send_timeout 7d;
        proxy_read_timeout 7d;
    }
}

# Альтернативная конфигурация для stream модуля nginx
# (требует nginx с модулем stream)
# Добавьте в /etc/nginx/nginx.conf вне блока http {}:

# stream {
#     upstream turn_tcp {
#         server 127.0.0.1:3478;
#     }
#     
#     upstream turn_udp {
#         server 127.0.0.1:3478;
#     }
#     
#     # TCP TURN через порт 3479
#     server {
#         listen 3479;
#         proxy_pass turn_tcp;
#         proxy_timeout 30s;
#         proxy_connect_timeout 5s;
#     }
#     
#     # UDP TURN через порт 3479
#     server {
#         listen 3479 udp;
#         proxy_pass turn_udp;
#         proxy_timeout 30s;
#         proxy_responses 1;
#     }
# }