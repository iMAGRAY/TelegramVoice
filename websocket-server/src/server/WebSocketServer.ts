import { WebSocketServer as WSServer } from 'ws';
import type { WebSocket } from 'ws';
import { v4 as uuidv4 } from 'uuid';
import type { 
  –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, 
  –ö–æ–º–Ω–∞—Ç–∞, 
  –°–æ–æ–±—â–µ–Ω–∏–µ–ö–ª–∏–µ–Ω—Ç–∞, 
  –°–æ–æ–±—â–µ–Ω–∏–µ–°–µ—Ä–≤–µ—Ä–∞ 
} from '@/types';

interface WSConnection extends WebSocket {
  userId?: string;
  isAlive?: boolean;
}

export class WebSocketServer {
  private wss: WSServer;
  private –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏: Map<string, –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å> = new Map();
  private –∫–æ–º–Ω–∞—Ç—ã: Map<string, –ö–æ–º–Ω–∞—Ç–∞> = new Map();
  private —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: Map<string, WSConnection> = new Map();

  constructor(port: number = 8080) {
    this.wss = new WSServer({ port });
    this.–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å–ö–æ–º–Ω–∞—Ç—ã();
    this.–Ω–∞—Å—Ç—Ä–æ–∏—Ç—å–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏();
    
    console.log(`üöÄ WebSocket —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É ${port}`);
  }

  private –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å–ö–æ–º–Ω–∞—Ç—ã() {
    const –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ–ö–æ–º–Ω–∞—Ç—ã: –ö–æ–º–Ω–∞—Ç–∞[] = [
      {
        id: 'general',
        –Ω–∞–∑–≤–∞–Ω–∏–µ: '–û–±—â–∏–π',
        —Å–æ–∑–¥–∞—Ç–µ–ª—å: 'system',
        —É—á–∞—Å—Ç–Ω–∏–∫–∏: [],
        –º–∞–∫—Å–∏–º—É–º_—É—á–∞—Å—Ç–Ω–∏–∫–æ–≤: 50,
        —Å–æ–∑–¥–∞–Ω–∞: new Date().toISOString(),
        –∞–∫—Ç–∏–≤–Ω–∞: true,
        –ø—Ä–∏–≤–∞—Ç–Ω–∞—è: false
      },
      {
        id: 'important',
        –Ω–∞–∑–≤–∞–Ω–∏–µ: '–ö–æ–º–Ω–∞—Ç–∞ –≤–∞–∂–Ω—ã—Ö –ø–µ—Ä–µ–≥–æ–≤–æ—Ä–æ–≤',
        —Å–æ–∑–¥–∞—Ç–µ–ª—å: 'system',
        —É—á–∞—Å—Ç–Ω–∏–∫–∏: [],
        –º–∞–∫—Å–∏–º—É–º_—É—á–∞—Å—Ç–Ω–∏–∫–æ–≤: 10,
        —Å–æ–∑–¥–∞–Ω–∞: new Date().toISOString(),
        –∞–∫—Ç–∏–≤–Ω–∞: true,
        –ø—Ä–∏–≤–∞—Ç–Ω–∞—è: false
      },
      {
        id: 'channel1',
        –Ω–∞–∑–≤–∞–Ω–∏–µ: '–ö–∞–Ω–∞–ª 1',
        —Å–æ–∑–¥–∞—Ç–µ–ª—å: 'system',
        —É—á–∞—Å—Ç–Ω–∏–∫–∏: [],
        –º–∞–∫—Å–∏–º—É–º_—É—á–∞—Å—Ç–Ω–∏–∫–æ–≤: 20,
        —Å–æ–∑–¥–∞–Ω–∞: new Date().toISOString(),
        –∞–∫—Ç–∏–≤–Ω–∞: true,
        –ø—Ä–∏–≤–∞—Ç–Ω–∞—è: false
      }
    ];

    –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ–ö–æ–º–Ω–∞—Ç—ã.forEach(–∫–æ–º–Ω–∞—Ç–∞ => {
      this.–∫–æ–º–Ω–∞—Ç—ã.set(–∫–æ–º–Ω–∞—Ç–∞.id, –∫–æ–º–Ω–∞—Ç–∞);
    });

    console.log(`üìã –°–æ–∑–¥–∞–Ω–æ ${–ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ–ö–æ–º–Ω–∞—Ç—ã.length} –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –∫–æ–º–Ω–∞—Ç`);
  }

  private –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏() {
    // Heartbeat –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
    const interval = setInterval(() => {
      this.wss.clients.forEach((ws: WSConnection) => {
        if (ws.isAlive === false) {
          this.–æ–±—Ä–∞–±–æ—Ç–∞—Ç—å–û—Ç–∫–ª—é—á–µ–Ω–∏–µ(ws);
          return ws.terminate();
        }
        ws.isAlive = false;
        ws.ping();
      });
    }, 30000);

    this.wss.on('connection', (ws: WSConnection) => {
      console.log('üîó –ù–æ–≤–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ');
      ws.isAlive = true;
      
      ws.on('pong', () => {
        ws.isAlive = true;
      });

      ws.on('message', (data) => {
        try {
          const —Å–æ–æ–±—â–µ–Ω–∏–µ = JSON.parse(data.toString()) as –°–æ–æ–±—â–µ–Ω–∏–µ–ö–ª–∏–µ–Ω—Ç–∞;
          this.–æ–±—Ä–∞–±–æ—Ç–∞—Ç—å–°–æ–æ–±—â–µ–Ω–∏–µ(ws, —Å–æ–æ–±—â–µ–Ω–∏–µ);
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞:', error);
          this.–æ—Ç–ø—Ä–∞–≤–∏—Ç—å–°–æ–æ–±—â–µ–Ω–∏–µ(ws, {
            —Ç–∏–ø: '–æ—à–∏–±–∫–∞',
            —Å–æ–æ–±—â–µ–Ω–∏–µ: '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏—è'
          });
        }
      });

      ws.on('close', () => {
        this.–æ–±—Ä–∞–±–æ—Ç–∞—Ç—å–û—Ç–∫–ª—é—á–µ–Ω–∏–µ(ws);
      });

      ws.on('error', (error) => {
        console.error('‚ùå WebSocket –æ—à–∏–±–∫–∞:', error);
      });
    });

    this.wss.on('close', () => {
      clearInterval(interval);
    });
  }

  private –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å–°–æ–æ–±—â–µ–Ω–∏–µ(ws: WSConnection, —Å–æ–æ–±—â–µ–Ω–∏–µ: –°–æ–æ–±—â–µ–Ω–∏–µ–ö–ª–∏–µ–Ω—Ç–∞) {
    console.log(`üì• –ü–æ–ª—É—á–µ–Ω–æ: ${—Å–æ–æ–±—â–µ–Ω–∏–µ.—Ç–∏–ø}`, ws.userId ? `–æ—Ç ${ws.userId}` : '');

    switch (—Å–æ–æ–±—â–µ–Ω–∏–µ.—Ç–∏–ø) {
      case '–ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è':
        this.–æ–±—Ä–∞–±–æ—Ç–∞—Ç—å–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ(ws, —Å–æ–æ–±—â–µ–Ω–∏–µ.–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å);
        break;
      
      case '–ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è-–∫-–∫–æ–º–Ω–∞—Ç–µ':
        this.–ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è–ö–ö–æ–º–Ω–∞—Ç–µ(ws, —Å–æ–æ–±—â–µ–Ω–∏–µ.–∫–æ–º–Ω–∞—Ç–∞_id, —Å–æ–æ–±—â–µ–Ω–∏–µ.–ø–∞—Ä–æ–ª—å);
        break;
      
      case '–ø–æ–∫–∏–Ω—É—Ç—å-–∫–æ–º–Ω–∞—Ç—É':
        this.–ø–æ–∫–∏–Ω—É—Ç—å–ö–æ–º–Ω–∞—Ç—É(ws, —Å–æ–æ–±—â–µ–Ω–∏–µ.–∫–æ–º–Ω–∞—Ç–∞_id);
        break;
      
      case '—Å–æ–∑–¥–∞—Ç—å-–∫–æ–º–Ω–∞—Ç—É':
        this.—Å–æ–∑–¥–∞—Ç—å–ö–æ–º–Ω–∞—Ç—É(ws, —Å–æ–æ–±—â–µ–Ω–∏–µ);
        break;
      
      case 'webrtc-signal':
        this.–ø–µ—Ä–µ—Å–ª–∞—Ç—åWebRTC–°–∏–≥–Ω–∞–ª(—Å–æ–æ–±—â–µ–Ω–∏–µ);
        break;
      
      case '–º–∏–∫—Ä–æ—Ñ–æ–Ω-–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω':
        this.–æ–±–Ω–æ–≤–∏—Ç—å–°–æ—Å—Ç–æ—è–Ω–∏–µ–ú–∏–∫—Ä–æ—Ñ–æ–Ω–∞(ws, —Å–æ–æ–±—â–µ–Ω–∏–µ.–≤–∫–ª—é—á–µ–Ω, —Å–æ–æ–±—â–µ–Ω–∏–µ.–∫–æ–º–Ω–∞—Ç–∞_id);
        break;
      
      case '–≥–æ–≤–æ—Ä–∏—Ç':
        this.–æ–±–Ω–æ–≤–∏—Ç—å–°–æ—Å—Ç–æ—è–Ω–∏–µ–†–µ—á–∏(ws, —Å–æ–æ–±—â–µ–Ω–∏–µ.–≥–æ–≤–æ—Ä–∏—Ç, —Å–æ–æ–±—â–µ–Ω–∏–µ.–∫–æ–º–Ω–∞—Ç–∞_id);
        break;
      
      case '–ø–æ–ª—É—á–∏—Ç—å-–∫–æ–º–Ω–∞—Ç—ã':
        this.–æ—Ç–ø—Ä–∞–≤–∏—Ç—å–°–ø–∏—Å–æ–∫–ö–æ–º–Ω–∞—Ç(ws);
        break;
      
      case '–ø–æ–ª—É—á–∏—Ç—å-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π-–∫–æ–º–Ω–∞—Ç—ã':
        this.–æ—Ç–ø—Ä–∞–≤–∏—Ç—å–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤–ö–æ–º–Ω–∞—Ç—ã(ws, —Å–æ–æ–±—â–µ–Ω–∏–µ.–∫–æ–º–Ω–∞—Ç–∞_id);
        break;
    }
  }

  private –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ(ws: WSConnection, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å) {
    ws.userId = –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.id;
    this.—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.set(–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.id, ws);
    this.–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏.set(–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.id, {
      ...–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å,
      –ø–æ–¥–∫–ª—é—á–µ–Ω: true,
      –ø–æ—Å–ª–µ–¥–Ω—è—è_–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: new Date().toISOString()
    });

    console.log(`üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.–∏–º—è} –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è (${–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.id})`);

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ–º–Ω–∞—Ç
    this.–æ—Ç–ø—Ä–∞–≤–∏—Ç—å–°–ø–∏—Å–æ–∫–ö–æ–º–Ω–∞—Ç(ws);
  }

  private –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è–ö–ö–æ–º–Ω–∞—Ç–µ(ws: WSConnection, –∫–æ–º–Ω–∞—Ç–∞Id: string, –ø–∞—Ä–æ–ª—å?: string) {
    if (!ws.userId) {
      this.–æ—Ç–ø—Ä–∞–≤–∏—Ç—å–°–æ–æ–±—â–µ–Ω–∏–µ(ws, {
        —Ç–∏–ø: '–æ—à–∏–±–∫–∞',
        —Å–æ–æ–±—â–µ–Ω–∏–µ: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω'
      });
      return;
    }

    const –∫–æ–º–Ω–∞—Ç–∞ = this.–∫–æ–º–Ω–∞—Ç—ã.get(–∫–æ–º–Ω–∞—Ç–∞Id);
    if (!–∫–æ–º–Ω–∞—Ç–∞) {
      this.–æ—Ç–ø—Ä–∞–≤–∏—Ç—å–°–æ–æ–±—â–µ–Ω–∏–µ(ws, {
        —Ç–∏–ø: '–æ—à–∏–±–∫–∞',
        —Å–æ–æ–±—â–µ–Ω–∏–µ: '–ö–æ–º–Ω–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'
      });
      return;
    }

    if (–∫–æ–º–Ω–∞—Ç–∞.–ø—Ä–∏–≤–∞—Ç–Ω–∞—è && –∫–æ–º–Ω–∞—Ç–∞.–ø–∞—Ä–æ–ª—å !== –ø–∞—Ä–æ–ª—å) {
      this.–æ—Ç–ø—Ä–∞–≤–∏—Ç—å–°–æ–æ–±—â–µ–Ω–∏–µ(ws, {
        —Ç–∏–ø: '–æ—à–∏–±–∫–∞',
        —Å–æ–æ–±—â–µ–Ω–∏–µ: '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å'
      });
      return;
    }

    if (–∫–æ–º–Ω–∞—Ç–∞.—É—á–∞—Å—Ç–Ω–∏–∫–∏.length >= –∫–æ–º–Ω–∞—Ç–∞.–º–∞–∫—Å–∏–º—É–º_—É—á–∞—Å—Ç–Ω–∏–∫–æ–≤) {
      this.–æ—Ç–ø—Ä–∞–≤–∏—Ç—å–°–æ–æ–±—â–µ–Ω–∏–µ(ws, {
        —Ç–∏–ø: '–æ—à–∏–±–∫–∞',
        —Å–æ–æ–±—â–µ–Ω–∏–µ: '–ö–æ–º–Ω–∞—Ç–∞ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∞'
      });
      return;
    }

    // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∫–æ–º–Ω–∞—Ç—É
    if (!–∫–æ–º–Ω–∞—Ç–∞.—É—á–∞—Å—Ç–Ω–∏–∫–∏.includes(ws.userId)) {
      –∫–æ–º–Ω–∞—Ç–∞.—É—á–∞—Å—Ç–Ω–∏–∫–∏.push(ws.userId);
    }

    const –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å = this.–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏.get(ws.userId)!;
    –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.–≤_–∫–æ–º–Ω–∞—Ç–µ = –∫–æ–º–Ω–∞—Ç–∞Id;

    console.log(`üè† ${–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.–∏–º—è} –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ "${–∫–æ–º–Ω–∞—Ç–∞.–Ω–∞–∑–≤–∞–Ω–∏–µ}"`);

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
    this.–æ—Ç–ø—Ä–∞–≤–∏—Ç—å–°–æ–æ–±—â–µ–Ω–∏–µ(ws, {
      —Ç–∏–ø: '–ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è-–∫-–∫–æ–º–Ω–∞—Ç–µ',
      –∫–æ–º–Ω–∞—Ç–∞,
      –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    });

    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∫–æ–º–Ω–∞—Ç—ã
    this.–æ–±–Ω–æ–≤–∏—Ç—å–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤–ö–æ–º–Ω–∞—Ç—ã(–∫–æ–º–Ω–∞—Ç–∞Id);
  }

  private –ø–æ–∫–∏–Ω—É—Ç—å–ö–æ–º–Ω–∞—Ç—É(ws: WSConnection, –∫–æ–º–Ω–∞—Ç–∞Id: string) {
    if (!ws.userId) return;

    const –∫–æ–º–Ω–∞—Ç–∞ = this.–∫–æ–º–Ω–∞—Ç—ã.get(–∫–æ–º–Ω–∞—Ç–∞Id);
    if (!–∫–æ–º–Ω–∞—Ç–∞) return;

    –∫–æ–º–Ω–∞—Ç–∞.—É—á–∞—Å—Ç–Ω–∏–∫–∏ = –∫–æ–º–Ω–∞—Ç–∞.—É—á–∞—Å—Ç–Ω–∏–∫–∏.filter(id => id !== ws.userId);

    const –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å = this.–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏.get(ws.userId);
    if (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å) {
      –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.–≤_–∫–æ–º–Ω–∞—Ç–µ = null;
    }

    // –£–≤–µ–¥–æ–º–ª—è–µ–º –≤—Å–µ—Ö –≤ –∫–æ–º–Ω–∞—Ç–µ
    this.–æ—Ç–ø—Ä–∞–≤–∏—Ç—å–í–ö–æ–º–Ω–∞—Ç—É(–∫–æ–º–Ω–∞—Ç–∞Id, {
      —Ç–∏–ø: '–ø–æ–∫–∏–Ω—É–ª-–∫–æ–º–Ω–∞—Ç—É',
      –∫–æ–º–Ω–∞—Ç–∞_id: –∫–æ–º–Ω–∞—Ç–∞Id,
      –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id: ws.userId
    }, ws.userId);

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
    this.–æ–±–Ω–æ–≤–∏—Ç—å–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤–ö–æ–º–Ω–∞—Ç—ã(–∫–æ–º–Ω–∞—Ç–∞Id);
  }

  private —Å–æ–∑–¥–∞—Ç—å–ö–æ–º–Ω–∞—Ç—É(ws: WSConnection, –¥–∞–Ω–Ω—ã–µ: any) {
    if (!ws.userId) return;

    const –Ω–æ–≤–∞—è–ö–æ–º–Ω–∞—Ç–∞: –ö–æ–º–Ω–∞—Ç–∞ = {
      id: uuidv4(),
      –Ω–∞–∑–≤–∞–Ω–∏–µ: –¥–∞–Ω–Ω—ã–µ.–Ω–∞–∑–≤–∞–Ω–∏–µ,
      —Å–æ–∑–¥–∞—Ç–µ–ª—å: ws.userId,
      —É—á–∞—Å—Ç–Ω–∏–∫–∏: [ws.userId],
      –º–∞–∫—Å–∏–º—É–º_—É—á–∞—Å—Ç–Ω–∏–∫–æ–≤: –¥–∞–Ω–Ω—ã–µ.–º–∞–∫—Å–∏–º—É–º_—É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ || 10,
      —Å–æ–∑–¥–∞–Ω–∞: new Date().toISOString(),
      –∞–∫—Ç–∏–≤–Ω–∞: true,
      –ø—Ä–∏–≤–∞—Ç–Ω–∞—è: –¥–∞–Ω–Ω—ã–µ.–ø—Ä–∏–≤–∞—Ç–Ω–∞—è || false,
      –ø–∞—Ä–æ–ª—å: –¥–∞–Ω–Ω—ã–µ.–ø–∞—Ä–æ–ª—å
    };

    this.–∫–æ–º–Ω–∞—Ç—ã.set(–Ω–æ–≤–∞—è–ö–æ–º–Ω–∞—Ç–∞.id, –Ω–æ–≤–∞—è–ö–æ–º–Ω–∞—Ç–∞);

    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å = this.–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏.get(ws.userId);
    if (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å) {
      –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.–≤_–∫–æ–º–Ω–∞—Ç–µ = –Ω–æ–≤–∞—è–ö–æ–º–Ω–∞—Ç–∞.id;
    }

    // –£–≤–µ–¥–æ–º–ª—è–µ–º –≤—Å–µ—Ö –æ –Ω–æ–≤–æ–π –∫–æ–º–Ω–∞—Ç–µ
    this.—à–∏—Ä–æ–∫–æ–≤–µ—â–∞—Ç–µ–ª—å–Ω–æ–µ–°–æ–æ–±—â–µ–Ω–∏–µ({
      —Ç–∏–ø: '–∫–æ–º–Ω–∞—Ç–∞-—Å–æ–∑–¥–∞–Ω–∞',
      –∫–æ–º–Ω–∞—Ç–∞: –Ω–æ–≤–∞—è–ö–æ–º–Ω–∞—Ç–∞
    });
  }

  private –ø–µ—Ä–µ—Å–ª–∞—Ç—åWebRTC–°–∏–≥–Ω–∞–ª(—Å–æ–æ–±—â–µ–Ω–∏–µ: any) {
    const –ø–æ–ª—É—á–∞—Ç–µ–ª—å = this.—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.get(—Å–æ–æ–±—â–µ–Ω–∏–µ.–∫);
    if (–ø–æ–ª—É—á–∞—Ç–µ–ª—å) {
      this.–æ—Ç–ø—Ä–∞–≤–∏—Ç—å–°–æ–æ–±—â–µ–Ω–∏–µ(–ø–æ–ª—É—á–∞—Ç–µ–ª—å, {
        —Ç–∏–ø: 'webrtc-signal',
        –æ—Ç: —Å–æ–æ–±—â–µ–Ω–∏–µ.–æ—Ç,
        –∫: —Å–æ–æ–±—â–µ–Ω–∏–µ.–∫,
        –∫–æ–º–Ω–∞—Ç–∞: —Å–æ–æ–±—â–µ–Ω–∏–µ.–∫–æ–º–Ω–∞—Ç–∞,
        –¥–∞–Ω–Ω—ã–µ: —Å–æ–æ–±—â–µ–Ω–∏–µ.–¥–∞–Ω–Ω—ã–µ
      });
      console.log(`üîÑ WebRTC —Å–∏–≥–Ω–∞–ª –ø–µ—Ä–µ—Å–ª–∞–Ω –æ—Ç ${—Å–æ–æ–±—â–µ–Ω–∏–µ.–æ—Ç} –∫ ${—Å–æ–æ–±—â–µ–Ω–∏–µ.–∫}`);
    }
  }

  private –æ–±–Ω–æ–≤–∏—Ç—å–°–æ—Å—Ç–æ—è–Ω–∏–µ–ú–∏–∫—Ä–æ—Ñ–æ–Ω–∞(ws: WSConnection, –≤–∫–ª—é—á–µ–Ω: boolean, –∫–æ–º–Ω–∞—Ç–∞Id: string) {
    if (!ws.userId) return;

    const –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å = this.–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏.get(ws.userId);
    if (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å) {
      –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.–º–∏–∫—Ä–æ—Ñ–æ–Ω_–≤–∫–ª—é—á–µ–Ω = –≤–∫–ª—é—á–µ–Ω;
    }

    this.–æ—Ç–ø—Ä–∞–≤–∏—Ç—å–í–ö–æ–º–Ω–∞—Ç—É(–∫–æ–º–Ω–∞—Ç–∞Id, {
      —Ç–∏–ø: '–º–∏–∫—Ä–æ—Ñ–æ–Ω-–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω',
      –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id: ws.userId,
      –∫–æ–º–Ω–∞—Ç–∞_id: –∫–æ–º–Ω–∞—Ç–∞Id,
      –≤–∫–ª—é—á–µ–Ω
    });
  }

  private –æ–±–Ω–æ–≤–∏—Ç—å–°–æ—Å—Ç–æ—è–Ω–∏–µ–†–µ—á–∏(ws: WSConnection, –≥–æ–≤–æ—Ä–∏—Ç: boolean, –∫–æ–º–Ω–∞—Ç–∞Id: string) {
    if (!ws.userId) return;

    const –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å = this.–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏.get(ws.userId);
    if (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å) {
      –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.–≥–æ–≤–æ—Ä–∏—Ç = –≥–æ–≤–æ—Ä–∏—Ç;
    }

    this.–æ—Ç–ø—Ä–∞–≤–∏—Ç—å–í–ö–æ–º–Ω–∞—Ç—É(–∫–æ–º–Ω–∞—Ç–∞Id, {
      —Ç–∏–ø: '–≥–æ–≤–æ—Ä–∏—Ç',
      –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id: ws.userId,
      –∫–æ–º–Ω–∞—Ç–∞_id: –∫–æ–º–Ω–∞—Ç–∞Id,
      –≥–æ–≤–æ—Ä–∏—Ç
    });
  }

  private –æ–±–Ω–æ–≤–∏—Ç—å–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤–ö–æ–º–Ω–∞—Ç—ã(–∫–æ–º–Ω–∞—Ç–∞Id: string) {
    const –∫–æ–º–Ω–∞—Ç–∞ = this.–∫–æ–º–Ω–∞—Ç—ã.get(–∫–æ–º–Ω–∞—Ç–∞Id);
    if (!–∫–æ–º–Ω–∞—Ç–∞) return;

    const —É—á–∞—Å—Ç–Ω–∏–∫–∏ = –∫–æ–º–Ω–∞—Ç–∞.—É—á–∞—Å—Ç–Ω–∏–∫–∏
      .map(id => this.–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏.get(id))
      .filter(–ø => –ø) as –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å[];

    console.log(`üë• –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∫–æ–º–Ω–∞—Ç—ã ${–∫–æ–º–Ω–∞—Ç–∞.–Ω–∞–∑–≤–∞–Ω–∏–µ}: [${—É—á–∞—Å—Ç–Ω–∏–∫–∏.map(—É => —É.–∏–º—è).join(', ')}]`);

    this.–æ—Ç–ø—Ä–∞–≤–∏—Ç—å–í–ö–æ–º–Ω–∞—Ç—É(–∫–æ–º–Ω–∞—Ç–∞Id, {
      —Ç–∏–ø: '—É—á–∞—Å—Ç–Ω–∏–∫–∏-–∫–æ–º–Ω–∞—Ç—ã-–æ–±–Ω–æ–≤–ª–µ–Ω—ã',
      –∫–æ–º–Ω–∞—Ç–∞_id: –∫–æ–º–Ω–∞—Ç–∞Id,
      —É—á–∞—Å—Ç–Ω–∏–∫–∏
    });
  }

  private –æ—Ç–ø—Ä–∞–≤–∏—Ç—å–°–ø–∏—Å–æ–∫–ö–æ–º–Ω–∞—Ç(ws: WSConnection) {
    const –∫–æ–º–Ω–∞—Ç—ã = Array.from(this.–∫–æ–º–Ω–∞—Ç—ã.values());
    this.–æ—Ç–ø—Ä–∞–≤–∏—Ç—å–°–æ–æ–±—â–µ–Ω–∏–µ(ws, {
      —Ç–∏–ø: '–∫–æ–º–Ω–∞—Ç—ã-–æ–±–Ω–æ–≤–ª–µ–Ω—ã',
      –∫–æ–º–Ω–∞—Ç—ã
    });
  }

  private –æ—Ç–ø—Ä–∞–≤–∏—Ç—å–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤–ö–æ–º–Ω–∞—Ç—ã(ws: WSConnection, –∫–æ–º–Ω–∞—Ç–∞Id: string) {
    const –∫–æ–º–Ω–∞—Ç–∞ = this.–∫–æ–º–Ω–∞—Ç—ã.get(–∫–æ–º–Ω–∞—Ç–∞Id);
    if (!–∫–æ–º–Ω–∞—Ç–∞) return;

    const —É—á–∞—Å—Ç–Ω–∏–∫–∏ = –∫–æ–º–Ω–∞—Ç–∞.—É—á–∞—Å—Ç–Ω–∏–∫–∏
      .map(id => this.–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏.get(id))
      .filter(–ø => –ø) as –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å[];

    this.–æ—Ç–ø—Ä–∞–≤–∏—Ç—å–°–æ–æ–±—â–µ–Ω–∏–µ(ws, {
      —Ç–∏–ø: '—É—á–∞—Å—Ç–Ω–∏–∫–∏-–∫–æ–º–Ω–∞—Ç—ã-–æ–±–Ω–æ–≤–ª–µ–Ω—ã',
      –∫–æ–º–Ω–∞—Ç–∞_id: –∫–æ–º–Ω–∞—Ç–∞Id,
      —É—á–∞—Å—Ç–Ω–∏–∫–∏
    });
  }

  private –æ—Ç–ø—Ä–∞–≤–∏—Ç—å–°–æ–æ–±—â–µ–Ω–∏–µ(ws: WSConnection, —Å–æ–æ–±—â–µ–Ω–∏–µ: –°–æ–æ–±—â–µ–Ω–∏–µ–°–µ—Ä–≤–µ—Ä–∞) {
    if (ws.readyState === ws.OPEN) {
      ws.send(JSON.stringify(—Å–æ–æ–±—â–µ–Ω–∏–µ));
    }
  }

  private –æ—Ç–ø—Ä–∞–≤–∏—Ç—å–í–ö–æ–º–Ω–∞—Ç—É(–∫–æ–º–Ω–∞—Ç–∞Id: string, —Å–æ–æ–±—â–µ–Ω–∏–µ: –°–æ–æ–±—â–µ–Ω–∏–µ–°–µ—Ä–≤–µ—Ä–∞, –∏—Å–∫–ª—é—á–∏—Ç—å?: string) {
    const –∫–æ–º–Ω–∞—Ç–∞ = this.–∫–æ–º–Ω–∞—Ç—ã.get(–∫–æ–º–Ω–∞—Ç–∞Id);
    if (!–∫–æ–º–Ω–∞—Ç–∞) return;

    –∫–æ–º–Ω–∞—Ç–∞.—É—á–∞—Å—Ç–Ω–∏–∫–∏.forEach(userId => {
      if (userId !== –∏—Å–∫–ª—é—á–∏—Ç—å) {
        const —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ = this.—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.get(userId);
        if (—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ) {
          this.–æ—Ç–ø—Ä–∞–≤–∏—Ç—å–°–æ–æ–±—â–µ–Ω–∏–µ(—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ, —Å–æ–æ–±—â–µ–Ω–∏–µ);
        }
      }
    });
  }

  private —à–∏—Ä–æ–∫–æ–≤–µ—â–∞—Ç–µ–ª—å–Ω–æ–µ–°–æ–æ–±—â–µ–Ω–∏–µ(—Å–æ–æ–±—â–µ–Ω–∏–µ: –°–æ–æ–±—â–µ–Ω–∏–µ–°–µ—Ä–≤–µ—Ä–∞) {
    this.wss.clients.forEach((client: WSConnection) => {
      if (client.readyState === client.OPEN) {
        this.–æ—Ç–ø—Ä–∞–≤–∏—Ç—å–°–æ–æ–±—â–µ–Ω–∏–µ(client, —Å–æ–æ–±—â–µ–Ω–∏–µ);
      }
    });
  }

  private –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å–û—Ç–∫–ª—é—á–µ–Ω–∏–µ(ws: WSConnection) {
    if (!ws.userId) return;

    console.log(`üëã –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${ws.userId} –æ—Ç–∫–ª—é—á–∏–ª—Å—è`);

    const –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å = this.–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏.get(ws.userId);
    if (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å && –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.–≤_–∫–æ–º–Ω–∞—Ç–µ) {
      this.–ø–æ–∫–∏–Ω—É—Ç—å–ö–æ–º–Ω–∞—Ç—É(ws, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.–≤_–∫–æ–º–Ω–∞—Ç–µ);
    }

    this.–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏.delete(ws.userId);
    this.—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.delete(ws.userId);
  }

  // –ü—É–±–ª–∏—á–Ω—ã–µ –º–µ—Ç–æ–¥—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
  public –ø–æ–ª—É—á–∏—Ç—å–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π(): Map<string, –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å> {
    return this.–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏;
  }

  public –ø–æ–ª—É—á–∏—Ç—å–ö–æ–º–Ω–∞—Ç—ã(): Map<string, –ö–æ–º–Ω–∞—Ç–∞> {
    return this.–∫–æ–º–Ω–∞—Ç—ã;
  }

  public –∑–∞–∫—Ä—ã—Ç—å() {
    this.wss.close();
  }
}